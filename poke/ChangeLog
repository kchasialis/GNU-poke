2020-07-03  Kostas Chasialis  <sdi1600195@di.uoa.gr>

	*libpoke/libpoke.h (pk_make_struct_type): Prototype.
	(pk_struct_type): Likewise.
	(pk_allocate_struct_attrs): Likewise.
	(pk_struct_type_name): Likewise.
	(pk_struct_type_nfields): Likewise.
	(pk_struct_type_fname): Likewise.
	(pk_struct_type_set_fname): Likewise.
	(pk_struct_type_ftype): Likewise.
	(pk_struct_type_set_ftype): Likewise.
	*libpoke/pk-val.c (pk_make_struct_type): Define.
	(pk_struct_type): Likewise.
	(pk_allocate_struct_attrs): Likewise.
	(pk_struct_type_name): Likewise.
	(pk_struct_type_nfields): Likewise.
	(pk_struct_type_fname): Likewise.
	(pk_struct_type_set_fname): Likewise.
	(pk_struct_type_ftype): Likewise.
	(pk_struct_type_set_ftype): Likewise.

2020-07-02  Kostas Chasialis  <sdi1600195@di.uoa.gr>

	* libpoke/libpoke.h (pk_make_struct): Prototype.
	(pk_struct_nfields): Likewise.
	(pk_struct_field_boffset): Likewise.
	(pk_struct_set_field_boffset): Likewise.
	(pk_struct_field_name): Likewise.
	(pk_struct_set_field_name): Likewise.
	(pk_struct_field_value): Likewise.
	(pk_struct_set_field_value): Likewise.
	* libpoke/pk-val.c (pk_make_struct): Define.
	(pk_struct_nfields): Likewise.
	(pk_struct_field_boffset): Likewise.
	(pk_struct_set_field_boffset): Likewise.
	(pk_struct_field_name): Likewise.
	(pk_struct_set_field_name): Likewise.
	(pk_struct_field_value): Likewise.
	(pk_struct_set_field_value): Likewise.

2020-07-02  Kostas Chasialis  <sdi1600195@di.uoa.gr>

	* libpoke/libpoke.h (pk_array_elem_val): Prototype documentation
	now describes what happens in case invalid IDX is passed.
	(pk_array_set_elem_val): Likewise.
	(pk_array_elem_boffset): Likewise.
	(pk_array_set_elem_boffset): Likewise.
	* libpoke/pk-val.c (pk_array_elem_val): Check for IDX.
	(pk_array_set_elem_val): Likewise.
	(pk_array_elem_boffset): Likewise.
	(pk_array_set_elem_boffset): Likewise.

2020-07-02  Kostas Chasialis  <sdi1600195@di.uoa.gr>

	* etc/pk-mi-json-schema.json : JSON Schema

2020-06-30  Jose E. Marchesi  <jemarch@gnu.org>

	* libpoke/pkl-tab.y (expression): Finish break statements in the
	try-until body.
	* libpoke/pkl-gen.c (pkl_gen_pr_try_until_stmt): Use
	pkl_asm_loop/pkl_asm_endloop to support `break' statements in the
	body.
	* doc/poke.texi (try-until): Mention that `break' is allowed in
	try-until loops.
	* testsuite/poke.pkl/try-until-4.pk: New test.
	* testsuite/poke.pkl/try-until-6.pk: Likewise.
	* testsuite/poke.pkl/try-until-5.pk: Likewise.

2020-06-30  Jose E. Marchesi  <jemarch@gnu.org>

	* libpoke/pkl-gen.c (pkl_gen_pr_loop_stmt): Use pkl_asm_while_loop
	and pkl_asm_while_endloop.
	* libpoke/ras: Likewise.
	* libpoke/pkl-asm.h (pkl_asm_while_loop): Renamed from
	pkl_asm_loop.
	(pkl_asm_while_endloop): Renamed from pkl_asm_endloop.
	(pkl_asm_loop): New prototype.
	(pkl_asm_endloop): Likewise.
	* libpoke/pkl-asm.c (pkl_asm_while_loop): Likewise.
	(pkl_asm_while_endloop): Likewise.
	(pkl_asm_loop): New function.
	(pkl_asm_endloop): Likewise.

	* testsuite/poke.pkl/while-2.pk: New test.

2020-06-28  Luca Saiu  <positron@gnu.org>

	do not rely on the unreliable "optimize" GCC function attribute
	* libpoke/pvm-env.c (pvm_env_back): New static function.
	(pvm_env_lookup, pvm_env_set_var): Rewrite avoiding recursion,
	and factor the common logic using the new static function.
	Remove __attribute__((optimize ("optimize-sibling-calls"))).
	Remove comment, now obsolete.

2020-06-24  Jose E. Marchesi  <jemarch@gnu.org>

	* configure.ac (PACKAGE_BUGZILLA): ac_define.
	* poke/poke.c (print_help): Use PACKAGE_BUGZILLA.
	* HACKING (The Bugzilla): Add a note about the bugzilla URL being
	defined in configure.ac.

2020-06-19  Jose E. Marchesi  <jemarch@gnu.org>

	* testsuite/Makefile.am: Pass SHELL as a variable to runtest.
	* testsuite/lib/poke-dg.exp (poke-dg-test): Use SHELL to build the
	shebang of the test program.

2020-06-10  Aurélien Aptel  <aaptel@suse.com>

	* HACKING (Maintainers): New section.
	(Write After Approval): Add Aurélien Aptel.
	* AUTHORS: Likewise.

2020-06-08  Aurélien Aptel  <aaptel@suse.com>

	* etc/poke-mode.el: New file.
	* HACKING (Writing Poke): Mention poke-mode.

2020-06-06  Bruno Haible  <bruno@clisp.org>

	doc: Give users the freedom to use their own style in the HTML doc.
	* doc/Makefile.am (AM_MAKEINFOHTMLFLAGS): Remove variable.
	* HACKING (Building): Explain how to set a custom style in the HTML
	documentation.

2020-05-30  John Darrington <john@darrington.wattle.id.au>

	* doc/poke.texi: Miscellaneous minor corrections.

2020-05-30  John Darrington <john@darrington.wattle.id.au>

	* poke/poke.h (pk_fatal): Add noreturn attribute.

2020-05-27  Jose E. Marchesi  <jemarch@gnu.org>

	* libpoke/pk-val.c (pk_make_offset): Return PK_NULL if the
	arguments are not of the right type.

2020-05-25  Jose E. Marchesi  <jemarch@gnu.org>

	* HACKING (Compiler Passes and Phases): Update.
	(Transformation Phases): Likewise.
	(Analysis Phases): Likewise.

2020-05-24  Jose E. Marchesi  <jemarch@gnu.org>

	* pickles/ctf.pk (CTF_Type): Fix application of bit-concatenation
	in pretty_printer.
	(ctf_string): Use an Elf64_File instead of a header.
	(ctf_get_header): Likewise.

2020-05-17  Tim Rühsen  <tim.ruehsen@gmx.de>

	* gnulib: Update to master

2020-05-23  John Darrington <john@darrington.wattle.id.au>

	* poke/poke.c (pk_fatal): Call abort instead of exit.
	* libpoke/pkl.c (pklresolve_module): On lookup failure,
	return NULL instead of asserting.

2020-05-22  Jose E. Marchesi  <jemarch@gnu.org>

	* libpoke/pkl-asm.pks (offset_cast): Operate with integers of
	to_base_unit units, to avoid overflows and division by zero.

2020-05-22  Jose E. Marchesi  <jemarch@gnu.org>

	* testsuite/poke.pkl/eq-integers-5.pk: New test.
	* testsuite/poke.pkl/eq-offsets-8.pk: Likewise.

2020-05-22  Jose E. Marchesi  <jemarch@gnu.org>

	* libpoke/pkl.h (pkl_execute_file): Add argument exit_status.
	* libpoke/libpoke.h (pk_compile_file): Likewise.
	* libpoke/pkl.c (pkl_execute_file): Likewise.
	* libpoke/libpoke.c (pk_compile_file): Likewise.
	* libpoke/pkl-rt.pk (_pkl_exception_handler): Return the exit
	status.
	(Exception): Add field exit_status.
	(exit): The status code is 0 by default.
	* libpoke/pkl-asm.c (pkl_asm_finish): Adapted to the fact the
	default signal handler returns the exit status.
	* poke/poke.c (parse_args_2): Use the program's exit status as the
	exit status of poke when running -L.
	* libpoke/pvm-val.h (pvm_make_exception): Get an exit_exception
	argument.
	* libpoke/pvm-val.c (pvm_make_exception): Handle the exit status
	field of exceptions.
	* libpoke/pvm.h (PVM_E_EXIT): Define.
	(PVM_E_EXIT_MSG): Likewise.
	(PVM_E_EXIT_ESTATUS): Likewise.
	* libpoke/pvm.jitter (PVM_RAISE_DFL): Define and use through the
	file.
	* libpoke/ras: Pass the exit status argument to
	pvm_make_exception.
	* libpoke/pkl-gen.c: Likewise.
	* libpoke/pkl-asm.c: Likewise.

2020-05-22  Jose E. Marchesi  <jemarch@gnu.org>

	* libpoke/pkl-rt.pk (EC_exit): Define.
	(E_exit): Likewise.
	(exit): LIkewise.
	(_pkl_exception_handler): Do not print an exception message for
	EC_exit.
	* libpoke/pvm.h (PVM_E_EXIT): Define.
	(PVM_E_EXIT_MSG): Likewise.

2020-05-22  Jose E. Marchesi  <jemarch@gnu.org>

	* pickles/elf.pk (ELFDATANONE): Define.
	(ELFDATA2LSB): Likewise.
	(ELFDATA2MSB): Likewise.
	(Elf64_Ehdr): Set endianness based on ei_data.

2020-05-21  Jose E. Marchesi  <jemarch@gnu.org>

	* doc/poke.texi (Shebang): Document the handling of command-line
	options in Poke scripts.
	(Invoking poke): Document how command-line arguments are processed
	after -L SCRIPT.

2020-05-21  Jose E. Marchesi  <jemarch@gnu.org>

	* libpoke/libpoke.h (pk_array_set_elem_val): Prototype.
	(pk_array_set_elem_boffset): Likewise.
	* libpoke/pk-val.c (pk_array_set_elem_val): Define.
	 (pk_array_set_elem_boffset): Likewise.
	* poke/poke.c (parse_args_2): Change -L SCRIPT so any further
	command line option becomes the script's option.
	(set_script_args): Define.
	* libpoke/pkl.c (pvm_type_to_ast_type): Define.
	* libpoke/pkl-anal.c (pkl_anal_ps_default): Disable the location
	checker.

2020-05-20  Jose E. Marchesi  <jemarch@gnu.org>

	* libpoke/pkl-tab.y: Include gettext.h and define _.
	Internationalize token descriptions.

2020-05-20  Jose E. Marchesi  <jemarch@gnu.org>

	* testsuite/poke.cmd/maps-alien-1.pk: New test.

2020-05-20  Jose E. Marchesi  <jemarch@gnu.org>

	* libpoke/pkl-tab.y (yyreport_syntax_error): Handle out-of-memory
	condition.

2020-05-20  Jose E. Marchesi  <jemarch@gnu.org>

	* libpoke/pkl-tab.y (parse.error): Use customized syntax errors.
	(yyreport_syntax_error): Define.
	(ALIEN): New token.
	* libpoke/pkl-parser.h (struct pkl_parser): New field
	`alien_errmsg'.
	* libpoke/pkl-lex.l: Set the alien error message and return ALIEN
	for alien tokens not accepted by the client.
	* libpoke/libpoke.h: Get an ERRMSG argument in
	pk_alien_token_handler_fn.
	* libpoke/pkl.h: Likewise.
	* poke/pk-map.c (pk_map_alien_token_handler): Adapt accordingly.

2020-05-20  Jose E. Marchesi  <jemarch@gnu.org>

	* HACKING (Bison): Document requirement.
	* bootstrap.conf (buildreq): Require bison >= 3.6.0.
	* libpoke/pkl-tab.y: Port to bison 3.6.
	* libpoke/pkl-lex.l: Likewise.
	* poke/pk-map-tab.y: Likewise.
	* poke/pk-map-lex.l: Likewise.

2020-05-19  Jose E. Marchesi  <jemarch@gnu.org>

	* poke/Makefile.am (poke_LDADD): Do not add the jitter library to
	the application.

2020-05-19  Luca Saiu  <positron@gnu.org>

	* libpoke/Makefile.am (libpvmjitter_la_LIBADD): Use the new
	JITTER_LIBADD rather than JITTER_LDADD.
	* poke/Makefile.am (poke_LDADD): Likewise.  Remove now-obsolete
	XXX comment.

2020-05-18  Jose E. Marchesi  <jemarch@gnu.org>

	* poke/pk-map.c (entry_name_to_varname): Use cur_map_id instead of
	a map.
	(pk_map_load_parsed_map): Do not create the map until all the
	variables are defined without error.

2020-05-18  Jose E. Marchesi  <jemarch@gnu.org>

	* poke/poke.pk (auto_map): Escape . in regexps.

2020-05-18  Jose E. Marchesi  <jemarch@gnu.org>

	* poke/pk-cmd-map.c (pk_cmd_map_show): Include the map name while
	listing entries.
	* testsuite/poke.cmd/maps-4.pk: Adapt accordingly.
	* testsuite/poke.cmd/maps-5.pk: Likewise.
	* testsuite/poke.cmd/maps-6.pk: Likewise.

2020-05-18  Jose E. Marchesi  <jemarch@gnu.org>

	* maps/elf.map: Rename entry from elf to file.

2020-05-17  Tim Rühsen  <tim.ruehsen@gmx.de>

	* libpoke/pkl-env.c (hash_string): Suppress ASAN runtime error
	"implicit-signed-integer-truncation-or-sign-change".

2020-05-18  Jose E. Marchesi  <jemarch@gnu.org>

	* libpoke/pkl-lex.l: Support :: separators in alien token
	identifiers.
	* poke/pk-map.c (pk_map_alien_token_handler): Use :: to separate
	mapname from entryname in alien tokens.
	(pk_map_normalize_name): Do not reduce sequences of _'s.

2020-05-18  Jose E. Marchesi  <jemarch@gnu.org>

	* libpoke/pkl-lex.l: Change bit-concatenation operator from :: to
	:::.
	* doc/poke.texi (From Bytes to Integers): Update accordingly.
	(Bitwise Operators): Likewise.
	* testsuite/poke.pkl/bconc-7.pk: Likewise.
	* testsuite/poke.pkl/bconc-6.pk: Likewise.
	* testsuite/poke.pkl/bconc-5.pk: Likewise.
	* testsuite/poke.pkl/bconc-4.pk: Likewise.
	* testsuite/poke.pkl/bconc-3.pk: Likewise.
	* testsuite/poke.pkl/bconc-2.pk: Likewise.
	* testsuite/poke.pkl/bconc-1.pk: Likewise.

2020-05-18  Jose E. Marchesi  <jemarch@gnu.org>

	* poke/pk-map.c (pk_map_normalize_name): New function.
	(pk_map_load_file): Use pk_map_normalize_name.
	* poke/pk-cmd-map.c (pk_cmd_map_create): Likewise.

2020-05-18  Jose E. Marchesi  <jemarch@gnu.org>

	* poke/poke.c: Make poke_prompt_maps_p to default to yes.
	* poke/pk-ios.c (pk_open_ios): Do not emit an "auto-map: loaded"
	message if prompt-maps is enabled.

2020-05-18  Jose E. Marchesi  <jemarch@gnu.org>

	* poke/pk-map.c (pk_map_add_entry): Get both name and varname as
	arguments.
	(pk_map_load_parsed_map): Adjust call accordingly.
	* poke/pk-cmd-map.c (pk_cmd_map_entry_add): LIkewise.
	(pk_cmd_map_show): Do now show a Variable column.
	* testsuite/poke.cmd/maps-4.pk: Adapt accordingly.
	* testsuite/poke.cmd/maps-5.pk: Likewise.
	* testsuite/poke.cmd/maps-6.pk: Likewise.

2020-05-17  Jose E. Marchesi  <jemarch@gnu.org>

	* libpoke/pkl.c (pkl_lexical_cuckolding_p): Define.
	(pkl_set_lexical_cuckolding_p): Likewise.
	(pkl_set_alien_token_fn): Likewise.
	(pkl_alien_token_fn): Likewise.
	(struct pkl_compiler): New fields `lexical_cuckolding_p' and
	`alien_token_fn'.
	* libpoke/libpoke.c (pk_set_lexical_cuckolding_p): Define.
	(pk_set_alien_token_fn): Likewise.
	* poke/pk-cmd.c (pk_cmd_exec): Activate the lexical cuckolding
	when executing Poke code in the REPL.
	* poke/pk-map.c (pk_map_alien_token_handler): Define.
	(pk_map_init): Install pk_map_alien_token_handler in
	poke_compiler.

2020-05-17  Jose E. Marchesi  <jemarch@gnu.org>

	* maps/mp3.map: Fix tag.

2020-05-17  Jose E. Marchesi  <jemarch@gnu.org>

	* poke/pk-map.h (struct pk_map): New field `id'.
	(struct pk_map_entry): New field `name'.
	(PK_MAP_ENTRY_NAME): Define.
	* poke/pk-map.c (next_map_id): New variable.
	(pk_map_create): Allocate a new map ID and initialize the new map
	with it.
	(search_map_entry): Search entries by name, not varnames.
	(pk_map_add_entry): Initialize the map entry name.
	(entry_name_to_varname): New function.
	(pk_map_remove_entry): Delete by entry name, not variable name.
	* testsuite/poke.cmd/maps-4.pk: Adapt.
	* testsuite/poke.cmd/maps-5.pk: Likewise.
	* testsuite/poke.cmd/maps-6.pk: Likewise.

2020-05-17  Jose E. Marchesi  <jemarch@gnu.org>

	* poke/pk-map.c (pk_map_load_file): Make sure a map is not already
	loaded with the same name.

2020-05-17  Jose E. Marchesi  <jemarch@gnu.org>

	* poke/pk-map.c (pk_map_load_file): Derive the name of the new map
	from the filename.
	* poke/pk-cmd-map.c (pk_cmd_map_load): Remove spurious comment.

2020-05-17  Jose E. Marchesi  <jemarch@gnu.org>

	* poke/poke.c (poke_prompt_maps): Define.
	* poke/pk-repl.c (pk_prompt): New function.
	* poke/pk-cmd-set.c (set_prompt_maps): Define.
	(set_cmds): Add set_prompt_maps.
	(pk_cmd_set_prompt_maps): New function.
	* poke/pk-cmd-map.c (pk_cmd_map_create): Do not assume a current
	IOS exists.

2020-05-17  Jose E. Marchesi  <jemarch@gnu.org>

	* poke/pk-ios.h: New file.
	* poke/pk-ios.c: Likewise.
	* poke/Makefile.am (poke_SOURCES): Add pk-ios.h and pk-ios.c.
	* poke/pk-cmd-ios.c (pk_cmd_file): Use pk_open_ios.
	* poke/poke.c (NO_AUTO_MAP_ARG): Define.
	(long_options): Add no-auto-map info.
	(parse_args_1): Handle NO_AUTO_MAP_ARG.
	(parse_args_2): Likewise.
	(print_help): Document --no-auto-map.
	(parse_args_2): Use pk_open_ios to open files specified in the
	command line.

2020-05-17  Jose E. Marchesi  <jemarch@gnu.org>

	* poke/poke.c (poke_auto_map_p): Define.
	* poke/poke.h: Likewise.
	* poke/pk-cmd-set.c (set_auto_map): Define.
	(set_cmds): Add set_auto_map.
	(pk_cmd_set_auto_map): New function.
	* poke/pk-cmd-ios.c (pk_cmd_file): Acknowledge poke_auto_map_p.

2020-05-17  Jose E. Marchesi  <jemarch@gnu.org>

	* libpoke/libpoke.h (pk_array_nelem): Prototype.
	* libpoke/pk-val.c (pk_array_nelem): New function.
	* poke/poke.pk (auto_map): Define.
	* poke/pk-cmd-ios.c (pk_cmd_file): Process auto maps.
	* poke/pk-map.c (pk_map_create): Fix chaining of map-ios.

2020-05-17  Bruno Haible  <bruno@clisp.org>

	build: Bump minimum needed Automake version.
	* bootstrap.conf (buildreq): Require automake >= 1.16.

2020-05-16  Tim Rühsen  <tim.ruehsen@gmx.de>

	* libpoke/pvm.c: Remove include xalloc.h.
	(pvm_init): Use calloc instead of xzalloc.

2020-05-16  Tim Rühsen  <tim.ruehsen@gmx.de>

	* libpoke/pkl-parser.c: Remove include xalloc.h.
	(pkl_parser_init): Use calloc instead of xzalloc.
	(pkl_parse_file): Use strdup instead of xstrdup.
	Allocate and check memory early in the function.
	(pkl_parse_buffer): Use strdup instead of xstrdup.
	Allocate and check memory early in the function.

2020-05-17  Jose E. Marchesi  <jemarch@gnu.org>

	* maps/Makefile.am (dist_maps_DATA): Distribute mp3.map.

2020-05-17  Jose E. Marchesi  <jemarch@gnu.org>

	* poke/pk-map.c (pk_map_load_parsed_map): Use pk_type_code and
	pk_typeof.
	(pk_map_resolve_map): Likewise.
	(pk_map_load_parsed_map): Likewise.
	* libpoke/libpoke.h (pk_make_array): Prototype.
	(pk_make_integral_type): Likewise.
	(pk_integral_type_size): Likewise.
	(pk_integral_type_signed_p): Likewise.
	(pk_make_string_type): Likewise.
	(pk_make_offset_type): Likewise.
	(pk_offset_type_base_type): Likewise.
	(pk_offset_type_unit): Likewise.
	(pk_make_any_type): Likewise.
	(pk_make_array_type): Likewise.
	(pk_array_type_etype): Likewise.
	(pk_array_type_bound): Likewise.
	(pk_val_typeof): Likewise.
	(pk_type_code): Rename from pk_val_type.
	(pk_array_elem_val): Prototype.
	(pk_array_elem_boffset): Likewise.
	* libpoke/pk-val.c (pk_make_integral_type): New function.
	(pk_integral_type_size): Likewise.
	(pk_integral_type_signed_p): Likewise.
	(pk_make_array): Likewise.
	(pk_make_string_type): Likewise.
	(pk_make_offset_type): Likewise.
	(pk_offset_type_base_type): Likewise.
	(pk_offset_type_unit): Likewise.
	(pk_make_any_type): Likewise.
	(pk_make_array_type): Likewise.
	(pk_array_type_etype): Likewise.
	(pk_array_type_bound): Likewise.
	(pk_val_typeof): Likewise.
	(pk_type_code): Rename from pk_val_type.
	(pk_array_elem_val): New function.
	(pk_array_elem_boffset): Likewise.

2020-05-17  Jose E. Marchesi  <jemarch@gnu.org>

	* libpoke/pkl.h (pkl_compile_call): Prototype.
	* libpoke/pkl.c (pkl_compile_call): Define.
	* libpoke/libpoke.h (PK_CLOSURE): Define.
	(pk_call): Prototype.
	* libpoke/libpoke.c (pk_call): Define.
	* libpoke/pk-val.c (pk_val_type): Handle CLS values.

2020-05-16  Jose E. Marchesi  <jemarch@gnu.org>

	* poke/pk-cmd.c (pk_cmd_init): Use pk_fatal.
	* poke/poke.c (initialize): Likewise.
	* poke/pk-term.c (pk_term_init): Likewise.
	* poke/pk-mi.c (pk_mi_read_from_client): Likewise.
	* poke/pk-hserver.c (make_socket): Likewise.
	(hserver_thread_worker): Likewise.
	(pk_hserver_init): Likewise.
	(pk_hserver_shutdown): Likewise.
	(pk_hserver_make_hyperlink): Likewise.
	* poke/pk-mi.c (pk_mi_loop): Likewise.
	(pk_mi_send): Likewise.

2020-05-16  Jose E. Marchesi  <jemarch@gnu.org>

	* poke/poke.c (pk_fatal): Add missing newline after message error.

2020-05-16  Jose E. Marchesi  <jemarch@gnu.org>

	* poke/poke.h (pk_fatal): Prototype.
	* poke/poke.c (pk_fatal): New function.
	* poke/pk-map.h (pk_map_resolve_map): Prototype.
	* poke/pk-map.c (pk_map_resolve_map): New function.
	* poke/pk-cmd-map.c (pk_cmd_map_load): use pk_map_resolve_map.

2020-05-16  Jose E. Marchesi  <jemarch@gnu.org>

	* run.in (POKEMAPSDIR): Define.
	* poke/poke.h (poke_mapsdir): Define.
	* poke/poke.c (poke_mapsdir): New global.
	(initialize): Initialize the value of poke_mapsdir.
	(initialize): Load poke.pk.
	* poke/poke.pk: New file.
	* poke/Makefile.am (dist_pkgdata_DATA): Add poke.pk.
	* HACKING: Update to mention poke.pk.

2020-05-16  Jose E. Marchesi  <jemarch@gnu.org>

	* libpoke/pkl.h (pkl_defvar): Prototype.
	* libpoke/pkl.c (pkl_defvar): Define.
	* libpoke/libpoke.h (pk_defvar): Prototype.
	* libpoke/libpoke.c (pk_defvar): Define.

2020-05-16  Jose E. Marchesi  <jemarch@gnu.org>

	* pickles/elf.pk (Elf64_SectionFlags): Improve pretty-printer.

2020-05-16  Jose E. Marchesi  <jemarch@gnu.org>

	* libpoke/std.pk (ltrim): Support character sets.
	(rtrim): Likewise.
	* doc/poke.texi (ltrim): Update.
	(rtrim): Likewise.
	* testsuite/poke.std/ltrim-1.pk: Renamed from ltrim.pk.
	* testsuite/poke.std/rtrim-1.pk: Renamed from rtrim.pk.
	* testsuite/poke.std/ltrim-2.pk: New test.
	* testsuite/poke.std/rtrim-2.pk: Likewise.
	* testsuite/poke.std/ltrim-3.pk: Likewise.
	* testsuite/poke.std/rtrim-3.pk: Likewise.

2020-05-16  Jose E. Marchesi  <jemarch@gnu.org>

	* libpoke/std.pk (strchr): New function.
	* doc/poke.texi (strchr): New section.
	* testsuite/poke.std/strchr-3.pk: Likewise.
	* testsuite/poke.std/strchr-2.pk: Likewise.
	* testsuite/poke.std/strchr-1.pk: New test.

2020-05-16  Jose E. Marchesi  <jemarch@gnu.org>

	* libpoke/pkl-parser.h (struct pkl_parser): New field
	in_method_decl_p.
	* libpoke/pkl-parser.c (pkl_parser_init): Initialize
	in_method_decl_p.
	* libpoke/pkl-tab.y (pushlevel_args): New rule.
	(function_specifier): Use pushlevel_args.
	(declaration): Set in_method_decl_p.
	* libpoke/pkl-gen.c (pkl_gen_ps_var): The implicit struct argument
	is the first formatl argument registered in the function, not the
	last.
	(pkl_gen_pr_ass_stmt): Likewise.
	(pkl_gen_pr_func): Adapt to the fact the implicit argument is the
	last actual passed but the firts formal registered.
	* testsuite/poke.pkl/struct-method-15.pk: New test.
	* testsuite/poke.pkl/struct-method-diag-15.pk: Likewise.

2020-05-16  Jose E. Marchesi  <jemarch@gnu.org>

	* testsuite/poke.pkl/struct-method-12.pk: New test.
	* testsuite/poke.pkl/struct-method-13.pk: Likewise.
	* testsuite/poke.pkl/struct-method-14.pk: Likewise.

2020-05-16  Jose E. Marchesi  <jemarch@gnu.org>

	* pickles/elf.pk (Elf64_Rel): New type.
	(SHT_REL): Define.
	(SHF_WRITE): Likewise.
	(SHF_ALLOC): Likewise.
	(SHF_EXECINSTR): Likewise.
	(SHF_MERGE): Likewise.
	(SHF_STRINGS): Likewise.
	(SHF_INFO_LINK): Likewise.
	(SHF_LINK_ORDER): Likewise.
	(SHF_OS_NONCONFORMING): Likewise.
	(SHF_GROUP): Likewise.
	(SHF_TLS): Likewise.
	(SHF_COMPRESSED): Likewise.
	(SHF_MASKOS): Likewise.
	(SHF_MASKPROC): Likewise.
	(Elf64_SectionFlags): New type.

2020-05-15  Tim Rühsen  <tim.ruehsen@gmx.de>

	* libpoke/pkl.c: Remove include xalloc.h.
	(pkl_new): Use calloc instead of xzalloc.
	(pkl_new): Free memory when returning NULL.

2020-05-15  Tim Rühsen  <tim.ruehsen@gmx.de>

	* libpoke/pkl-lex.l: Remove include xalloc.h.

2020-05-15  Jose E. Marchesi  <jemarch@gnu.org>

	* pickles/elf.pk (Elf64_File): Rename from Elf64.
	* maps/elf.map: Updated accordingly.

2020-05-15  Jose E. Marchesi  <jemarch@gnu.org>

	* pickles/elf.pk (Elf64.get_string): New mehod.
	(Elf64.get_section_by_name): Likewise.
	(Elf64.get_section_by_type): Likewise.
	(elf_string): Delete function.
	(elf_get_section_by_name): Likewise.
	(elf_get_section_by_type): Likewise.

2020-05-15  Jose E. Marchesi  <jemarch@gnu.org>

	* libpoke/pkl-trans.c (pkl_trans1_ps_loop_stmt_iterator): New
	handler.
	(pkl_trans1_ps_loop_stmt): Likewise.
	(pkl_phase_trans1): Register handlers.
	* testsuite/poke.pkl/struct-method-10.pk: New test.
	* testsuite/poke.pkl/struct-method-11.pk: Likewise.

2020-05-15  Jose E. Marchesi  <jemarch@gnu.org>

	* poke/pk-map.h: Document in the docstring of the function
	pk_map_load_file that ERRMSG can be set to NULL even if an error
	code is returned.
	* poke/pk-cmd-map.c (pk_cmd_map_load): Adapt accordingly.

2020-05-15  Tim Rühsen  <tim.ruehsen@gmx.de>

	* cfg.mk: New syntax rule sc_rockdabootism_missing_space.
	* common/pk-utils.c (pk_print_binary): Add missing space before
	opening bracket.
	* common/pk-utils.h (pk_str_concat): Likewise.
	* libpoke/ios.c (ios_read_int_common): Likewise.
	(ios_read_int). Likewise.
	* libpoke/pvm-val.c (pvm_print_val_1): Likewise.
	* poke/pk-cmd-set.c (pk_cmd_set_odepth): Likewise.
	(pk_cmd_set_oindent): Likewise.
	(pk_cmd_set_omode): Likewise.
	* poke/pk-hserver.c (pk_hserver_make_hyperlink): Likewise.
	* poke/pk-mi.c (pk_mi_fd_set_nonblocking): Likewise.
	(pk_mi_fd_restore_blocking): Likewise.
	* poke/pk-repl.c (poke_sigint_handler): Likewise.
	(pk_repl): Likewise.
	* libpoke/pkl-lex.l: Likewise.
	* poke/pk-map-lex.l: Likewise.
	* poke/poke.c: Slightly amend comment.

2020-05-15  Jose E. Marchesi  <jemarch@gnu.org>

	* pickles/elf.pk (Elf64): New type.
	* maps/elf.map: Rewritten to use Elf64.

2020-05-15  Jose E. Marchesi  <jemarch@gnu.org>

	* poke/pk-map-tab.y (pk_map_parse_file): Fix call to
	pk_map_tab_set_extra.

2020-05-15  Jose E. Marchesi  <jemarch@gnu.org>

	* libpoke/pkl-rt.pk (iosize): Argument defaults to the current
	IOS.
	* poke/pk-cmd.c (pk_cmd_exec): Use new interface of
	pk_compile_statement.
	* .x-sc_space_tab: Add poke/pk-map-tab.y and poke/pk-map-lex.l.
	* poke/pk-term.h (pk_vprintf): Define.
	* poke/pk-term.c (pk_vprintf): Likewise.
	* poke/Makefile.am (AM_YFLAGS): Define.
	(AM_LFLAGS): Likewise.
	(EXTRA_DIST): Likewise.
	(BUILT_SOURCES): Likewise.
	* poke/pk-map-lex.l: Likewise.
	* poke/Makefile.am (poke_SOURCES): Add pk-map-parser.h and
	pk-map-tab.y.
	* maps/elf.map: Adapted to use %-directives.
	* maps/mp3.map: Likewise.
	* etc/poke-map-mode.el (poke-map-mode): Highlight %-directives
	entries.
	* poke/pk-map.c (pk_map_load_file): Define.
	* poke/pk-map-tab.y: New file.
	* poke/pk-map-parser.h: Likewise.

2020-05-14  Tim Rühsen  <tim.ruehsen@gmx.de>

	* libpoke/ios.c: Remove include xalloc.h.
	(ios_open): Use malloc with error checking.
	(realloc_string): New helper function.
	(ios_read_string): Use realloc_string instead xrealloc.
	* libpoke/ios.h: New define IOS_ENOMEM.
	* libpoke/pvm.jitter: Raise PVM_E_IO when out of memory.

2020-05-07  Tim Rühsen  <tim.ruehsen@gmx.de>

	* libpoke/ios-dev-mem.c (ios_dev_mem_open): Replace
	xzalloc by calloc.
	(ios_dev_mem_pwrite): Replace xrealloc with realloc.
	Remove include xalloc.h.

2020-05-07  Tim Rühsen  <tim.ruehsen@gmx.de>

	* libpoke/ios-dev-nbd.c (ios_dev_nbd_open): Replace
	xmalloc and xstrdup by malloc and strdup.
	Remove include xalloc.h.

2020-05-07  Tim Rühsen  <tim.ruehsen@gmx.de>

	* libpoke/ios-dev-file.c (ios_dev_file_open): Replace
	xmalloc and xstrdup by malloc and strdup.
	Remove include xalloc.h.

2020-05-12  Egeyar Bagcioglu  <egeyar@gmail.com>

	* libpoke/ios.c (ios_close): Update the current IOS
	only when closing the current IOS.

2020-05-12  Jose E. Marchesi  <jemarch@gnu.org>

	* libpoke/Makefile.am (libpvmjitter_la_CPPFLAGS): Do not
	-D_GNU_SOURCE.
	* libpoke/pvm.jitter: Include config.h in initial-header-c,
	initial-vm1-c and initial-vm2-c now that Jitter supports it.

2020-05-12  Jose E. Marchesi  <jemarch@gnu.org>

	* doc/poke.texi (Struct Constructors): Fix typo in example.

2020-05-12  Tim Rühsen  <tim.ruehsen@gmx.de>

	* cfg.mk: Add sc_jemarchism_file_fd syntax-check rule.

2020-05-12  Tim Rühsen  <tim.ruehsen@gmx.de>

	* libpoke/pkl-ast.c (pkl_ast_lvalue_p): Rename 'FILE *fd'
	to 'FILE *fp'.
	(pkl_ast_print_1): Likewise.
	(pkl_ast_print): Likewise.
	* libpoke/pkl-ast.h (pkl_ast_print): Likewise.
	* libpoke/pkl-diag.c (pkl_detailed_location): Likewise.
	* libpoke/pkl-parser.c (pkl_parse_file): Likewise.
	* libpoke/pkl-parser.h (pkl_parse_file): Likewise.
	* libpoke/pkl-tab.y (load_module): Likewise.
	* libpoke/pkl.c (pkl_compile_file): Likewise.
	* poke/pk-cmd-editor.c (pk_cmd_editor): Likewise.
	* poke/pk-cmd.c (pk_cmd_exec_script): Likewise.

2020-05-12  Tim Rühsen  <tim.ruehsen@gmx.de>

	* poke/pk-mi.c (pk_mi_fd_set_nonblocking): New function.
	(pk_mi_fd_restore_blocking): New function.
	(pk_mi_loop): Set fd to blocking and restore before returning.

2020-05-12  Jose E. Marchesi  <jemarch@gnu.org>

	* poke/pk-map.h (pk_map_remove): New prototype.
	* poke/pk-map.c (pk_map_remove): Define.
	(free_map): Likewise.
	* poke/pk-cmd-map.c (pk_cmd_map_remove): Define.
	(map_remove_cmd): Define.
	(map_cmds): Add map_remove_cmd.
	* testsuite/poke.cmd/maps-7.pk: New test.
	* testsuite/poke.cmd/maps-8.pk: Likewise.
	* testsuite/poke.cmd/maps-9.pk: Likewise.

2020-05-12  Jose E. Marchesi  <jemarch@gnu.org>

	* poke/pk-cmd-map.c (map_entry_add_cmd): Rename from map_add_cmd.
	(map_entry_remove_cmd): Rename from map_remove_cmd.
	(map_entry_cmds): Define.
	(map_entry_cmd): Likewise.
	* poke/pk-cmd.c (pk_cmd_init): Initialize map_entry_trie.
	(pk_cmd_shutdown): Free map_entry_trie.
	* testsuite/poke.cmd/maps-4.pk: Adapt.
	* testsuite/poke.cmd/maps-6.pk: Likewise.
	* testsuite/poke.cmd/maps-5.pk: Likewise.

2020-05-12  Tim Rühsen  <tim.ruehsen@gmx.de>

	* poke/pk-mi.c (pk_mi_read_from_client): Fix nbytes to ssize_t.
	(pk_mi_dispatch_msg): Fix empty else block.

2020-05-12  Tim Rühsen  <tim.ruehsen@gmx.de>

	* pickles/Makefile.am: Add id3v1.pk to dist_pickles_DATA.

2020-05-12  Jose E. Marchesi  <jemarch@gnu.org>

	* libpoke/libpoke.c (pk_print_val): New function.
	* libpoke/libpoke.c (pk_decl_val): Define.
	* (pk_decl_p): New function.
	* poke/pk-map.c: New file.
	* poke/pk-map.h: Likewise.
	* poke/pk-cmd-map.c: Likewise.
	* poke/poke.c (initialize): Call pk_map_init.
	(finalize): Call pk_map_shutdown.
	* poke/Makefile.am (poke_SOURCES): Add pk-map.c and pk-cmd-map.c
	* poke/pk-cmd-info.c (info_cmds): Add info_map_cmd.
	* maps/Makefile.am: New file.
	* maps/elf.map: Likewise.
	* maps/mp3.map: Likewise.
	* Makefile.am (SUBDIRS): Add maps.
	* configure.ac: Add maps/Makefile.
	* etc/poke-map-mode.el: Likewise.
	* testsuite/poke.cmd/maps-1.pk: New test.
	* testsuite/poke.cmd/maps-2.pk: Likewise.
	* testsuite/poke.cmd/maps-3.pk: Likewise.
	* testsuite/poke.cmd/maps-4.pk: Likewise.
	* testsuite/poke.cmd/maps-5.pk: Likewise.
	* testsuite/poke.cmd/maps-6.pk: Likewise.
	* HACKING: Updated.

2020-05-12  Tim Rühsen  <tim.ruehsen@gmx.de>

	* gui/Makefile.am: Use dist_guifiles_DATA instead guifiles_DATA.

2020-05-12  Jose E. Marchesi  <jemarch@gnu.org>

	* testsuite/Makefile.am (EXTRA_DIST): Complete.

2020-05-12  Jose E. Marchesi  <jemarch@gnu.org>

	* bootstrap.conf (libpoke_modules): Import the signal-h gnulib
	module.

2020-05-11  Jose E. Marchesi  <jemarch@gnu.org>

	* libpoke/Makefile.am (libpoke_la_SOURCES): Add pk-val.c
	* libpoke/pvm-val.h: Include stdint.h.
	* libpoke/pk-val.c: New file.
	* libpoke/libpoke.h (pk_val): New type.
	(PK_NULL): Define.
	(pk_make_int): Likewise.
	(pk_int_value): Likewise.
	(pk_int_size): Likewise.
	(pk_make_uint): Likewise.
	(pk_uint_value): Likewise.
	(pk_uint_size): Likewise.
	(pk_make_string): Likewise.
	(pk_string_str): Likewise.
	(pk_make_offset): Likewise.
	(pk_offset_magnitude): Likewise.
	(pk_offset_unit): Likewise.
	(pk_val_mapped_p): Likewise.
	(pk_val_ios): Likewise.
	(pk_val_offset): Likewise.
	(PK_UNKNOWN): Likewise.
	(PK_INT): Likewise.
	(PK_UINT): Likewise.
	(PK_STRING): Likewise.
	(PK_OFFSET): Likewise.
	(PK_ARRAY): Likewise.
	(PK_STRUCT): Likewise.
	(pk_val_type): Likewise.

2020-05-11  Jose E. Marchesi  <jemarch@gnu.org>

	* poke/pk-cmd-misc.c: Renamed from pk-misc.c.
	* poke/pk-cmd-info.c: Likewise.
	* poke/pk-cmd-ios.c: Likewise.
	* poke/pk-cmd-help.c: Likewise.
	* poke/pk-cmd-vm.c: Likewise.
	* poke/pk-cmd-set.c: Likewise.
	* poke/pk-cmd-editor.c: Likewise.
	* poke/pk-cmd-def.c: Likewise.
	* poke/Makefile.am (poke_SOURCES): Rename files.

2020-05-11  Jose E. Marchesi  <jemarch@gnu.org>

	* pickles/Makefile.am (picklesdir): Define.
	(dist_pickles_DATA): Change from dist_pkgdata_DATA.
	* poke/poke.c (initialize): Set poke_picklesdir to
	poke_datadir/pickles.
	* libpoke/pkl-rt.pk: Add %DATADIR%/pickles to the load-path if
	POKEPICKLESDIR is not defined.

2020-05-10  Jose E. Marchesi  <jemarch@gnu.org>

	* gui/pk-gui.tcl: Expand "about" info with copyright notice and
	licensing.

2020-05-10  Bruno Haible  <bruno@clisp.org>

	Prepare for versioning of libpoke.
	* libpoke/Makefile.am (LTV_*): New variables.
	(libpoke_la_LDFLAGS): Add -version-info option.

2020-05-10  John Darrington <john@darrington.wattle.id.au>

	* poke/poke.c (mi_supported_p): New variable.
	* poke/poke.c (POKE_MI): Evaluate this macro once only.

2020-05-10  Bruno Haible  <bruno@clisp.org>

	Fix wrong rpath in poke/.libs/lt-poke.
	* poke/Makefile.am (poke_LDADD): Use LTLIBTEXTSTYLE, not LIBTEXTSTYLE.

2020-05-10  Jose E. Marchesi  <jemarch@gnu.org>

	* gui: rename scripts.

2020-05-10  Jose E. Marchesi  <jemarch@gnu.org>

	* m4/tcl.m4: Strip from unneeded macros.
	(POKE_TCLTK): New macro.
	* configure: Use POKE_TCLTK.

2020-05-10  Jose E. Marchesi  <jemarch@gnu.org>

	* m4/tcl.m4: New file.
	* .x-sc_m4_quote_check: New file.
	* .x-sc_prohibit_always_true_header_tests: Likewise.
	* .x-sc_prohibit_magic_number_exit: Likewise.
	* .x-sc_prohibit_test_minus_ao: Likewise.
	* .x-sc_useless_cpp_parens: Likewise.
	* .x-sc_space_tab: Add m4/tcl.m4.

2020-05-10  Jose E. Marchesi  <jemarch@gnu.org>

	* Makefile.am (-DLOCALEDIR): Add to CPPFLAGS.
	* poke-gui.c (print_version): Call bindtextdomain.

2020-05-10  Jose E. Marchesi  <jemarch@gnu.org>

	* gui: Renamed from PoK.
	* Makefile.am (SUBDIR): Add gui.
	* configure.ac (AC_CONFIG_FILES): Add gui/Makefile.
	Support for --enable-gui.
	* run.in (POKEGUIDIR): Define and export POKEGUIDIR.
	* bootstrap.conf (bootstrap_post_import_hook): Create gl-gui.
	(gui_modules): Define.

2020-05-09  Jose E. Marchesi  <jemarch@gnu.org>

	* doc/poke.texi (MI Requests): New section.
	(MI Responses): Likewise.
	(MI Events): Likewise.
	(Event INITIALIZE): Likewise.
	(Request EXIT): Likewise.
	(Response EXIT): Likewise.

2020-05-09  Jose E. Marchesi  <jemarch@gnu.org>

	* poke/pk-mi-msg.h (pk_mi_msg_event_initialized_mi_version):
	Define.
	* poke/pk-mi-msg.c (pk_mi_msg_event_initialized_mi_version):
	Likewise.
	* poke/pk-mi-msg.c (PK_MI_EVENT_INITIALIZED_MI_VERSION): Define.
	(struct pk_mi_event): New field args.initialized.mi_version.
	(pk_mi_make_event_initialized): Set the MI version.
	* poke/pk-mi-json.c (pk_mi_msg_to_json_object): Do not add a
	poke_mi field.
	(pk_mi_msg_to_json_object): Add mi_version as an argument to the
	initialized event.

2020-05-09  Jose E. Marchesi  <jemarch@gnu.org>

	* HACKING (PoK Depencencies): Update.

	* poke/pk-mi-msg.h (pk_mi_set_msg_number): Define.
	* poke/pk-mi-msg.c (pk_mi_set_msg_number): Likewise.
	* poke/pk-mi-json.c (pk_mi_msg_to_json_object): Add the message
	number to the json structure.
	(pk_mi_json_object_to_msg): Likewise.

2020-05-09  Jose E. Marchesi  <jemarch@gnu.org>

	* libpoke/Makefile.am (AUTOMAKE_OPTIONS): Use the subdir-objects
	automake option.
	* poke/Makefile.am (AUTOMAKE_OPTIONS): Likewise.

2020-05-09  Jose E. Marchesi  <jemarch@gnu.org>

	* Makefile.am (SUBDIRS): Remove libutils-gl and libutils.
	* configure.ac (AC_CONFIG_FILES): Remove libutils files.
	(AC_CONFIG_MACRO_DIRS): Do not add m4/libutils.
	Do not call libutils_EARLY.
	* libutils/Makefile.am: Remove.
	* bootstrap.conf (bootstrap_post_import_hook): Do not create a
	gl-libutils gnulib.
	* libpoke/Makefile.am (libpoke_la_LIBADD): Remove libutils.la.
	* poke/Makefile.am (poke_LDADD): Likewise.
	* common: Renamed from libutils.
	* HACKING: Update.
	* .gitignore: Update.

2020-05-09  Jose E. Marchesi  <jemarch@gnu.org>

	* bootstrap.conf (libpoke_modules): Import the dirname gnulib
	module.
	* libpoke/pkl.h (pkl_module_loaded_p): Define.
	* libpoke/pkl.c (struct pkl_compiler): New fields `modules' and
	`num_modules'.
	(pkl_new): Initialize `modules' and `num_modules'.
	(pkl_load): Do not re-load already loaded modules.
	(pkl_add_module): New function.
	(pkl_free): Free memory occupied by the list of loaded modules.
	* libpoke/pkl-tab.y (load_module): Likewise.
	* testsuite/poke.pkl/load-3.pk: Amended.
	* poke/pk-ios.c (pk_cmd_load_file): Use pk_load instead of
	pk_compile_file.

2020-05-09  Jose E. Marchesi  <jemarch@gnu.org>

	* MI foundations.

2020-05-07  Tim Rühsen  <tim.ruehsen@gmx.de>

	* poke/pk-ios.c (pk_cmd_load_file): Amend OOM message to
	be the same everywhere ("No memory" to "Out of memory").
	(pk_cmd_mem): Likewise.

2020-05-07  Tim Rühsen  <tim.ruehsen@gmx.de>

	* poke/pk-cmd.c: Do not include gettext.h and pk-term.h.
	* poke/pk-def.c: Likewise.
	* poke/pk-ios.c: Likewise.
	* poke/pk-repl.c: Likewise.
	* poke/pk-set.c: Likewise.
	* poke/pk-editor.c: Do not include pk-term.h.
	* poke/pk-hserver.c: Likewise.
	* poke/pk-misc.c: Likewise.
	* poke/pk-vm.c: Likewise.

2020-05-07  Tim Rühsen  <tim.ruehsen@gmx.de>

	* poke/poke.h: New function pk_assert_alloc.
	Include stdlib.h, gettext.h and pk-term.h.
	* poke/poke.c (initialize_user): Make use of pk_assert_alloc.
	Remove including gettext.h and pk-term.h.

2020-05-07  Tim Rühsen  <tim.ruehsen@gmx.de>

	* libpoke/ios.c (ios_open): Initialize error varaible.
	* libpoke/ios-dev-file.c (ios_dev_file_handler_normalize):
	Return NULL on memory allocation error.
	* libpoke/ios-dev-mem.c (ios_dev_mem_handler_normalize): Likewise.
	* libpoke/ios-dev-nbd.c (ios_dev_nbd_handler_normalize): Likewise.

2020-05-06  Tim Rühsen  <tim.ruehsen@gmx.de>

	* bootstrap.conf: Remove xstrndup from libpoke_modules.
	* libpoke/pkl-trans.c (pkl_trans1_ps_print_stmt):  Use strndup
	instead of xstrndup.

2020-05-06  Tim Rühsen  <tim.ruehsen@gmx.de>

	* libpoke/pkl-fold.c (OP_BINARY_SSS): Check return value of
	pk_str_concat.
	* libpoke/pkl.c (pkl_new): Likewise.
	* poke/pk-cmd.c (pk_cmd_exec): Likewise.
	* poke/poke.c (initialize_user): Likewise.

2020-05-06  Tim Rühsen  <tim.ruehsen@gmx.de>

	* bootstrap.conf: Remove xalloc from libutils_modules.
	* libutils/pk-utils.c (pk_str_concat): Use malloc instead of xmalloc.

2020-05-05  Tim Rühsen  <tim.ruehsen@gmx.de>

	* .gitignore: Add /gl-libpoke.
	* Makefile.am: Add gl-libpoke to SUBDIRS.
	* bootstrap.conf: Invoke gnulib-tool to generate gl-libpoke.
	Cleanup gnulib module lists.
	Remove --lgpl=3 from gnulib-tool invocation.
	* configure.ac: Add m4/libpoke to AC_CONFIG_MACRO_DIRS.
	Add libpoke_EARLY.
	Add gl-libpoke/Makefile to AC_CONFIG_FILES.
	* libpoke/Makefile.am: Use gl-libpoke/libgnu.la in libpoke_la_LIBADD.

2020-05-05  Jose E. Marchesi  <jose.marchesi@oracle.com>

	* bootstrap.conf: libutils is GPLv3+.

2020-05-05  Jose E. Marchesi  <jemarch@gnu.org>

	* bootstrap.conf (libutils_modules): Add xalloc.

2020-05-05  Tim Rühsen  <tim.ruehsen@gmx.de>

	* .gitignore: Add /gl-libutils.
	* Makefile.am: Add gl-libutils to SUBDIRS.
	* bootstrap.conf: Invoke gnulib-tool to generate gl-libutils.
	* configure.ac: Add m4/libutils to AC_CONFIG_MACRO_DIRS.
	Add libutils_EARLY.
	Add gl-libutils/Makefile to AC_CONFIG_FILES.
	* libutils/Makefile.am: Use gl-libutils/libgnu.la in libutils_la_LIBADD.

2020-05-05  Darshit Shah  <darnir@gnu.org>

  * poke/Makefile.am: Merge two ifdef blocks into one. (Purely cosmetic)

2020-05-05  Darshit Shah  <darnir@gnu.org>

  * m4/libtextstyle-hyperlink.m4: Use an action-if-true to prevent adding it to LIBS
  AC_SEARCH_LIBS will add the library to LIBS if action-if-true is empty.
  We prevent that by adding an action-if-true, and manually including
  LTLIBTEXTSTYLE in the libraries for Poke. This allows libpoke.so to be
  build without linking against libtextstle.

2020-05-05  Jose E. Marchesi  <jemarch@gnu.org>

	* libpoke/libpoke.c (complete_struct): Add parentheses in
	expression to avoid a compiler warning.

2020-05-05  Jose E. Marchesi  <jemarch@gnu.org>

	* pickles/future/bson.pk: Minor fixes.

2020-05-04  Tim Rühsen  <tim.ruehsen@gmx.de>

	* HACKING: Fix some URLs from http: to https:

2020-05-04  Jose E. Marchesi  <jemarch@gnu.org>

	* libpoke/libpoke.c (complete_struct): Fix completion of normal
	fields, and add support for completing method names as well.
	* libpoke/pkl-ast.c (pkl_struct_type_traverse): Revert changes
	from commit 9e0206681.
	* testsuite/poke.repl/repl.exp (tab-completion-struct-field-1):
	New test.
	(tab-completion-struct-field-2): Likewise.
	(tab-completion-struct-field-3): Likewise.

2020-05-04  Jose E. Marchesi  <jemarch@gnu.org>

	* libpoke/pkl-anal.h (struct pkl_anal_payload): New fields context
	and next_context.
	(pkl_anal_init_payload): Define.
	(PKL_ANAL_NO_CONTEXT): Likewise.
	(PKL_ANAL_CONTEXT_STRUCT_TYPE): Likewise.
	(PKL_ANAL_CONTEXT_METHOD): Likewise.
	* libpoke/pkl.c (rest_of_compilation): Use pkl_anal_init_payload.
	* libpoke/pkl-lex.l: Process METHOD.
	* lib/pkl-tab.y (declaration): Use defun_or_method and annotate
	function nodes as methods accordingly.
	(defun_or_method): New rule.
	(IS_DEFUN): Define.
	(IS_METHOD): Likewise.
	* libpoke/pkl-ast.h (PKL_AST_DECL_IN_STRUCT_P): Define.
	(struct pkl_ast_decl): New field in_struct_p.
	* libpoke/pkl-trans.c (pkl_trans1_pr_decl): Do not annotate
	functions as methods.
	Annotate declarations in struct types.
	* libpoke/std.pk (POSIX_Time64): Turn defun into method.
	(POSIX_Time32): Likewise.
	* pickles/id3v1.pk: Likewise.
	* pickles/bpf.pk: Likewise.
	* pickles/btf.pk: Likewise.
	* pickles/ctf.pk: Likewise.
	* pickles/elf.pk: Likewise.
	* pickles/leb128.pk: Likewise.
	* libpoke/pkl-anal.c (pkl_anal1_pr_decl): New handler.
	(pkl_phase_anal1): Register handler.
	(pkl_anal1_ps_var): methods can only be referenced as variables
	from other methods, nor other defuns.  Allow for regular functions
	to refer to struct fields as variables.
	(pkl_anal1_ps_ass_stmt): New handler.
	(pkl_phase_anal1): Install handler.
	(pkl_anal1_ps_type_struct): Update error message to reflect
	methods.
	(PKL_ANAL_CONTEXT): Define.
	(PKL_ANAL_CONTEXT_PUSH_STRUCT_TYPE): Likewise.
	(PKL_ANAL_POP_CONTEXT): Likewise.
	(pkl_anal1_pr_type_struct): New handler.
	(pkl_anal1_ps_type_struct): Pop analysis context.
	(pkl_anal1_pr_func): New handler.
	(pkl_phase_anal1): Register new handlers.
	* libpoke/pkl-gen.pks (struct_mapper): Do not register regular
	defuns as methods.
	(struct_constructor): Likewise.
	* libpoke/pkl-typify.c (pkl_typify1_ps_struct_ref): Do not allow
	referring to non-methods in srefs.
	* doc/poke.texi: Update.
	* testsuite/poke.map/maps-structs-methods-11.pk (Foo): Likewise.
	* testsuite/poke.map/maps-structs-methods-10.pk (Foo): Likewise.
	* testsuite/poke.map/maps-structs-methods-9.pk (Foo): Likewise.
	* testsuite/poke.map/maps-structs-methods-8.pk (Foo): Likewise.
	* testsuite/poke.map/maps-structs-methods-7.pk (Foo): Likewise.
	* testsuite/poke.map/maps-structs-methods-6.pk (Foo): Likewise.
	* testsuite/poke.map/maps-structs-methods-5.pk (ULEB_128): Likewise.
	* testsuite/poke.map/maps-structs-methods-4.pk (Foo): Likewise.
	* testsuite/poke.map/maps-structs-methods-3.pk (Foo): Likewise.
	* testsuite/poke.map/maps-structs-methods-2.pk (Foo): Likewise.
	* testsuite/poke.map/maps-structs-methods-1.pk (Foo): Likewise.
	* testsuite/poke.pkl/struct-pretty-print-4.pk (Foo): Likewise.
	* testsuite/poke.pkl/struct-pretty-print-3.pk (Foo): Likewise.
	* testsuite/poke.pkl/struct-pretty-print-2.pk (Foo): Likewise.
	* testsuite/poke.pkl/struct-pretty-print-1.pk (Foo): Likewise.
	* testsuite/poke.pkl/struct-method-diag-6.pk (Foo): Likewise.
	* testsuite/poke.pkl/struct-method-diag-5.pk (Foo): Likewise.
	* testsuite/poke.pkl/struct-method-diag-4.pk (Foo): Likewise.
	* testsuite/poke.pkl/struct-method-diag-3.pk (Foo): Likewise.
	* testsuite/poke.pkl/struct-method-diag-2.pk (Foo): Likewise.
	* testsuite/poke.pkl/struct-method-diag-1.pk (Foo): Likewise.
	* testsuite/poke.pkl/struct-method-8.pk (Foo): Likewise.
	* testsuite/poke.pkl/struct-method-7.pk (Foo): Likewise.
	* testsuite/poke.pkl/struct-method-6.pk (Foo): Likewise.
	* testsuite/poke.pkl/struct-method-5.pk (Foo): Likewise.
	* testsuite/poke.pkl/struct-method-4.pk (Foo): Likewise.
	* testsuite/poke.pkl/struct-method-3.pk (Foo): Likewise.
	* testsuite/poke.pkl/struct-method-2.pk (Foo): Likewise.
	* testsuite/poke.pkl/struct-method-1.pk (Foo): Likewise.
	* testsuite/poke.pkl/scons-23.pk (Bar): Likewise.
	* testsuite/poke.pkl/scons-19.pk (Foo): Likewise.
	* testsuite/poke.pkl/scons-18.pk (BPF_Reg): Likewise.
	* testsuite/poke.pkl/optcond-17.pk (Foo): Likewise.
	* testsuite/poke.pkl/optcond-16.pk (Foo): Likewise.
	* testsuite/poke.pkl/optcond-12.pk (Foo): Likewise.
	* testsuite/poke.pkl/struct-method-diag-7.pk: New test.
	* testsuite/poke.pkl/struct-method-diag-8.pk: Likewise.
	* testsuite/poke.pkl/struct-method-diag-9.pk: Likewise.
	* testsuite/poke.pkl/sref-diag-1.pk: Likewise.
	* testsuite/poke.pkl/sref-diag-2.pk: Likewise.
	* testsuite/poke.pkl/struct-types-defun-1.pk: Likeiwse.
	* testsuite/poke.pkl/struct-types-defun-2.pk: Likewise.
	* testsuite/poke.pkl/struct-types-defun-3.pk: Likewise.
	* testsuite/poke.pkl/struct-method-diag-10.pk: Likewise.
	* testsuite/poke.pkl/struct-method-diag-11.pk: Likewise.
	* testsuite/poke.pkl/optcond-18.pk: Likewise.
	* testsuite/poke.pkl/optcond-19.pk: Likewise.
	* testsuite/poke.pkl/optcond-20.pk: Likewise.
	* testsuite/poke.pkl/struct-pretty-print-5.pk: Likewise.
	* testsuite/poke.pkl/struct-types-defun-diag-1.pk: Likewise.
	* testsuite/poke.pkl/struct-types-defun-diag-2.pk: Likewise.
	* testsuite/poke.pkl/struct-method-9.pk: Likewise.
	* testsuite/poke.pkl/struct-method-diag-12.pk: Likewise.
	* testsuite/poke.pkl/struct-method-diag-13.pk: Likewise.
	* testsuite/poke.pkl/struct-method-diag-14.pk: Likewise.

2020-05-04  Jose E. Marchesi  <jemarch@gnu.org>

	* poke/poke.c (initialize): Exit if there is an error initializing
	the poke incremental compiler.
	* libpoke/libpoke.c (pk_compiler_new): Acknowledge errors from
	pvm_init and pkl_new.

2020-05-04  Jose E. Marchesi  <jemarch@gnu.org>

	* libpoke/libpoke.h: Little fixes in comments.

2020-05-03  Tim Rühsen  <tim.ruehsen@gmx.de>

	* libpoke/pk-utils.c (pk_print_binary): Format args GNU-style.

2020-05-03  Jose E. Marchesi  <jemarch@gnu.org>

	* doc/Makefile.am (poke.text): Generate in builddir, not in
	srcdir.
	(nodelist): Likewise.  Also avoid $@.
	(clean-local): Remove nodelist and poke.text.
	* poke/poke.c (poke_docdir): New variable.
	(initialize): Initialize poke_docdir.
	* poke/pk-misc.c (doc_completion_function): Use poke_docdir to
	find the nodelist file.
	(pk_cmd_doc): Likewise for the poke.text file.
	* run.in (POKEDOCDIR): Set to top_builddir/doc.
	* testsuite/Makefile.am (check-DEJAGNU): Set POKEDOCDIR.

2020-05-03  Jose E. Marchesi  <jemarch@gnu.org>

	* libpoke/pkl-trans.c (pkl_trans3_ps_of_sizeof): Remove stale
	debugging trace.

2020-05-03  Jose E. Marchesi  <jemarch@gnu.org>

	* libpoke/pkl-gen.h (struct pkl_gen_payload): New field
	generating_pvm_struct_type.
	* libpoke/pkl-gen.c (pkl_gen_pr_decl): Break the pass if
	generating a pvm struct type.
	(pkl_gen_pr_type_struct): Set generating_pvm_struct_type.
	(pkl_gen_ps_type_struct): Clear generating_pvm_struct_type.
	* testsuite/poke.pkl/arrays-13.pk: New test.

2020-05-03  Tim Rühsen  <tim.ruehsen@gmx.de>

	* libutils/Makefile.am: New file.

2020-05-03  Tim Rühsen  <tim.ruehsen@gmx.de>

	* Makefile.am: Add libutils to SUBDIRS.
	* configure.ac: Add libutils/Makefile to AC_CONFIG_FILES.
	* libutils/Makefile.am: New file.
	* libpoke/pk-utils.c: Move to libutils/.
	* libpoke/pk-utils.h: Likewise.
	* libpoke/Makefile.am: Use libutils/libutils.la instead of
	libpoke/libpokeutils.la.
	* poke/Makefile.am: Likewise.
	* po/POTFILES.in: Add libutils/pk-utils.[ch].

2020-05-03  Jose E. Marchesi  <jemarch@gnu.org>

	* pickles/id3v1.pk (ID3V1_Tag): Add setter and getter methods.
	* testsuite/poke.id3v1/id3v1.exp: New testsuite.
	* testsuite/poke.id3v1/id3v1-1.pk: New test.
	* testsuite/poke.id3v1/id3v1-2.pk: Likewise.
	* testsuite/poke.id3v1/id3v1-3.pk: Likewise.
	* testsuite/poke.id3v1/id3v1-4.pk: Likewise.
	* testsuite/poke.id3v1/id3v1-5.pk: Likewise.
	* testsuite/poke.id3v1/id3v1-6.pk: Likewise.
	* testsuite/poke.id3v1/id3v1-7.pk: Likewise.
	* testsuite/poke.id3v1/id3v1-8.pk: Likewise.
	* testsuite/poke.id3v1/id3v1-9.pk: Likewise.
	* doc/poke.texi (Audio): New chapter.
	(MP3): New section.
	(ID3V1 Tags): New subsection.

2020-05-03  Tim Rühsen  <tim.ruehsen@gmx.de>

	* libpoke/Makefile.am: Add libgnu.la to libpoke_la_LIBADD.
	* libpoke/pkl-fold.c: Use fold_gcd instead gcd.

2020-05-02  Tim Rühsen  <tim.ruehsen@gmx.de>

	* libpoke/libpoke.h: Remove include of pk-utils.h.
	Add include of stdint.h.
	* libpoke/Makefile.am: Add libpokeutils.la to ib_LTLIBRARIES.
	Remove pk-utils.h pk-utils.c from libpoke_la_SOURCES.
	Add libpokeutils.la to libpoke_la_LIBADD.
	Add assignments for libpokeutils_la.
	* poke/Makefile.am: Add libpokeutils.la to poke_LDADD.
	* poke/pk-cmd.c: Add include of pk-utils.h.
	* poke/pk-cmd.h: Add include of stddef.h.
	* poke/pk-editor.c: Add include of pk-utils.h.
	* poke/pk-info.c: Likewise.
	* poke/pk-ios.c: Likewise.
	* poke/pk-misc.c: Likewise.
	* poke/pk-set.c: Likewise.
	* poke/poke.c: Likewise.

2020-05-03  Jose E. Marchesi  <jemarch@gnu.org>

	* libpoke/std.pk (stoca): Define.
	* testsuite/poke.std/stoca-1.pk: New test.
	* testsuite/poke.std/stoca-2.pk: Likewise.
	* testsuite/poke.std/stoca-3.pk: Likewise.
	* testsuite/poke.std/stoca-4.pk: Likewise.
	* doc/poke.texi (stoca): New section.

2020-05-03  Jose E. Marchesi  <jemarch@gnu.org>

	* doc/poke.texi (Writing Pickles): New chapter.
	(Setters and Getters): Likewise.

2020-05-03  John Darrington <john@darrington.wattle.id.au>

	* poke/pk-cmd.c: Reduce scope of local variables.

2020-05-03  John Darrington <john@darrington.wattle.id.au>

	* poke/pk-cmd.c (pk_cmd_get_next_match): Fix bug in completer.

2020-05-02  Jose E. Marchesi  <jemarch@gnu.org>

	* pickles/id3v1.pk (ID3V1_Tag): Text-stylize the output of the
	pretty-printer.

2020-05-02  Jose E. Marchesi  <jemarch@gnu.org>

	* libpoke/pkl-gen.c (pkl_gen_pr_ass_stmt): Support field variables
	in l-values in methods.
	* testsuite/poke.pkl/struct-method-8.pk: New test.
	* testsuite/poke.map/maps-structs-methods-11.pk: Likewise.

2020-05-02  Jose E. Marchesi  <jemarch@gnu.org>

	* pickles/id3v1.pk: Moved from future/.

2020-05-02  Jose E. Marchesi  <jemarch@gnu.org>

	* poke/Makefile.am (poke_CPPFLAGS): Adjust to lib->libpoke.

2020-05-02  Jose E. Marchesi  <jemarch@gnu.org>

	* poke: renamed from src.
	* libpoke: renamed from lib.
	* Makefile.am (SUBDIRS): Update accordingly.
	* configure.ac: Likewise.
	* doc/Makefile.am: Likewise.
	* poke/Makefile.am: Likewise.
	* run.in: Likewise.
	* testsuite/lib/poke.exp: Likewise.
	* testsuite/Makefile.am: Likewise.
	* HACKING: Likewise.
	* .gitignore: Likewise.

2020-05-02  Tim Rühsen  <tim.ruehsen@gmx.de>

	* lib/pk-utils.c: Remove pkt.h from includes.
	(pk_print_binary): Add string output function as first param.
	* lib/pk-utils.h (pk_print_binary): Likewise.
	* lib/pvm-val.c (pvm_print_val_1): Add pk_puts as first param
	when calling pk_print_binary.
	* lib/pvm.jitter: Likewise.

2020-05-02  Tim Rühsen  <tim.ruehsen@gmx.de>

2020-05-02  Jose E. Marchesi  <jemarch@gnu.org>

	* lib/pvm.jitter (PVM_POKE): Use the current IO space if PVM_NULL
	is passed as the IOS.
	(PVM_PEEK): Likewise.
	* testsuite/poke.pkl/ios-cur-1.pk: New test.

2020-05-02  Tim Rühsen  <tim.ruehsen@gmx.de>

	* src/pk-cmd.c: Add macro is_command.
	(pk_cmd_exec): Use IS_COMMAND to check for command.

2020-05-02  Tim Rühsen  <tim.ruehsen@gmx.de>

	* src/pk-cmd.c (pk_cmd_exec): Fix params to strncmp.

2020-05-02  Jose E. Marchesi  <jemarch@gnu.org>

	* lib/pkl-gen.c (pkl_gen_pr_func): Fix typo in comment.

2020-05-02  Jose E. Marchesi  <jemarch@gnu.org>

	* lib/pkl-anal.c (pkl_anal1_ps_var): New handler.
	(pkl_phase_anal1): Register handler.
	* lib/pkl-trans.h (struct pkl_trans_payload): New field
	`function_back'.
	* lib/pkl-ast.h (PKL_AST_FUNC_METHOD_P): Define.
	(struct pkl_ast_func): New field method_p.
	(PKL_AST_VAR_FUNCTION): Define.
	(PKL_AST_VAR_FUNCTION_BACK): Likewise.
	(struct pkl_ast_var): New fields `function' and `function_back'.
	* lib/pkl-ast.c (pkl_ast_print_1): Print the method_p attribute of
	function ast nodes.
	* lib/pkl-tab.y (function_specifier): Always introduce a lexical
	environment for function arguments.
	* lib/pkl-trans.c (pkl_trans1_pr_decl): Annotate functions as
	methods whenever appropriate.
	(PKL_TRANS_PUSH_FUNCTION): reset the function_back to 0.
	(PKL_TRANS_FUNCTION_BACK): Define.
	(PKL_TRANS_INCR_FUNCTION_BACK): Likewise.
	(PKL_TRANS_DECR_FUNCTION_BACK): Likewise.
	(pkl_trans1_pr_comp_stmt): New handler.
	* lib/pkl-gen.c (pkl_gen_pr_func): Acknowledge the implicit first
	argument in methods.
	(pkl_gen_ps_func): Likewise.
	* lib/pvm-val.c (pvm_call_pretty_printer): Pass the struct as an
	argument to the pretty-printer.
	* pickles/bpf.pk: Adap to obey new rules for methods.
	* testsuite/poke.pkl/struct-method-2.pk: New test.
	* testsuite/poke.pkl/struct-method-3.pk: Likewise.
	* testsuite/poke.pkl/struct-method-4.pk: Likewise.
	* testsuite/poke.pkl/struct-method-5.pk: Likewise.
	* testsuite/poke.pkl/struct-method-6.pk: Likewise.
	* testsuite/poke.pkl/struct-method-diag-1.pk: Likewise.
	* testsuite/poke.pkl/struct-method-diag-2.pk: Likewise.
	* testsuite/poke.pkl/struct-method-diag-3.pk: Likewise.
	* testsuite/poke.pkl/struct-types-5.pk: Adapt.
	* testsuite/poke.pkl/struct-types-4.pk: Likewise.
	* testsuite/poke.map/maps-unions-6.pk: Likewise.
	* testsuite/poke.map/maps-structs-12.pk: Likewise.
	* testsuite/poke.map/maps-structs-methods-10.pk: Likewise.
	* testsuite/poke.map/maps-structs-methods-9.pk: Likewise.
	* testsuite/poke.pkl/struct-method-8.pk: Likewise.
	* testsuite/poke.pkl/struct-method-diag-4.pk: Likewise.
	* testsuite/poke.pkl/struct-method-7.pk: Likewise.
	* testsuite/poke.pkl/struct-method-diag-5.pk: Likewise.
	* testsuite/poke.pkl/struct-method-diag-6.pk (Foo): Likewise.

2020-05-02  John Darrington <john@darrington.wattle.id.au>

	* src/pk-editor.c (pk_cmd_editor): Remove useless code.

2020-05-02  John Darrington <john@darrington.wattle.id.au>

	* src/pk-misc.c (pk_cmd_doc): Reduce scope of local variables.

2020-05-02  Tim Rühsen  <tim.ruehsen@gmx.de>

	* src/pk-repl.c (pk_repl): Remove unused variable.

2020-05-02  Tim Rühsen  <tim.ruehsen@gmx.de>

	* src/pk-cmd.c (pk_cmd_exec_1): Narrow variable scope
	and fix compiler warning with it.

2020-05-02  Tim Rühsen  <tim.ruehsen@gmx.de>

	* etc/git-hooks/pre_push: Make syntax-check only if needed.

2020-05-02  John Darrington <john@darrington.wattle.id.au>

	* doc/poke.texi (Conditional Expressions): Add indeces.

2020-05-02  John Darrington <john@darrington.wattle.id.au>

	* doc/poke.texi: Use @dots{} instead of ...

2020-05-02  John Darrington <john@darrington.wattle.id.au>

	* doc/poke.texi: Add italic markup on latin loan words.

2020-05-02  John Darrington <john@darrington.wattle.id.au>

	* doc/poke.texi: Don't indent in the middle of a paragraph

2020-05-02  John Darrington <john@darrington.wattle.id.au>

	* src/pk-repl.c (escape_metacharacters): Add comment.

2020-05-02  John Darrington <john@darrington.wattle.id.au>

	* lib/libpoke.c (pk_completion_function): Improve comments and
	parameter naming.
	* lib/libpoke.c (pk_ios_completion_function): Ditto.
	* lib/libpoke.h (pk_completion_function): Ditto.
	* lib/libpoke.h (pk_ios_completion_function): Ditto.
	* src/pk-rep.c (poke_completion_function): Ditto.

2020-05-02  John Darrington <john@darrington.wattle.id.au>

	* src/pk-cmd.c (pk_cmd_get_next_match): Remove parameter
	idx and use a static local instead.
	* src/pk-cmd.h (pk_cmd_get_next_match): Remove parameter
	idx.
	* src/pk-repl.c (poke_completion_function): Adjust call
	to pk_cmd_get_next_match.

2020-05-02  John Darrington <john@darrington.wattle.id.au>

	* doc/poke.texi (Poking Structs): Replace "Lets" with "Let's".
	* cfg.mk (sc_jemarchism.z): New rule.
	* cfg.mk (local-checks-available): Add it.

2020-05-01  Jose E. Marchesi  <jemarch@gnu.org>

	* testsuite/poke.pkl/optcond-16.pk: New test.
	* testsuite/poke.pkl/optcond-17.pk: Likewise.

2020-05-01  Jose E. Marchesi  <jemarch@gnu.org>

	* doc/poke.texi (The Color Registry): Fix example.

2020-05-01  Jose E. Marchesi  <jemarch@gnu.org>

	* pickles/color.pk: Reduce, and add comments.
	* pickles/rgb24.pk: New file.
	* pickles/Makefile.am (dist_pkgdata_DATA): Add rgb24.pk.
	* testsuite/poke.rgb24/rgb24.exp: New testsuite.
	* testsuite/poke.rgb24/rgb24-1.pk: New test.
	* doc/poke.texi (RGB24 Encoding): New section.

2020-05-01  Jose E. Marchesi  <jemarch@gnu.org>

	* pickles/color.pk: New file.
	* pickles/Makefile.am (dist_pkgdata_DATA): Add color.pk.
	* testsuite/poke.color/color.exp: New testsuite.
	* testsuite/poke.color/color-1.pk: New test.
	* testsuite/poke.color/color-2.pk: Likewise.
	* testsuite/poke.color/color-3.pk: Likewise.
	* testsuite/poke.color/color-4.pk: Likewise.
	* doc/poke.texi (Colors): New chapter.
	(The Color Registry): New section.
	* HACKING (Testing Pickles): New section.
	(Writing Documentation): New chapter.
	(Documenting Pickles): New section.

2020-05-01  Jose E. Marchesi  <jemarch@gnu.org>

	* HACKING: update the libtool call for gdb line.

2020-05-01  Jose E. Marchesi  <jemarch@gnu.org>

	* doc/poke.texi (Poking Structs): New section.

2020-05-01  Jose E. Marchesi  <jemarch@gnu.org>

	* lib/pkl-gen.c: Remove trailing whitespaces.

2020-05-01  Jose E. Marchesi  <jemarch@gnu.org>

	* lib/pkl-gen.c (pkl_gen_pr_if_stmt): Optimize constant
	expressions in conditional statements.
	* testsuite/poke.pkl/if-4.pk: New test.
	* testsuite/poke.pkl/if-5.pk: Likewise.

2020-05-01  Jose E. Marchesi  <jemarch@gnu.org>

	* lib/libpoke.c (pk_disassemble_function): Do not destroy the
	disassembled program.

2020-05-01  Jose E. Marchesi  <jemarch@gnu.org>

	* lib/pkl-gen.c (pkl_gen_pr_comp_stmt): Optimize empty compound
	statements away.

2020-05-01  Jose E. Marchesi  <jemarch@gnu.org>

	* lib/pkl-gen.c (pkl_gen_pr_loop_stmt): Optimize while(0) and
	while(1).

2020-05-01  Tim Rühsen  <tim.ruehsen@gmx.de>

	* po/POTFILES.in: Move lib/pk-term.[ch] to src/

2020-04-30  Jose E. Marchesi  <jemarch@gnu.org>

	* HACKING: Document lib/pkt.h.

2020-04-30  Jose E. Marchesi  <jemarch@gnu.org>

	* lib/libpoke.h (pk_compiler_new): Remove the term_payload
	argument.
	* lib/libpoke.c (pk_compiler_new): Likewise.
	* src/poke.c (initialize): Likewise.

2020-04-30  Jose E. Marchesi  <jemarch@gnu.org>

	* lib/libpoke.c (pk_compiler_new): Get new arguments term_if and
	term_payload.
	* lib/libpoke.h (pk_term_flush_fn): New type.
	(pk_term_puts_fn): Likewise.
	(pk_term_printf_fn): Likewise.
	(pk_term_class_fn): Likewise.
	(pk_term_end_class_fn): Likewise.
	(pk_term_hyperlink_fn): Likewise.
	(pk_term_end_hyperlink_fn): Likewise.
	* src/pk-term.h: Moved from lib.
	* src/pk-term.c: Likewise.
	* src/Makefile.am (poke_SOURCES): Add pk-term.h and pk-term.c.
	(poke_LDADD): Add libtextstyle.
	* lib/Makefile.am (libpoke_la_LIBADD): Remove libtextstyle.
	* lib/Makefile.am (libpoke_la_SOURCES): Remove pk-term.h and
	pk-term.c.
	(include_HEADERS): Remove pk-term.h.
	* HACKING: Updated to reflect relocated sources.
	* lib/pkt.h: New file.
	* src/pk-cmd.c: Include pk-term.h.
	* src/poke.c: Likewise.
	* src/pk-vm.c: Likewise.
	* src/pk-set.c: Likewise.
	* src/pk-repl.c: Likewise.
	* src/pk-misc.c: Likewise.
	* src/pk-ios.c: Likewise.
	* src/pk-hserver.c: Likewise.
	* src/pk-editor.c: Likewise.
	* src/pk-def.c: Likewise.

2020-04-30  Jose E. Marchesi  <jemarch@gnu.org>

	* HACKING: Add lib/libpoke.[ch] to the source tree appendix.

2020-04-29  Jose E. Marchesi  <jemarch@gnu.org>

	* lib/Makefile.am (include_HEADERS): Add missing pk-utils.h and
	pk-term.h.

2020-04-17  Jose E. Marchesi  <jemarch@gnu.org>

	* src/poke.h (poke_compiler): Switch to type pk_compiler.
	(poke_vm): Remove extern.
	Do not include pkl.h.
	Include libpoke.h.

	* src/poke.c (finalize): Use pk_free_compiler.
	(initialize): Use pk_compiler_new.
	(poke_compiler): Switch to type pk_compiler.
	(poke_vm): Remove global.

	* lib/libpoke.h (pk_compiler): New type.
	* lib/libpoke.c (pk_compiler_new): New function.
	(pk_compiler_free): Likewise.

2020-04-15  Jose E. Marchesi  <jemarch@gnu.org>

	* lib/libpoke.h: New file.
	* lib/libpoke.c: Likewise.
	* lib/Makefile.am (include_HEADERS): Distribute libpoke.h.
	(libpoke_la_SOURCES): Add libpoke.h and libpoke.c and remove
	pkl-compiler.h.
	* lib/pkl-compiler.h: Remove.
	* lib/pvm.h: Mark function prototypes as hidden.
	* lib/pkl.h: Likewise.
	* lib/ios.h: Likewise.

2020-04-15  Jose E. Marchesi  <jemarch@gnu.org>

	* lib/pkl.h: Fix typo.

2020-04-15  Jose E. Marchesi  <jemarch@gnu.org>

	* lib/pkl-compiler.h: New file.
	* lib/pkl-asm.c: Include pkl-compiler.h

2020-04-15  Jose E. Marchesi  <jemarch@gnu.org>

	* lib/pkl-tab.y (pkl_tab_error): Mark as static.
	(pkl_register_arg): Likewise.
	(pkl_register_args): likewise.
	* lib/pkl-ast.h (pkl_ast_chainon): Set ELF visibility to hidden.
	(pkl_ast_make_program): Likewise.
	(pkl_ast_make_identifier): Likewise.
	(pkl_ast_make_integer): Likewise.
	(pkl_ast_make_string): Likewise.
	(pkl_ast_make_array): Likewise.
	(pkl_ast_make_array_initializer): Likewise.
	(pkl_ast_make_struct): Likewise.
	(pkl_ast_make_struct_field): Likewise.
	(pkl_ast_make_unary_exp): Likewise.
	(pkl_ast_make_binary_exp): Likewise.
	(pkl_ast_make_cond_exp): Likewise.
	(pkl_ast_make_enumerator): Likewise.
	(pkl_ast_make_enum): Likewise.
	(pkl_ast_make_func): Likewise.
	(pkl_ast_make_func_arg): Likewise.
	(pkl_ast_make_trimmer): Likewise.
	(pkl_ast_make_indexer): Likewise.
	(pkl_ast_make_struct_ref): Likewise.
	(pkl_ast_make_struct_field_type): Likewise.
	(pkl_ast_make_func_type_arg): Likewise.
	(pkl_ast_make_named_type): Likewise.
	(pkl_ast_make_integral_type): Likewise.
	(pkl_ast_make_void_type): Likewise.
	(pkl_ast_make_string_type): Likewise.
	(pkl_ast_make_array_type): Likewise.
	(pkl_ast_make_struct_type): Likewise.
	(pkl_ast_make_offset_type): Likewise.
	(pkl_ast_make_function_type): Likewise.
	(pkl_ast_make_any_type): Likewise.
	(pkl_ast_dup_type): Likewise.
	(pkl_ast_type_promoteable): Likewise.
	(pkl_ast_sizeof_type): Likewise.
	(pkl_ast_type_is_complete): Likewise.
	(pkl_ast_array_type_remove_bounders): Likewise.
	(pkl_ast_make_decl): Likewise.
	(pkl_ast_make_offset): Likewise.
	(pkl_ast_make_cast): Likewise.
	(pkl_ast_make_isa): Likewise.
	(pkl_ast_make_map): Likewise.
	(pkl_ast_make_scons): Likewise.
	(pkl_ast_make_funcall): Likewise.
	(pkl_ast_make_funcall_arg): Likewise.
	(pkl_ast_make_var): Likewise.
	(pkl_ast_make_comp_stmt): Likewise.
	(pkl_ast_make_builtin): Likewise.
	(pkl_ast_make_null_stmt): Likewise.
	(pkl_ast_make_ass_stmt): Likewise.
	(pkl_ast_make_if_stmt): Likewise.
	(pkl_ast_make_loop_stmt): Likewise.
	(pkl_ast_make_loop_stmt_iterator): Likewise.
	(pkl_ast_make_return_stmt): Likewise.
	(pkl_ast_finish_returns): Likewise.
	(pkl_ast_make_exp_stmt): Likewise.
	(pkl_ast_make_try_until_stmt): Likewise.
	(pkl_ast_make_try_catch_stmt): Likewise.
	(pkl_ast_make_print_stmt): Likewise.
	(pkl_ast_make_print_stmt_arg): Likewise.
	(pkl_ast_make_break_stmt): Likewise.
	(pkl_ast_finish_breaks): Likewise.
	(pkl_ast_make_raise_stmt): Likewise.
	(pkl_ast_init): Likewise.
	(pkl_ast_free): Likewise.
	(pkl_ast_node_free): Likewise.
	(pkl_ast_node_free_chain): Likewise.
	(pkl_ast_reverse): Likewise.
	(pkl_ast_type_equal): Likewise.
	(pkl_ast_type_is_exception): Likewise.
	(pkl_ast_lvalue_p): Likewise.
	(pkl_ast_print): Likewise.
	(pkl_print_type): Likewise.
	(pkl_type_str): Likewise.
	(pkl_ast_func_all_optargs): Likewise.
	(pkl_ast_type_mappable_p): Likewise.
	* lib/pkl-env.h (pkl_env_free): Likewise.
	(pkl_env_free): Likewise.
	(pkl_env_push_frame): Likewise.
	(pkl_env_pop_frame): Likewise.
	(pkl_env_register): Likewise.
	(pkl_env_toplevel_p): Likewise.
	(pkl_env_dup_toplevel): Likewise.
	* lib/pkl-diag.h (pkl_error): Likewise.
	(pkl_warning): Likewise.
	(pkl_ice): Likewise.
	* lib/pkl-asm.h (pkl_asm_new): Likewise.
	(pkl_asm_finish): Likewise.
	(pkl_asm_insn): Likewise.
	(pkl_asm_call): Likewise.
	(pkl_asm_if): Likewise.
	(pkl_asm_then): Likewise.
	(pkl_asm_else): Likewise.
	(pkl_asm_endif): Likewise.
	(pkl_asm_while): Likewise.
	(pkl_asm_loop): Likewise.
	(pkl_asm_endloop): Likewise.
	(pkl_asm_for): Likewise.
	(pkl_asm_for_where): Likewise.
	(pkl_asm_for_loop): Likewise.
	(pkl_asm_for_endloop): Likewise.
	(pkl_asm_try): Likewise.
	(pkl_asm_catch): Likewise.
	(pkl_asm_endtry): Likewise.
	(pkl_asm_break_label): Likewise.
	(pkl_asm_note): Likewise.
	(pkl_asm_fresh_label): Likewise.
	(pkl_asm_label): Likewise.
	* lib/pkl-parser.h (pkl_parse_file): Likewise.
	(pkl_parse_buffer): Likewise.
	* lib/pkl-pass.h (pkl_do_pass): Likewise.
	(pkl_do_subpass): Likewise.
	* lib/pkl.h (pkl_struct_type_traverse): Moved from pkl-ast.h.
	* lib/Makefile.am (pkginclude_HEADERS): Do not distribute
	pkl-ast.h.
	* lib/pkl-env.c: Include pkl-ast.h
	* lib/pkl-diag.h: Likewise.

2020-04-26  John Darrington <john@darrington.wattle.id.au>

	* src/pk-hserver.c (pk_hserver_init): Change signature to take void.
	* src/pk-hserver.c (pk_hserver_shutdown): Ditto
	* src/poke.c (print_help): Ditto
	* src/poke.c (pk_print_version): Ditto
	* src/poke.c (finalize): Ditto
	* src/poke.c (initialize_user): Ditto
	* src/poke.h (initialize_user): Ditto

2020-04-25  John Darrington <john@darrington.wattle.id.au>

	* src/poke.c (pk_print_version): Add comment for translators.

2020-04-25  John Darrington <john@darrington.wattle.id.au>

	* src/pk-cmd.c (pk_cmd_exec): Use pk_str_concat.

2020-04-25  John Darrington <john@darrington.wattle.id.au>

	* src/poke.c (parse_args): Remove redundant variable "ret".
	* src/poke.c (initialize_user): Ditto.

2020-04-18  John Darrington <john@darrington.wattle.id.au>

	* doc/poke.texi (Array maps bounded by number of elements): New node.
	* doc/poke.texi (Array maps bounded by size): New node.
	* doc/poke.texi (Unbounded array maps): New node.
	* doc/poke.texi (Mapped bounds in bounded arrays): New node.

2020-04-14  Jose E. Marchesi  <jemarch@gnu.org>

	* lib/pvm-program.h (pvm_program_routine): Set ELF visibility to
	hidden.
	(pvm_program_beginning): Likewise.
	* lib/pkl-fold.c (pkl_phase_fold): Likewise.
	* lib/pkl-trans.c (pkl_phase_trans1): Likewise.
	(pkl_phase_trans2): Likewise.
	(pkl_phase_trans3): Likewise.
	(pkl_phase_trans4): Likewise.
	* lib/pkl-typify.c (pkl_phase_typify1): Likewise.
	(pkl_phase_typify2): Likewise.
	(GCD): Likewise.
	* lib/pkl-promo.c (pkl_phase_promo): Likewise.
	* lib/pkl-gen.c (pkl_phase_gen): Likewise.
	* lib/pkl-anal.c (pkl_phase_anal1): Likewise.
	(pkl_phase_anal2): Likewise.
	(pkl_phase_analf): Likewise.
	* lib/ios-dev-nbd.c (ios_dev_nbd): Likewise.
	* lib/ios-dev-file.c (ios_dev_file): Likewise.
	* lib/ios-dev-mem.c (ios_dev_mem): Likewise.
	* lib/pvm-val.h (pvm_allocate_struct_attrs): Likewise.
	(pvm_allocate_closure_attrs): Likewise.
	* lib/pvm-alloc.h (pvm_alloc_initialize): Likewise.
	(pvm_alloc_finalize): Likewise.
	(pvm_alloc_add_gc_roots): Likewise.
	(pvm_alloc_remove_gc_roots): Likewise.
	(pvm_alloc): Likewise.
	(pvm_realloc): Likewise.
	(pvm_alloc_cls): Likewise.
	(pvm_alloc_strdup): Likewise.
	(pvm_alloc_gc): Likewise.
	* lib/pvm.jitter (nenc_printer): Mark as static.
	(endian_printer): Likewise.
	(bits_printer): Likewise.
	(popf_printer): Likewise.
	(pvm_literal_printer_lo): Likewise.
	(pvm_literal_printer_hi): Likewise.
	(pvm_literal_printer): Likewise.
	(pvm_literal_printer_cast): Likewise.
	(printer_hi): Likewise.

2020-04-14  Jose E. Marchesi  <jemarch@gnu.org>

	* lib/pkl-trans.c (pkl_trans1_ps_print_stmt): Fix memory leak.

2020-04-13  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pk-set.c: Include stdlib.h.

2020-04-13  Jose E. Marchesi  <jemarch@gnu.org>

	* src/poke.c (poke_doc_viewer): New global.
	* src/poke.h: Likewise.
	* src/pk-set.c (set_doc_viewer): Define.
	(set_cmds): Add set_doc_viewer.
	* src/pk-misc.c (pk_cmd_doc): Support for `less' as documentation
	viewer.
	* doc/poke.texi (doc command): Update.

2020-04-13  Jose E. Marchesi  <jemarch@gnu.org>

	* doc/Makefile.am (text): New target.
	($(builddir)/doc/poke.text): Likewise.

2020-04-13  Jose E. Marchesi  <jemarch@gnu.org>

	* lib/pkl-diag.c (pkl_detailed_location): Do not use off64_t.

2020-04-13  Jose E. Marchesi  <jemarch@gnu.org>

	* lib/ras: Fix ambiguous grouping in regexps.

2020-04-12  Jose E. Marchesi  <jemarch@gnu.org>

	* lib/pkl-insn.def: Do not use a white space between PKL_DEF_INSN
	and the open parenthesis in macro invocations, as a special case.
	Add explicative note.

2020-04-12  John Darrington <john@darrington.wattle.id.au>

	* doc/Makefile.am (nodelist): Change its directory.
	* testsuite/poke.repl/repl.exp (tab-completion-subcommand-2): New test.

2020-04-12  Jose E. Marchesi  <jemarch@gnu.org>

	* testsuite/poke.pkl/optcond-13.pk: New test.
	* testsuite/poke.pkl/optcond-14.pk: Likewise.
	* testsuite/poke.pkl/optcond-15.pk: Likewise.

2020-04-12  Jose E. Marchesi  <jemarch@gnu.org>

	* testsuite/poke.repl/repl.exp (tab-completion_type-1): New test.
	(tab-completion-var-1): Likewise.
	(tab-completion-fun-1): Likewise.

2020-04-12  Jose E. Marchesi  <jemarch@gnu.org>

	* testsuite/poke.repl/repl.exp (sigint-returns-to-prompt-2): New
	test.

2020-04-12  Jose E. Marchesi  <jemarch@gnu.org>

	* testsuite/poke.repl/repl.exp (slashes-are-preserved-1): Renamed
	from "slashes are preserved".
	(ctrl-c-returns-to-prompt-1): Remove.

2020-04-12  Jose E. Marchesi  <jemarch@gnu.org>

	* testsuite/lib/poke.exp (poke_send_signal): New proc.
	* testsuite/poke.repl/repl.exp (sigint-returns-to-prompt): New
	test.
	* testsuite/poke.repl/repl.exp (ctrl-c-returns-to-prompt):
	Likewise.
	* HACKING (Writing REPL tests): Document poke_send_signal.

2020-04-12  John Darrington <john@darrington.wattle.id.au>

	* doc/poke.texi:  Don't capitalise or indent "Where ..."

2020-04-12  John Darrington <john@darrington.wattle.id.au>

	* src/pk-set.c (set_completion_function): Fix bug which was
	exposed by recent test: tab-completion-subcommand-1.

2020-04-12  Jose E. Marchesi  <jemarch@gnu.org>

	* testsuite/poke.repl/repl.exp (tab-completion-subcommand-1): Use
	poke_send instead of poke_test_cmd.

2020-04-12  Jose E. Marchesi  <jemarch@gnu.org>

	* testsuite/lib/poke.exp (poke_exit): Make sure to discard any
	previous input before issuing the `exit' command.

2020-04-12  Jose E. Marchesi  <jemarch@gnu.org>

	* HACKING (Writing REPL tests): Mention poke_send.

2020-04-12  Jose E. Marchesi  <jemarch@gnu.org>

	* testsuite/lib/poke.exp (poke_send): New proc.
	* testsuite/poke.repl/repl.exp (tab-completion-2): New test.
	* HACKING (Command REPL tests): New subsection.
	(General REPL tests): Likewise.

2020-04-12  Jose E. Marchesi  <jemarch@gnu.org>

	* testsuite/lib/poke.exp (poke_test_cmd): Fail and return if poke
	has been killed.
	(poke_killed): New global.
	(poke_exit): Reset poke_killed whenever appropriate.

2020-04-12  Jose E. Marchesi  <jemarch@gnu.org>

	* testsuite/poke.repl/repl.exp (tab-completion-subcommand-1): New
	test

2020-04-12  Jose E. Marchesi  <jemarch@gnu.org>

	* testsuite/poke.repl/repl.exp: Rewrite tests to be more
	self-contained, and add some notes.
	* HACKING (Writing REPL tests): Updated.

2020-04-12  Jose E. Marchesi  <jemarch@gnu.org>

	* HACKING (Writing REPL tests): New section.

2020-04-12  Jose E. Marchesi  <jemarch@gnu.org>

	* testsuite/poke.repl/repl.exp (tab-completion-1): New test.

2020-04-10  Tim Rühsen  <tim.ruehsen@gmx.de>

	* lib/pkl.c (pkl_new): Return NULL instead of calling exit.
	* lib/pkl.h (pkl_new): Add function description.

2020-04-11  Jose E. Marchesi  <jemarch@gnu.org>

	* lib/Makefile.am (.pks.pkc): Cause make to stop with an error if
	ras fails.

2020-04-11  Bruno Haible  <bruno@clisp.org>

	Make 'git status' empty after "make distclean".
	* .gitignore: Ignore generated files that are distributed in the
	tarball.

2020-04-11  Bruno Haible  <bruno@clisp.org>

	Clean some generated files.
	* lib/Makefile.am: Delete pkl-tab.output during 'make mostlyclean'.
	* src/Makefile.am: Delete nodelist during 'make mostlyclean'.
	* .gitignore: Update accordingly.

2020-04-11  Jose E. Marchesi  <jemarch@gnu.org>

	* lib/Makefile.am (.pks.pkc): Remove partially generated .pks
	files when ras fails for some reason.

2020-04-11  Jose E. Marchesi  <jemarch@gnu.org>

	* lib/pk-utils.c: Include stdlib.h.

2020-04-11  Jose E. Marchesi  <jemarch@gnu.org>

	* lib/pvm.h (PVM_OK): Define.
	(PVM_ERROR): Likewise.
	* lib/pvm-val.c: Include pvm-program.h.
	* lib/pvm-program.h: Move program point definitions here from
	pvm.h.
	* lib/pvm-program.c (pvm_program_append_instruction): Return
	status codes.
	(pvm_program_append_label): Likewise.
	(pvm_program_append_label_parameter): Likewise.
	(pvm_program_append_register_parameter): Likewise.
	(pvm_program_append_unsigned_parameter): Liikewise.
	(pvm_program_append_val_parameter): Likewise.
	(pvm_program_append_push_instruction): Likewise.
	(pvm_program_make_executable): Likewise.

2020-04-11  Jose E. Marchesi  <jemarch@gnu.org>

	* HACKING: Updates on coding conventions.
	* lib/pvm.h (pvm_obase): Document.
	(pvm_set_obase): Likewise.
	(pvm_omode): Likewise.
	(pvm_set_omode): Likewise.
	(pvm_omaps): Likewise.
	(pvm_set_omaps): Likewise.
	(pvm_oindent): Likewise.
	(pvm_set_oindent): Likewise.
	(pvm_odepth): Likewise.
	(pvm_set_odepth): Likewise.
	(pvm_oacutoff): Likewise.
	(pvm_set_oacutoff): Likewise.
	(pvm_compiler): Likewise.
	(pvm_set_compiler): Likewise.
	(pvm_pretty_print): Likewise.
	(pvm_set_pretty_print): Likewise.
	(pvm_val_cls_program): New function.
	* lib/pvm-val.c (pvm_val_cls_program): Likewise.
	* src/pk-vm.c (pk_cmd_vm_disas_fun): Use pvm_val_cls_program
	instead of PVM_VAL_CLS_PROGRAM.
	(pk_cmd_vm_disas_map): Likewise.
	(pk_cmd_vm_disas_writ): Likewise.
	* lib/pvm-val.h: Reinstate.
	* lib/Makefile.am (libpoke_la_SOURCES): Add pvm-val.h.
	* lib/pkl.c: Include pvm-val.h
	* lib/pvm-program.c: Likewise.
	* lib/pvm-val.c: Likewise.
	* lib/pvm-alloc.c: Likewise.
	* lib/pvm.jitter: Likewise.
	* lib/pkl-gen.c: Likewise.

2020-04-10  Jose E. Marchesi  <jemarch@gnu.org>

	* HACKING (Avoid bool): New subsection.
	(Use _p for Predicates): Likewise.
	(Documenting Functions in Public Headers): Likewise.

2020-04-09  Tim Rühsen  <tim.ruehsen@gmx.de>

	* lib/pkl-ast.c (pkl_struct_type_traverse): Use
	non-destructive parsing without memory allocations.

2020-04-10  Jose E. Marchesi  <jemarch@gnu.org>

	* lib/pvm.jitter (strace): Use pvm_print_val_with_params instead
	of pvm_print_val.

2020-04-10  Jose E. Marchesi  <jemarch@gnu.org>

	* lib/pvm-val.c (pvm_sizeof): Fix for absent struct fields.

2020-04-10  Jose E. Marchesi  <jemarch@gnu.org>

	* lib/pkl-insn.def (nnn): New instruction.
	* lib/pvm.jitter (nnn): Likewise.
	* lib/pkl-gen.pks (struct_comparator): Support absent fields in
	structs.
	* testsuite/poke.pkl/eq-structs-10.pk: New test.
	* testsuite/poke.pkl/eq-structs-11.pk: Likewise.
	* testsuite/poke.pkl/eq-structs-12.pk: Likewise.

2020-04-10  Jose E. Marchesi  <jemarch@gnu.org>

	* doc/poke.texi (Dumping File Contents): Fix typos.

2020-04-09  Jose E. Marchesi  <jemarch@gnu.org>

	* testsuite/poke.pkl/optcond-12.pk: New test.

2020-04-09  Jose E. Marchesi  <jemarch@gnu.org>

	* testsuite/poke.pkl/eq-structs-9.pk: New test.

2020-04-09  Jose E. Marchesi  <jemarch@gnu.org>

	* lib/pkl-ast.h (struct pkl_ast_decl): New field `in_struct_p'.
	(PKL_AST_DECL_IN_STRUCT_P): Define.
	* lib/pkl-tab.y (struct_type_field_identifier): Annotate the
	declarations of struct fields as struct fields.
	* lib/pkl-gen.c (pkl_gen_ps_var): If the variable is a struct
	field, raise E_elem if we get null as its value.
	* lib/pkl-gen.pks (struct_constructor): Amend the regvar to
	install null as the value of field-variables.
	(struct_mapper): Likewise.
	(struct_field_mapper): Likewise.
	* testsuite/poke.pkl/optcond-5.pk: Amend.
	* testsuite/poke.pkl/sref-4.pk: Likewise.
	* testsuite/poke.map/map-optcond-6.pk: Likewise.
	* testsuite/poke.map/map-optcond-7.pk: Likewise.
	* testsuite/poke.pkl/optcond-6.pk: New test.
	* testsuite/poke.pkl/optcond-7.pk: Likewise.
	* testsuite/poke.pkl/optcond-8.pk: Likewise.
	* testsuite/poke.pkl/optcond-9.pk: Likewise.
	* testsuite/poke.map/map-optcond-9.pk: Likewise.
	* testsuite/poke.pkl/optcond-11.pk: Likewise.
	* testsuite/poke.map/map-optcond-11.pk: Likewise.
	* testsuite/poke.pkl/optcond-10.pk: Likewise.
	* testsuite/poke.map/map-optcond-10.pk: Likewise.

2020-04-09  Tim Rühsen  <tim.ruehsen@gmx.de>

	* src/pk-repl.c: Include xstrndup.h.
	(poke_getc): Use xstrndup instead of xzmalloc+strncpy.

2020-04-09  Jose E. Marchesi  <jemarch@gnu.org>

	* lib/pvm-val.c (pvm_print_val_1): Remove trailing whitespaces.

2020-04-09  Jose E. Marchesi  <jemarch@gnu.org>

	* lib/pvm.h: Note that if both NAME and VALUE are PVM_NULL in a
	struct field, the field is absent.
	* lib/pvm-val.c (pvm_sizeof): Be aware of absent fields.
	(pvm_print_val_1): Likewise.
	(pvm_elemsof): Likewise.
	(pvm_ref_struct): Return NULL if the referred field is absent.
	* lib/pkl-gen.pks (struct_constructor): Support optional fields.
	(struct_mapper): Likewise.
	(struct_field_mapper): Likewise.
	(struct_field_writer): Likewise.
	* lib/pkl-insn.def (srefia): New instruction.
	* lib/pvm.jitter (srefia): Likewise.
	* testsuite/poke.pkl/attr-length-8.pk: New test.
	* testsuite/poke.pkl/sref-3.pk: Likewise.
	* testsuite/poke.pkl/sref-4.pk: Likewise.
	* testsuite/poke.map/map-opcond-write-1.pk: Likewise.

2020-04-09  Jose E. Marchesi  <jemarch@gnu.org>

	* lib/pvm-env.c: Include string.h
	* lib/pkl-gen.c: Remove spurious XXX marks.

2020-04-09  Jose E. Marchesi  <jemarch@gnu.org>

	* lib/pkl-ast.h (PKL_AST_FUNC_NARGS): Define.
	* lib/pkl-ast.c (pkl_ast_print_1): Print the nargs attribute of
	func nodes.
	* lib/pkl-trans.c (pkl_trans1_ps_func): Count the number of formal
	arguments.
	* lib/pkl-gen.c (pkl_gen_pr_func): Do not count arguments and
	provide a hint with the number of formals to pushf.

2020-04-09  Jose E. Marchesi  <jemarch@gnu.org>

	* lib/pkl-ast.h (PKL_AST_COMP_STMT_NUMVARS): Define.
	* lib/pkl-ast.c (pkl_ast_print_1): Print the numvars attribute of
	comp_stmt nodes.
	* lib/pkl-trans.c (pkl_trans1_ps_comp_stmt): New handler.
	(pkl_phase_trans1): Register handler.
	* lib/pkl-gen.c (pkl_gen_pr_comp_stmt): Pass the number of
	variables defined in the compound statement as a hint to pushf.

2020-04-09  Jose E. Marchesi  <jemarch@gnu.org>

	* lib/pkl-insn.def (pushf): Get a numeric argument.
	* lib/pvm.jitter (pushf): Likewise.
	* lib/pvm.h (pvm_env_new): Get a `hint' argument.
	(pvm_env_push_frame): Likewise.
	* lib/pvm-env.c	(pvm_env_new): Likewise.
	(pvm_env_push_frame): Likewise.
	(pvm_env_register): Allocate new space for entries as needed.
	* lib/pvm.c (pvm_init): Pass a hint to pvm_env_new.
	* lib/pkl-asm.pks: Add hints to pushf instructions.
	* lib/pkl-gen.c: Likewise.
	* lib/pkl-gen.pks: Likewise.

2020-04-09  Tim Rühsen  <tim.ruehsen@gmx.de>

	* lib/pk-utils.h: Add declaration of pk_str_replace.
	* lib/pk-utils.c: Add implementation of pk_str_replace.
	* lib/pkl.c (pkl_resolve_module): Make use of pk_str_replace.

2020-04-09  Tim Rühsen  <tim.ruehsen@gmx.de>

	* lib/pkl.c (pkl_resolve_module): Use non-destructive parsing.

2020-04-09  Jose E. Marchesi  <jemarch@gnu.org>

	* doc/poke.texi (Load Path): Mention POKE_LOAD_PATH.

2020-04-09  Jose E. Marchesi  <jemarch@gnu.org>

	* lib/pkl.c (pkl_load): New function.
	(pkl_resolve_module): Likewise.
	* lib/pkl-tab.y (load_module): Use pkl_resolve_module.
	* src/pk-cmd.c (pk_cmd_init): Likewise.
	* src/poke.c (poke_cmdsdir): Remove.
	(initialize): Do not initialize poke_cmdsdir.
	* run.in (POKECMDSDIR): Do not set POKECMDSDIR.

2020-04-08  Jose E. Marchesi  <jemarch@gnu.org>

	* lib/pvm-val.c (pvm_sizeof): Return zero for type values.

2020-04-08  Jose E. Marchesi  <jemarch@gnu.org>

	* lib/pkl-asm.c (pkl_asm_insn): Clarify the situation on 32-bit
	and add an assert.

2020-04-08  Jose E. Marchesi  <jemarch@gnu.org>

	* lib/pkl-diag.h: Really add file in git, grrr.
	* lib/pkl-diag.c: Likewise.

2020-04-08  Jose E. Marchesi  <jemarch@gnu.org>

	* lib/Makefile.am (libpoke_la_SOURCES): Add pkl_diag.h and
	pkl_diag.c.
	* lib/pkl-diag.h: New file.
	(pkl_error): Moved from pkl.h.
	(pkl_warning): Likewise.
	(pkl_ice): Likewise.
	* lib/pkl-diag.c: New file.
	(pkl_detailed_location): Moved from pkl.c.
	(pkl_error_internal): Likewise.
	(pkl_error): Likewise.
	(pkl_warning): Likewise.
	* lib/pkl-anal.c: Include pkl-diag.h.
	* lib/pkl-pass.h: Likewise.
	* lib/pkl-typify.c: Likewise.
	* lib/pkl-trans.c: Likewise.
	* lib/pkl-tab.y: Likewise.
	* lib/pkl-fold.c: Likewise.
	* lib/pkl-lex.l: Likewise.
	* HACKING (The Source Tree): Add pkl_diag.h and pkl_diag.c.

2020-04-08  Tim Rühsen  <tim.ruehsen@gmx.de>

	* bootstrap.conf: Add gnulib module pathmax.
	* src/pk-editor.c: Include pathmax.h.

2020-04-08  Jose E. Marchesi  <jemarch@gnu.org>

	* lib/pvm-val.c (pvm_print_val_1): Use default printer if no
	pretty-printer is available in structs, even if pretty-print is
	`yes'.

2020-04-08  Jose E. Marchesi  <jemarch@gnu.org>

	* src/Makefile.am (poke_CFLAGS): Remove LIBNBD_CFLAGS.
	(poke_LDADD): Remove LIBNBD_LIBS.
	* lib/Makefile.am (libpoke_la_CFLAGS): Add LIBNBD_CFLAGS.
	(libpoke_la_LIBADD): Add LIBNBD_LIBS.

2020-04-08  Jose E. Marchesi  <jemarch@gnu.org>

	* lib/pvm-program.c: Remove trailing whitespaces.

2020-04-08  Tim Rühsen  <tim.ruehsen@gmx.de>

	* src/pk-cmd.c (pk_cmd_get_next_match): Fix endless loop
	introduced in commit c576c04c3.

2020-04-07  Jose E. Marchesi  <jemarch@gnu.org>

	* The big lib-ization.

2020-04-06  Jose E. Marchesi  <jemarch@gnu.org>

	* run.in (POKEDATADIR): Point to lib.
	* src/Makefile.am (poke_LDADD): Link with libpoke.
	* configure.ac: Add lib/Makefile to AC_CONFIG_FILES.
	* Makefile.am (SUBDIRS): Add lib.

2020-04-07  Tim Rühsen  <tim.ruehsen@gmx.de>

	* src/pkl-fold.c (OP_BINARY_SSS): Use pk_str_concat instead of
	strlen/xmalloc/strcpy/strcat.
	* src/pkl.c (pkl_new): Likewise.

2020-04-06  Tim Rühsen  <tim.ruehsen@gmx.de>

	* src/poke.c (initialize): Use pk_str_concat instead of
	strlen/xmalloc/strcpy/strcat.
	(initialize_user): Likewise.

2020-04-06  Tim Rühsen  <tim.ruehsen@gmx.de>

	* bootstrap.conf: Add gnulib module stdarg.
	* src/pk-utils.h: Declaration of pk_str_concat.
	* src/pk-utils.c: Implementation of pk_str_concat.

2020-04-06  Tim Rühsen  <tim.ruehsen@gmx.de>

	* src/pkl-tab.y (load_module): Fix check for empty string.
	* src/poke.c (initialize_user): Likewise.

2020-04-06  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pvm-val.c (pvm_print_val_1): Update to new interface.
	(pvm_print_val): Use new pvm_print_val_1 interface.
	(pvm_print_val_with_params): New function.
	Do not include poke.h
	(pvm_call_pretty_printer): Get a vm argument and use it instead of
	poke_vm.
	* src/pvm.h (PVM_PRINT_F_PPRINT): Define.
	(PVM_PRINT_F_GET_PPRINT): Likewise.
	(pvm_print_val): Moved from pvm-val.h
	(pvm_obase): New function.
	(pvm_set_obase): Likewise.
	* src/pvm.c (pvm_init): Initialize PVM_STATE_VM.
	(PVM_STATE_VM): Define.
	(PVM_STATE_OBASE): Likewise.
	(pvm_obase): New function.
	(pvm_set_obase): Likewise.
	* src/pk-cmd.c (pk_cmd_exec): Adapt to new interface.
	* src/pvm.jitter (pvm_literal_printer): Likewise.

2020-04-04  Tim Rühsen  <tim.ruehsen@gmx.de>

	* bootstrap.conf: Add gnulib module strchrnul.
	* src/pkl-trans.c: Include string.h and xstrndup.h.
	(pkl_trans1_ps_print_stmt): Code cleanup using strchrnul.

2020-04-05  Jose E. Marchesi  <jemarch@gnu.org>

	* doc/poke.texi (Load Path): Add an example on updating the
	load_path.
	(pokerc): Document the support for the XDG base directory
	specification.

2020-04-05  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-promo.c (pkl_promo_ps_op_binary_intoffstrarr): Renamed
	from pkl_promo_op_binary_intoffstr.
	Do not promote array arguments.
	* src/pkl-typify.c (TYPIFY_BIN): Add a case CASE_ARRAY.
	(CASE_ARRAY): Define.
	* src/pkl-gen.c (pkl_gen_ps_op_add): Handle array operands.
	* src/pkl-insn.def (PKL_INSN_ACONC): New macro-instruction.
	* src/pkl-asm.c (pkl_asm_insn_aconc): Define.
	(pkl_asm_insn): Handle PKL_INSN_ACONC.
	* doc/poke.texi (Array Concatenation): New section.
	* testsuite/poke.pkl/add-arrays-diag-1.pk: New test.
	* testsuite/poke.pkl/add-arrays-diag-2.pk: Likewise.
	* testsuite/poke.pkl/add-arrays-diag-3.pk: Likewise.
	* testsuite/poke.pkl/add-arrays-3.pk: Likewise.
	* testsuite/poke.pkl/add-arrays-2.pk: Likewise.
	* testsuite/poke.pkl/add-arrays-1.pk: Likewise.

2020-04-05  Jose E. Marchesi  <jemarch@gnu.org>

	* src/poke.c (initialize_user): Use `poke' subdirectories in the
	XDG config dirs.

2020-04-05  Jose E. Marchesi  <jemarch@gnu.org>

	* src/poke.c (initialize_user): Acknowledge XDG configuration
	files if ~/.pokerc is not found.

2020-04-05  Jose E. Marchesi  <jemarch@gnu.org>

	* src/std.pk (atoi): Raise E_inval instead of E_generic when the
	provided base is not supported.
	* doc/poke.texi (atoi): Update accordingly.
	* testsuite/poke.std/atoi-14.pk: New test.

2020-04-05  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-rt.pk: Further simplifications.

2020-04-05  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-rt.pk: Simply the setting of load_path.

2020-04-05  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl.h (pkl_get_vm): New prototype.
	* src/pkl.c (pkl_get_vm): New function.
	* src/pkl-rt.pk: Define load_path and compute its initial value.
	* src/pkl-tab.y: Do not include poke.h.
	(load_module): Use load_path to locate modules.
	* doc/poke.texi (Load Path): New section.

2020-04-05  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-gen.c: Remove trailing blanks.
	* src/pkl-tab.y: Likewise.

2020-04-05  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-ast.h (PKL_AST_BUILTIN_GETENV): Define.
	* src/pkl-tab.y (BUILTIN_GETENV): New token.
	(builtin): Add rule for getenv.
	* src/pkl-lex.l: Recognize __PKL_BUILTIN_GETENV__ tokens.
	* src/pkl-gen.c (pkl_gen_ps_comp_stmt): Implement the getenv
	builtin.
	* src/pkl-insn.def (PKL_INSN_GETENV): Define.
	* src/Makefile.am (libpvmjitter_a_CPPFLAGS): Define _GNU_SOURCE.
	* src/pvm.jitter (getenv): New instruction.
	* src/pvm.h (PVM_E_INVAL): Define.
	(PVM_E_INVAL_MSG): Likewise.
	* src/pkl-rt.pk (getenv): Define.
	(EC_inval): Likewise.
	(E_inval): Likewise.
	* doc/poke.texi (System): New section.
	(getenv): New subsection.
	* testsuite/poke.pkl/getenv-1.pk: New test.
	* testsuite/poke.pkl/getenv-2.pk: Likewise.

2020-04-04  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl.h (pkl_new): New argument `vm'.
	(pkl_quiet_p): New prototype.
	(pkl_set_quiet_p): Likewise.
	(pkl_ice): Get an argument `compiler'.
	* src/pkl.c (struct pkl_compiler): New fields `vm' and `quiet_p'.
	(pkl_new): Get a VM as an argument.
	(pkl_compile_buffer): Use the compiler's vm instead of the global
	poke_vm.
	(pkl_compile_statement): Likewise.
	(pkl_compile_file): Likewise.
	Do not include poke.h.
	(rest_of_compilation): Do not use poke_compiler.
	(rest_of_compilation): Likewise.
	(rest_of_compilation): Likewise.
	(pkl_new): Initialize quiet_p;
	(pkl_quiet_p): Define.
	(pkl_set_quiet_p): Likewise.
	(pkl_error_internal): Do not use poke_quiet_p.
	(pkl_warning): Likewise.
	(pkl_ice): Likewise.
	* src/poke.c (initialize): Pass the PVM and poke_datadir when
	initializing the compiler.
	(parse_args): Set compiler verbosity when processing QUIET_ARG.
	* src/pkl-pass.h (PKL_ICE): Define.
	* src/pkl-anal.c (pkl_anal1_ps_comp_stmt): Use PKL_ICE instead of
	pkl_ice.
	(pkl_anal_ps_default): Likewise.
	(pkl_anal2_ps_checktype): Likewise.
	(pkl_anal2_ps_checktype): Likewise.
	(pkl_anal2_ps_offset): Likewise.
	(pkl_analf_ps_array_initializer): Likewise.
	* src/pkl-typify.c (pkl_typify1_ps_var): Likewise.
	(pkl_typify1_ps_attr): Likewise.
	* src/pkl-promo.c (pkl_promo_ps_op_div): Likewise.
	(pkl_promo_ps-op_binary_intoffstr): Likewise.
	(pkl_promo_ps_op_mul): Likewise.
	(pkl_promo_ps_op_rela): Likewise.
	(pkl_promo_ps_op_bshiftpow): Likewise.
	(pkl_promo_ps_op_binary): Likewise.
	(pkl_promo_ps_op_unary): Likewise.
	(pkl_promo_ps_indexer): Likewise.
	(pkl_promo_ps_trimmer): Likewise.
	(pkl_promo_ps_type_array): Likewise.
	(pkl_promo_ps_ass_stmt): Likewise.
	(pkl_promo_ps_funcall): Likewise.
	(pkl_promo_ps_return_stmt): Likewise.
	(pkl_promo_ps_print_stmt): Likewise.
	(pkl_promo_ps_func_arg): Likewise.
	(pkl_promo_ps_map): Likewise.
	(pkl_promo_ps_cond_exp): Likewise.
	* src/pkl-gen.c (pkl_gen_ps_op_attr): Likewise.
	(pkl_gen_noimpl): Likewise.
	* src/pkl-lex.l (YY_FATAL_ERROR): Pass extra->compiler to pkl_ice.

2020-04-04  Tim Rühsen  <tim.ruehsen@gmx.de>

	* src/pkl-trans.c (pkl_trans1_ps_string): Avoid malloc if string
	does not need escaping.

2020-04-04  Bruno Haible  <bruno@clisp.org>

	doc: Tweak formatting of ASCII table.
	* doc/poke.texi (Table of ASCII Codes): Use TeXinfo markup. Use a single
	table, not two tables.

2020-04-04  Jose E. Marchesi  <jemarch@gnu.org>

	* HACKING (Building Release Tarballs): New section.

2020-04-04  Bruno Haible  <bruno@clisp.org>

	Fix 'make distcheck'.
	* doc/Makefile.am (EXTRA_DIST): New variable.

2020-04-03  Tim Rühsen  <tim.ruehsen@gmx.de>

	* src/pkl-asm.c (pkl_asm_insn):
	Remove obsolete code.

2020-04-04  Jose E. Marchesi  <jemarch@gnu.org>

	* doc/poke.texi (Pickles): Note how pickles can load other
	pickles.

2020-04-04  Jose E. Marchesi  <jemarch@gnu.org>

	* doc/poke.texi (Pickles): New section.

2020-04-03 Tim Rühsen  <tim.ruehsen@gmx.de>

	* src/pk-cmd.c (skip_blanks): Take const char *,
	return const char *.
	(pk_atoi): Add const to p.
	(pk_cmd_exec_1): Add const to str param and to several vars.
	(pk_cmd_exec): Add const to param and several vars,
	use cmd_alloc for allocation.
	* src/pk-cmd.h (pk_cmd_exec): Add const to param.
	* pkl-parser.c (pkl_parse_buffer): Add const to 'buffer'
	and 'end'.
	* src/pkl-parser.h (pkl_parse_buffer): Likewise.
	* src/pkl.c (pkl_compile_buffer): Add const to 'buffer'
        and 'end'.
	(pkl_compile_statement): Likewise.
	(pkl_compile_expression): Likewise.
	* src/pkl.h (pkl_compile_buffer): Add const to 'buffer'
	and 'end'.
	(pkl_compile_statement): Likewise.
	(pkl_compile_expression): Likewise.

2020-04-03  Jose E. Marchesi  <jemarch@gnu.org>

	* doc/poke.texi (Poking Bytes): Improve wording.

2020-04-03  Jose E. Marchesi  <jemarch@gnu.org>

	* doc/poke.texi (Weird Integers): Fix typo.
	(From Bytes to Integers): Likewise.
	(Defining Types): Add a mention to the poke standard library.

2020-04-03  Jose E. Marchesi  <jemarch@gnu.org>

	* doc/poke.texi (Modifying SBM Images): Fix sectioning of a
	subsection.
	(Defining Types): Renamed from `Named Types'.
	(Defining Types): Add contents.

2020-04-03  Jose E. Marchesi  <jemarch@gnu.org>

	* src/ios-dev-file.c (ios_dev_file_pread): Fix type of variable.
	(ios_dev_file_pwrite): Likewise.
	* src/pk-cmd.c (pk_cmd_exec_1): Likewise.
	* src/pvm.jitter (aref): Remove unneeded check.

2020-04-03  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pk-dump.pk (dump): Avoid generating a spurious blank
	character after the ASCII ruler.

2020-04-03 Tim Rühsen  <tim.ruehsen@gmx.de>

        * src/pk-set.c (set_completion_function):
        Remove superfluous malloc within loop.

2020-04-03 Tim Rühsen  <tim.ruehsen@gmx.de>

        * src/pk-repl.c (pk_repl):
        Simplify malloc/strlen/strcpy/strcat with asprintf.

2020-04-03 Tim Rühsen  <tim.ruehsen@gmx.de>

	* src/pk-repl.c (pkl_complete_struct):
	Remove superfluous malloc within loop.

2020-04-03  Jose E. Marchesi  <jemarch@gnu.org>

	* doc/Makefile.am (AM_MAKEINFOHTMLFLAGS): Define.
	(html-local): Refine the generated html files.

2020-04-03 Tim Rühsen  <tim.ruehsen@gmx.de>

	* src/pk-ios.c (pk_cmd_mem): Fix memleak.

2020-04-03 Tim Rühsen  <tim.ruehsen@gmx.de>

	* src/pk-ios.c (pk_cmd_mem):
	Simplify malloc/strlen/strcpy/strcat with asprintf.

2020-04-03 Tim Rühsen  <tim.ruehsen@gmx.de>

	* src/pk-ios.c (pk_cmd_load_file):
	Simplify malloc/strlen/strcpy/strcat with asprintf.

2020-04-03 Tim Rühsen  <tim.ruehsen@gmx.de>

	* src/pk-ios.c (pk_cmd_load_file): Fix reading file from
	POKEDATADIR.

2020-04-03  Jose E. Marchesi  <jemarch@gnu.org>

	* doc/poke.texi: Sectioning changes.

2020-04-03  Jose E. Marchesi  <jemarch@gnu.org>

	* doc/poke.texi: Sectioning changes.

2020-04-03 Tim Rühsen  <tim.ruehsen@gmx.de>

	* src/pk-cmd.c (pk_cmd_get_next_match):
	Remove superfluous malloc within loop.

2020-04-03  Jose E. Marchesi  <jemarch@gnu.org>

	* doc/poke.texi: syntax-check fixes.

2020-04-03  Jose E. Marchesi  <jemarch@gnu.org>

	* doc/poke.texi (Modifying SBM Images): Updated to cover mapped
	vs. non-mapped values.

2020-04-02  Jose E. Marchesi  <jemarch@gnu.org>

	* doc/poke.texi (Modifying SBM Images): Renamed from `Cropping SBM
	Images'.

2020-04-03 Tim Rühsen  <tim.ruehsen@gmx.de>

	* src/pk-cmd.c (pk_cmd_init):
	Simplify malloc/strlen/strcpy/strcat with asprintf.

2020-04-02 Tim Rühsen  <tim.ruehsen@gmx.de>

	* src/pk-hserver.c (pk_hserver_make_hyperlink):
	Simplify malloc/strlen/strcpy/strcat with asprintf.
	(pk_hserver_init): Remove writing to hserver_port_str.
	(hserver_port_str): Remove variable.

2020-04-02  Jose E. Marchesi  <jemarch@gnu.org>

	* doc/poke.texi: Flatten the sectioning, removing superfluous
	nodes containing only menus.

2020-04-02  Jose E. Marchesi  <jemarch@gnu.org>

	* HACKING (The Bugzilla): New section.
	(Dealing with spam in the Bugzilla): Likewise.

2020-04-02 Tim Rühsen  <tim.ruehsen@gmx.de>

	* bootstrap.conf: Add gnulib module stdbool.

2020-04-02 Tim Rühsen  <tim.ruehsen@gmx.de>

	* src/pk-hserver.c (hserver_tokens): Fix type to bool.

2020-04-02 Tim Rühsen  <tim.ruehsen@gmx.de>

	* bootstrap.conf: List gnulib modules in alphabetical order.

2020-04-02 Tim Rühsen  <tim.ruehsen@gmx.de>

	* src/pk-cmd.c (pk_cmd_exec): Reduce memory allocations.

2020-04-02 Tim Rühsen  <tim.ruehsen@gmx.de>

	* src/pkl-parser.c (pkl_parse_buffer): Add const to buffer param.
	* src/pkl-parser.h (pkl_parse_buffer): Likewise.

2020-04-02  Jose E. Marchesi  <jemarch@gnu.org>

	* doc/poke.texi (Poking a SBM Image): Expanded.
	(Cropping SBM Images): New section.

2020-04-02  Jose E. Marchesi  <jemarch@gnu.org>

	* doc/poke.texi (The SBM Format): Do not use @acronym{}.

2020-04-02  Jose E. Marchesi  <jemarch@gnu.org>

	* doc/poke.texi (Poking Arrays): New section.
	(The SBM Format): New subsection.
	(Poking a SBM Image): Likewise.

2020-04-01  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-gen.c (pkl_gen_ps_decl): Complete assert expression.

2020-04-01  Jose E. Marchesi  <jemarch@gnu.org>

	* pickles/bmp.pk (IHS_BMP_V2): Define.
	(IHS_BMP_V3): Likewise.
	(BMP_Info_Header): Allow info_header_size to be any of the
	supported IHS_* values.
	(BMP_Header): Fix the size of the reserved fields.

2020-04-01  Jose E. Marchesi  <jemarch@gnu.org>

	* pickles/Makefile.am (dist_pkgdata_DATA): Add bmp.pk.

2020-04-01  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-gen.pks (struct_constructor): Fix handling of anonymous
	fields.
	* testsuite/poke.pkl/scons-54.pk: New test.

2020-04-01  Jose E. Marchesi  <jemarch@gnu.org>

	* testsuite/poke.map/maps-arrays-16.pk: Add missing semicolon.

2020-04-01  Jose E. Marchesi  <jemarch@gnu.org>

	* pickles/bmp.pk: Moved from future/ and translated to actual
	Poke.

2020-04-01  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-trans.c (pkl_trans2_ps_struct_ref): Set the type of the
	newly inserted funcall, since typify1 happens before trans2.
	* testsuite/poke.pkl/struct-method-1.pk: New test.

2020-04-01  Jose E. Marchesi  <jemarch@gnu.org>

	* etc/git-hooks/pre-push: Try to locate top_builddir and jump
	there before executing make targets.

2020-04-01  Jose E. Marchesi  <jemarch@gnu.org>

	* doc/poke.texi (Debugging Poke Programs): Relocated.

2020-04-01  Tim Rühsen  <tim.ruehsen@gmx.de>

	* .x-sc_space_tab: Remove wildcards, list single files.
	* src/ios.c: Replace indenting tabs by 8 spaces each.
	* src/pk-cmd.c: Likewise.
	* src/pk-editor.c: Likewise.
	* src/pk-info.c: Likewise.
	* src/pk-ios.c: Likewise.
	* src/pk-misc.c: Likewise.
	* src/pk-repl.c: Likewise.
	* src/pk-set.c: Likewise.
	* src/pk-utils.c: Likewise.
	* src/pkl-env.c: Likewise.
	* src/pkl-env.h: Likewise.
	* src/pkl-gen.pks: Likewise.

2020-04-01  Tim Rühsen  <tim.ruehsen@gmx.de>

	* HACKING: Mention pre-push git hook in Maintenance section.
	* etc/git-hooks/pre-push: New file, pre-push git hook.

2020-04-01  Jose E. Marchesi  <jemarch@gnu.org>

	* doc/poke.texi (From Bytes to Characters): New section.
	(Buffers as IO Spaces): Likewise.
	(Saving Buffers in Files): Likewise.
	(Copying Bytes): Likewise.
	(copy): The to_ios argument defaults to the current IOS, no
	from_ios.

2020-04-01  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pk-copy.pk (copy): to_ios defaults to the current IO space.

2020-03-31  Tim Rühsen  <tim.ruehsen@gmx.de>

	* doc/poke.texi: Remove trailing spaces.

2020-03-31  Jose E. Marchesi  <jemarch@gnu.org>

	* doc/poke.texi (Big and Little Endians): New section.
	(Negative Integers): Likewise.
	(Weird Integers): Likewise.
	(Unaligned Integers): Likewise.
	(Integers of Different Sizes): Likewise.

2020-03-30  Jose E. Marchesi  <jemarch@gnu.org>

	* doc/poke.texi (Binary Files): New section.
	(Dumping File Contents): Improved.
	(Working with Bytes): Likewise.

2020-03-30  Tim Rühsen  <tim.ruehsen@gmx.de>

	* INSTALL: Remove from repository.
	* .gitignore: Add /INSTALL.

2020-03-29  Tim Rühsen  <tim.ruehsen@gmx.de>

	* bootstrap.conf: Add gnulib module xstrndup.
	* src/pk-cmd.c (pk_cmd_exec_1): Fix code to use xstrndup.

2020-03-29  Tim Rühsen  <tim.ruehsen@gmx.de>

	* src/pk-cmd.c (skip_blanks): Remove superfluous check.

2020-03-29  Jose E. Marchesi  <jemarch@gnu.org>

	* doc/poke.texi: Change the sectioning and add a detailed menu.
	* doc/gen-pvm-insns.sh: Adapt accordingly.

2020-03-29  Jose E. Marchesi  <jemarch@gnu.org>

	* doc/poke.texi (basic Editing): New chapter.

2020-03-29  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-typify.c (pkl_typify1_ps_cast): Allow casts from structs
	to structs.
	* src/pkl-gen.c (pkl_gen_ps_cast): Support struct-to-struct casts.
	* doc/poke.texi (Casting Structs): New section.
	* testsuite/poke.pkl/cast-struct-1.pk: New test.
	* testsuite/poke.pkl/cast-struct-4.pk: Likewise.
	* testsuite/poke.pkl/cast-struct-3.pk: Likewise.
	* testsuite/poke.pkl/cast-struct-2.pk: Likewise.
	* testsuite/poke.pkl/csat-struct-6.pk: Likewise.
	* testsuite/poke.pkl/cast-struct-5.pk: Likewise.

2020-03-29  John Darrington <john@darrington.wattle.id.au>

	*doc/poke.texi: Miscellaneous minor fixes.

2020-03-29  Jose E. Marchesi  <jemarch@gnu.org>

	* doc/Makefile.am (pvm-insns.texi): New rule.
	(poke_TEXINFOS): Add pvm-insns.texi.
	* doc/gen-pvm-insns.sh: New file.
	* src/pvm.jitter: Document instructions.
	* doc/poke.texi (PVM Instructions): New chapter.

2020-03-28  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-parser.h (struct pkl_parser): New field `bootstrapped'.
	* src/pkl-parser.c (pkl_parse_file): Set parser->bootstrapped.
	(pkl_parse_buffer): Likewise.
	(pkl_parser_init): Initialize parser->bootstrapped.
	* src/pkl-lex.l: Do not acknowledge built-in identifiers if the
	compiler has been already bootstrapped.
	* testsuite/poke.pkl/builtins-1.pk: New test.

2020-03-28  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-typify.c (pkl_typify1_ps_var): Turn assert into ICE.
	* src/pk-def.c: Do not include stdio.h.
	(print_var_decl): Pass poke_obase to pvm_print_val.

2020-03-28  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-typify.c (pkl_typify1_ps_op_in): Remove unneeded check.
	* testsuite/poke.pkl/in-4.pk: Renamed from in-diag-4.pk and
	adapted.
	* testsuite/poke.pkl/in-5.pk: New test.
	* testsuite/poke.pkl/in-6.pk: Likewise.
	* testsuite/poke.pkl/in-7.pk: Likewise.

2020-03-28  Jose E. Marchesi  <jemarch@gnu.org>

	* src/poke.h: New extern for poke_hserver_p.
	* src/poke.c: New global poke_hserver_p.
	(initialize): Initialize poke_hserver_p.
	(finalize): Use poke_hserver_p.
	* src/pk-repl.c (banner): Print `hserver listening..' only if the
	hyperserver is used.

2020-03-28  Jose E. Marchesi  <jemarch@gnu.org>

	* HACKING (Loop Statements): New subsection.

2020-03-28  Jose E. Marchesi  <jemarch@gnu.org>

	BZ 25395
	* src/pkl-ast.h (enum pkl_ast_code): New value
	PKL_AST_LOOP_STMT_ITERATOR.
	(struct pkl_ast_loop_stmt_iterator): Define.
	(PKL_AST_LOOP_STMT_ITERATOR_DECL): Define.
	(PKL_AST_LOOP_STMT_ITERATOR_CONTAINER): Likewise.
	(PKL_AST_LOOP_STMT_ITERATOR): Likewise.
	* src/pkl-ast.c (pkl_ast_make_loop_stmt_iterator): New function.
	(pkl_ast_node_free): Update to new topology.
	(pkl_ast_finish_breaks_1): Likewise.
	(pkl_ast_finish_returns_1): Likewise.
	(pkl_ast_print_1): Likewise.
	* src/pkl-pass.c (pkl_do_pass_1): Likewise.
	* src/pkl-gen.c (pkl_gen_pr_loop_stmt): Likewise.
	* src/pkl-typify.c (pkl_typify1_ps_loop_stmt_iterator): Renamed from
	pkl_typify1_pr_loop_stmt.
	* testsuite/poke.pkl/while-1.pk: New test.

2020-03-28  Jose E. Marchesi  <jemarch@gnu.org>

	* src/Makefile.am: the .pkc files depend on pkl-insn.def.

2020-03-28  Jose E. Marchesi  <jemarch@gnu.org>

	* testsuite/poke.pkl/field-init-8.pk: New test.

2020-03-28  Jose E. Marchesi  <jemarch@gnu.org>

	* pickles/ctf.pk (CTF_Preamble): Use field initialization.

2020-03-27  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-ast.c (pkl_ast_make_struct_type_field): Handle
	initializer.
	(pkl_ast_dup_type): Likewise.
	(pkl_ast_node_free): Likewise.
	(pkl_ast_print_1): Likewise.
	* src/pkl-ast.h (PKL_AST_EXP_FLAG): Define.
	(PKL_AST_STRUCT_TYPE_FIELD_INITIALIZER): Define.
	(struct pkl_ast_struct_type_field): New field `initializer'.
	* src/pkl-tab.y (struct_type_field_constraint_or_init): Renamed
	from struct_type_field_constraint.
	* src/pkl-pass.c (pkl_do_pass_1): Traverse struct field
	initializers.
	* src/pkl-typify.c (pkl_typify1_ps_struct): Pass a NULL
	initializer when constructing a struct type field.
	(pkl_typify1_ps_struct_type_field): Check the type of the field
	initializer, if specified.
	* src/pkl-promo.c (pkl_promo_ps_struct_type_field): Promote field
	initializers.
	* src/pkl-gen.pks (struct_constructor): Use field initializers.
	* pickles/elf.pk (Elf64_Ehdr): Use an initialization value for the
	magic field.
	* doc/poke.texi (Field Initializers): New section.
	* testsuite/poke.pkl/field-init-diag-1.pk: New test.
	* testsuite/poke.pkl/field-init-diag-2.pk: Likewise.
	* testsuite/poke.pkl/field-init-diag-3.pk: Likewise.
	* testsuite/poke.pkl/field-init-1.pk: Likewise.
	* testsuite/poke.pkl/field-init-2.pk: Likewise.
	* testsuite/poke.pkl/field-init-3.pk: Likewise.
	* testsuite/poke.pkl/field-init-diag-4.pk: Likewise.
	* testsuite/poke.map/maps-structs-init-1.pk: Likewise.
	* testsuite/poke.map/maps-structs-init-2.pk: Likewise.
	* testsuite/poke.pkl/field-init-4.pk: Likewise.
	* testsuite/poke.pkl/field-init-7.pk: Likewise.
	* testsuite/poke.pkl/field-init-6.pk: Likewise.
	* testsuite/poke.pkl/field-init-5.pk: Likewise.

2020-03-27  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-ast.h (struct pkl_ast_type): New field `comparator' for
	structs.
	(PKL_AST_TYPE_S_COMPARATOR): Define.
	* src/pkl-ast.c (pkl_ast_make_struct_type): Initialize the struct
	type comparator closure, and add it as a GC root.
	(pkl_ast_node_free): Deregister the struct type comparator as a GC
	root.
	* src/pkl-typify.c (pkl_typify1_ps_op_rela): Accept struct
	operands in EQ and NE operators.
	* src/pkl-promo.c (pkl_promo_ps_op_rela): Likewise.
	* src/pkl-gen.h (struct pkl_gen_payload): New field
	`in_comparator'.
	* src/pkl-gen.c (pkl_gen_ps_op_rela): Likewise.
	(pkl_gen_pr_decl): Build comparator closures for named struct
	types.
	(pkl_gen_pr_type_struct): Handle in_comparator contexts.
	* src/pkl-asm.c (pkl_asm_insn_cmp): Handle structs.
	* src/pkl-gen.pks (struct_comparator): New RAS function.
	* doc/poke.texi (Struct Comparison): New section.
	* testsuite/poke.pkl/eq-structs-diag-1.pk: New test.
	* testsuite/poke.pkl/ne-structs-diag-1.pk: Likewise.
	* testsuite/poke.pkl/eq-structs-8.pk: Likewise.
	* testsuite/poke.pkl/eq-structs-7.pk: Likewise.
	* testsuite/poke.pkl/eq-structs-6.pk: Likewise.
	* testsuite/poke.pkl/eq-structs-5.pk: Likewise.
	* testsuite/poke.pkl/eq-structs-4.pk: Likewise.
	* testsuite/poke.pkl/eq-structs-3.pk: Likewise.
	* testsuite/poke.pkl/ne-structs-2.pk: Likewise.
	* testsuite/poke.pkl/ne-structs-1.pk: Likewise.
	* testsuite/poke.pkl/eq-structs-1.pk: Likewise.

2020-03-27  Jose E. Marchesi  <jemarch@gnu.org>

	* pickles/elf.pk (Elf64_Ehdr): Use arrays equality.
	* testsuite/poke.pkl/eq-arrays-11.pk: New test.
	* testsuite/poke.pkl/eq-arrays-12.pk: Likewise.

2020-03-27  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-typify.c (pkl_typify1_ps_op_rela): The array operands
	must have the same kind of elements.
	* src/pkl-asm.pks (eqa): New macro.
	* src/pkl-asm.c (pkl_asm_insn_cmp): Cover EQ and NE for arrays.
	* doc/poke.texi (Array Comparison): New section.
	* testsuite/poke.pkl/eq-arrays-1.pk: New test.
	* testsuite/poke.pkl/ne-arrays-1.pk: Likewise.
	* testsuite/poke.pkl/eq-arrays-diag-4.pk: Likewise.
	* testsuite/poke.pkl/ne-arrays-diag-2.pk: Likewise.
	* testsuite/poke.pkl/eq-arrays-2.pk: Likewise.
	* testsuite/poke.pkl/ne-arrays-2.pk: Likewise.
	* testsuite/poke.pkl/eq-arrays-3.pk: Likewise.
	* testsuite/poke.pkl/ne-arrays-3.pk: Likewise.
	* testsuite/poke.pkl/ne-arrays-4.pk: Likewise.
	* testsuite/poke.pkl/eq-arrays-4.pk: Likewise.
	* testsuite/poke.pkl/ne-arrays-10.pk: Likewise.
	* testsuite/poke.pkl/eq-arrays-10.pk: Likewise.
	* testsuite/poke.pkl/ne-arrays-8.pk: Likewise.
	* testsuite/poke.pkl/eq-arrays-8.pk: Likewise.
	* testsuite/poke.pkl/ne-arrays-7.pk: Likewise.
	* testsuite/poke.pkl/eq-arrays-7.pk: Likewise.
	* testsuite/poke.pkl/ne-arrays-6.pk: Likewise.
	* testsuite/poke.pkl/eq-arrays-6.pk: Likewise.
	* testsuite/poke.pkl/ne-arrays-5.pk: Likewise.
	* testsuite/poke.pkl/eq-arrays-5.pk: Likewise.

2020-03-27  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-typify.c (pkl_typify1_ps_op_rela): Accept array
	arguments in EQ and NE operators.
	* src/pkl-promo.c (pkl_promo_ps_op_rela): Likewise.
	* testsuite/poke.pkl/le-arrays-diag-1.pk: New test.
	* testsuite/poke.pkl/ge-arrays-diag-1.pk: Likewise.
	* testsuite/poke.pkl/gt-arrays-diag-1.pk: Likewise.
	* testsuite/poke.pkl/lt-arrays-diag-1.pk: Likewise.
	* testsuite/poke.pkl/eq-arrays-diag-1.pk: Likewise.
	* testsuite/poke.pkl/eq-arrays-diag-2.pk: Likewise.
	* testsuite/poke.pkl/ne-arrays-diag-1.pk: Likewise.

2020-03-26  Tim Rühsen  <tim.ruehsen@gmx.de>

	* bootstrap.conf: Set gnulib_name=libgnu
	* src/Makefile.am: Rename libpoke to libgnu.

2020-03-26  Tim Rühsen  <tim.ruehsen@gmx.de>

	* Makefile.am: Rename lib to gl.
	* bootstrap.conf: Set source_base=gl.
	* configure.ac: Rename lib/ to gl/.
	* src/Makefile.am: Rename lib to gl.

2020-03-26  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pk-utils.h: Prototype for pk_print_binary moved from
	pvm-val.h.
	* src/pk-utils.c (pk_print_binary): Moved from pvm-val.c
	* src/pvm.jitter (PVM_PRINTI): Call pk_print_binary instead of
	pvm_print_binary.
	(PVM_PRINTL): Likewise.
	* src/pvm-val.c (pvm_print_val_1): Likewise.

2020-03-26  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pvm.jitter (smodi): Check that the provided index is
	in-range.

2020-03-26  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-rt.pk: Do not define `true' nor `false'.

2020-03-26  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-typify.c (pkl_typify1_ps_try_catch_stmt): Fix locations
	of errors.
	* testsuite/poke.pkl/try-catch-diag-4.pk: New test.
	* testsuite/poke.pkl/try-catch-diag-5.pk: Likewise.

2020-03-26  Jose E. Marchesi  <jemarch@gnu.org>

	* testsuite/poke.pkl/scons-53.pk: New test.
	* testsuite/poke.pkl/promo-array-arg-10.pk: Likewise.
	* testsuite/poke.pkl/promo-array-arg-11.pk: Likewise.
	* testsuite/poke.pkl/promo-array-arg-diag-8.pk: Likewise.

2020-03-26  Jose E. Marchesi  <jemarch@gnu.org>

	* pickles/elf.pk (Elf64_Sym): fix type of st_name.
	Adjust labels in st_info for endianness.

2020-03-25  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-ast.h: Prototype for pkl_ast_array_type_remove_bounders.
	* src/pkl-ast.c (pkl_ast_array_type_remove_bounders): Define.
	* src/pkl-gen.c (pkl_gen_pr_type_array): Use
	pkl_ast_array_type_remove_bounders.

2020-03-25  Jose E. Marchesi  <jemarch@gnu.org>

	* testsuite/poke.pkl/scons-46.pk: New test.
	* testsuite/poke.pkl/scons-48.pk: Likewise.
	* testsuite/poke.pkl/scons-49.pk: Likewise.
	* testsuite/poke.pkl/scons-50.pk: Likewise.
	* testsuite/poke.pkl/scons-51.pk: Likewise.
	* testsuite/poke.pkl/scons-52.pk: Likewise.

2020-03-25  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-gen.pks (struct_constructor): Promote struct constructor
	initializers that are arrays.

2020-03-24  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-trans.c (pkl_transl_pr_type_array): Remove.
	(pkl_transl_ps_type_array): Likewise.
	(pkl_transl_ps_var): Likewise.
	(pkl_phase_transl): Likewise.
	* src/pkl.c (rest_of_compilation): Remove lex pass.
	* src/pkl-ast.c (pkl_ast_type_promoteable): Handle general array
	types.
	* src/pkl-promo.c (pkl_promo_ps_scons): Promote array initializers
	in struct constructors.
	* testsuite/poke.pkl/promo-array-scons-diag-1.pk: New test.
	* testsuite/poke.pkl/scons-42.pk: Likewise.
	* testsuite/poke.pkl/scons-43.pk: Likewise.
	* testsuite/poke.pkl/scons-44.pk: Likewise.
	* testsuite/poke.pkl/scons-45.pk: Likewise.
	* testsuite/poke.pkl/cast-array-7.pk: Likewise.

2020-03-24  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-ast.c (pkl_ast_node_free): Remove incorrect fallthrough
	comment.

2020-03-22  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-trans.h (struct pkl_trans_payload): Remove field in_map.
	* src/pkl-trans.c (pkl_transl_pr_map): Remove.
	(pkl_transl_ps_map): Likewise.
	(pkl_transl_pr_type_struct): Likewise.
	(pkl_phase_transl): Update accordingly.
	* testsuite/poke.pkl/scons-40.pk: New test.
	* testsuite/poke.pkl/scons-41.pk: Likewise.

2020-03-21  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-gen.c (pkl_gen_pr_type_array): Use the array bounder, if
	available, instead of subpassing.
	* testsuite/poke.map/maps-arrays-20.pk: New test.

2020-03-21  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-gen.pks (array_constructor): Optimize calculation of
	bounds at run-time.
	* src/pkl-gen.c (pkl_gen_pr_type_array): Pass EBOUND and SBOUND as
	two arguments to the array constructor.
	* testsuite/poke.pkl/scons-36.pk: New test.
	* testsuite/poke.pkl/scons-37.pk: Likewise.
	* testsuite/poke.pkl/scons-38.pk: Likewise.
	* testsuite/poke.pkl/scons-39.pk: Likewise.
	* testsuite/poke.pkl/scons-40.pk: Likewise.

2020-03-21  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-gen.pks (array_constructor): Implement with full support
	for both unbounded and bounded arrays.
	* testsuite/poke.pkl/scons-diag-5.pk: Remove.
	* testsuite/poke.pkl/scons-32.pk: New test.
	* testsuite/poke.pkl/scons-33.pk: Likewise.
	* testsuite/poke.pkl/scons-34.pk: Likewise.
	* testsuite/poke.pkl/scons-35.pk: Likewise.

2020-03-21  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-gen.c (pkl_gen_pr_type_array): Handle in_constructor
	cases.

2020-03-21  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-ast.c (pkl_ast_node_free): Remove GC roots for array
	constructor closures.
	(pkl_ast_make_array_type): Initialize array type constructor
	closures to null and add GC roots for them.
	* src/pkl-ast.h (struct pkl_ast_type): New field `constructor' for
	array types.
	(PKL_AST_TYPE_S_CONSTRUCTOR): Define.
	* src/pkl-gen.c (pkl_gen_pr_decl): Compile constructor closures
	for array types.
	* src/pkl-gen.pks (array_constructor): New RAS function.

2020-03-21  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-ast.h: Remove prototype for pkl_ast_complete_scons.
	(struct pkl_ast_struct_field): Remove field `dummy'.
	(PKL_AST_STRUCT_FIELD_DUMMY): Delete.
	* src/pkl-ast.c (pkl_ast_complete_scons): Delete.
	(pkl_ast_type_defval): Delete.
	* src/pkl-trans.c (pkl_trans3_ps_scons): Delete.
	(pkl_phase_trans3): Deregister handler.
	* src/pkl-promo.c (pkl_promo_ps_scons): There is no more need to
	handle `dummy' fields in structs.
	* src/pkl-typify.c (pkl_typify1_ps_scons): Likewise.
	* src/pkl-gen.c (pkl_gen_pr_type_struct): If a constructor
	receives a null, turn it into an empty struct of the proper type.
	(pkl_gen_ps_scons): Struct constructors always have named types.

2020-03-21  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-insn.def (PKL_INSN_SREFNT): Define.
	* src/pvm.jitter (srefnt): New instruction.

2020-03-21  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-gen.c (pkl_gen_ps_type_integral): Handle in_constructor.
	(pkl_gen_ps_type_offset): Likewise.
	(pkl_gen_ps_type_string): Likewise.

2020-03-21  John Darrington <john@darrington.wattle.id.au>

	*src/pk-cmd.c (pk_cmd_exec_1): Check that cmd_name
	does not overflow.

2020-03-21  Jose E. Marchesi  <jemarch@gnu.org>

	* pickles/ctf.pk: Updates.

2020-03-20  John Darrington <john@darrington.wattle.id.au>

	* src/pk-misc.c (strings): Declare as const and deal
	with consequences.
	* src/pkl-asm.c (cast_table): Declare as const.
	* src/pkl-asm.c (peek_table): Declare as const.
	* src/pkl-asm.c (peekd_table): Declare as const.
	* src/pkl-asm.c (print_table): Declare as const.

2020-03-18  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-ast.c (pkl_ast_type_defval): Handle unbounded arrays.
	* src/pkl-pass.c (pkl_do_pass_1): An array AST node can have 0
	elements.
	* testsuite/poke.pkl/scons-31.pk: New test.

2020-03-17  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-rt.pk (_pkl_exception_handler): fix typo in message.

2020-03-14  John Darrington <john@darrington.wattle.id.au>

	* doc/Makefile.am (pkgdata_DATA): New variable.
	* doc/Makefile.am (INFO_DEPS): Remove nodelist.
	* doc/Makefile.am (nodelist): Move to $(top_srcdir)/src,
	* src/pk-misc.c (doc_completion_dunction): Expect nodelist
	in poke_datadir instead of poke_infodir.

2020-03-10  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-ast.c (pkl_ast_type_defval): Add missing locations to
	built offsets.
	* testsuite/poke.pkl/attr-size-13.pk: New test.
	* testsuite/poke.pkl/attr-length-7.pk: Likewise.

2020-03-09  Jose E. Marchesi  <jemarch@gnu.org>

	* src/Makefile.am: Make files compiled by ras to depend on ras
	itself.

2020-03-09  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-gen.pks (struct_mapper): Fix the handling of EOF while
	mapping unions.
	* testsuite/poke.map/maps-unions-9.pk: New test.
	* testsuite/poke.map/maps-unions-10.pk: Likewise.

2020-03-09  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-ast.h (PKL_AST_STRUCT_TYPE_FIELD_OPTCOND): Define.
	(struct pkl_ast_struct_type_field): New field optcond.
	* src/pkl-ast.c (pkl_ast_make_struct_type_field): Get an argument
	optcond.
	(pkl_ast_dup_type): Handle optcond.
	(pkl_ast_node_free): Likewise.
	(pkl_ast_type_is_complete): Struct types with optional fields are
	not complete.
	(pkl_ast_print_1): Likewise.
	* src/pkl-pass.c (pkl_do_pass_1): Traverse optcond nodes.
	* src/pkl-tab.y (struct_type_field_optcond): New rule.
	(struct_type_field): Add conditional expression.
	* src/pkl-anal.c (pkl_anal2_ps_type_struct): Optional fields are
	not allowed in unions.
	* src/pkl-typify.c (pkl_typify1_ps_struct_type_field): Make sure
	that optcond expressions in fields evaluate to a boolean.
	* src/pkl-promo.c (pkl_promo_ps_struct_type_field): Promote
	optcond expressions to boolean.
	* src/pkl-gen.pks (struct_mapper): Use the optcond expression in
	optional fields.
	(struct_constructor): Likewise.
	* testsuite/poke.pkl/optcond-1.pk: New test.
	* testsuite/poke.pkl/optcond-2-diag.pk: Likewise.
	* testsuite/poke.map/map-optcond-6.pk: Likewise.
	* testsuite/poke.map/map-optcond-5.pk: Likewise.
	* testsuite/poke.map/map-optcond-4.pk: Likewise.
	* testsuite/poke.map/map-optcond-3.pk: Likewise.
	* testsuite/poke.map/map-optcond-2.pk: Likewise.
	* testsuite/poke.map/map-optcond-1.pk: Likewise.
	* testsuite/poke.map/map-optcond-7.pk: Likewise.
	* testsuite/poke.map/map-optcond-8.pk: Likewise.
	* testsuite/poke.pkl/optcond-2.pk: Likewise.
	* testsuite/poke.pkl/optcond-5.pk: Likewise.
	* testsuite/poke.pkl/optcond-4.pk: Likewise.
	* testsuite/poke.pkl/optcond-3.pk: Likewise.
	* doc/poke.texi (Optional Fields): Document optional fields.

2020-03-07  John Darrington <john@darrington.wattle.id.au>

	* doc/poke.texi: Spell check.
	* src/pk-ios.c (load_cmd, file_cmd): Change "filename" to be two
	words per GNU Coding Standards.

2020-03-07  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-gen.pks (struct_constructor): Remove assert.

2020-03-06  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-typify.c (pkl_typify1_ps_decl): New handler.
	(pkl_phase_typify1): Register handler.
	* testsuite/poke.pkl/struct-pretty-print-diag-1.pk: New test.
	* testsuite/poke.pkl/struct-pretty-print-diag-2.pk: Likewise.

2020-03-06  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-typify.c (pkl_typify1_ps_cond_exp): Set the type of the
	conditional expression node!
	* src/pkl-rt.pk: Simplify.
	* testsuite/poke.pkl/cond-exp-3.pk: New test.

2020-03-06  Jose E. Marchesi  <jemarch@gnu.org>

	* testsuite/poke.pkl/isa-1.pk: Split from isa.pk.
	* testsuite/poke.pkl/isa-9.pk: Likewise.
	* testsuite/poke.pkl/isa-8.pk: Likewise.
	* testsuite/poke.pkl/isa-7.pk: Likewise.
	* testsuite/poke.pkl/isa-6.pk: Likewise.
	* testsuite/poke.pkl/isa-5.pk: Likewise.
	* testsuite/poke.pkl/isa-4.pk: Likewise.
	* testsuite/poke.pkl/isa-3.pk: Likewise.
	* testsuite/poke.pkl/isa-2.pk: Likewise.

2020-03-06  Eric Blake  <eblake@redhat.com>

	* configure.ac: Check for nbdkit in /usr/[local/]sbin.
	* testsuite/lib/poke-dg.exp (dg-nbd): Actually use $NBDKIT from
	environment.

2020-03-06  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-rt.pk: Remove obsolete/spurious comments.

2020-03-06  Jose E. Marchesi  <jemarch@gnu.org>

	* TODO: Update.
	* HACKING: Likewise.

2020-03-06  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-rt.pk (Exception): Define as a struct.
	(EC_generic): Define.
	(EC_div_by_zero): Likewise.
	(EC_no_ios): Likewise.
	(EC_no_return): Likewise.
	(EC_out_of_bounds): Likewise.
	(EC_map_bounds): Likewise.
	(EC_eof): Likewise.
	(EC_map): Likewise.
	(EC_conv): Likewise.
	(EC_elem): Likewise.
	(EC_constraint): Likewise.
	(EC_io): Likewise.
	(EC_signal): Likewise.
	(EC_io_flags): Likewise.
	(_pkl_exception_handler): Adapt to new exceptions.
	* src/pvm-val.h: Prototype for pvm_make_exception.
	* src/pvm-val.c (pvm_make_exception): New function.
	* src/pkl-ast.h: Prototype for pkl_ast_type_is_exception.
	* src/pkl-ast.c (pkl_ast_type_is_exception): New function.
	* src/pvm.jitter (PVM_CHECKED_BINOP): Pass a message to PVM_RAISE.
	(PVM_BINOP_SL): Likewise.
	(PVM_PEEK): Likewise.
	(PVM_POKE): Likewise.
	(sync): Likewise.
	(open): Likewise.
	(close): Likewise.
	(pushios): Likewise.
	(popios): Likewise.
	(iosize): Likewise.
	(iogetb): Likewise.
	(iosetb): Likewise.
	(strref): Likewise.
	(substr): Likewise.
	(aset): Likewise.
	(aseto): Likewise.
	(aref): Likewise.
	(arefo): Likewise.
	(sset): Likewise.
	(sref): Likewise.
	(srefi): Likewise.
	(srefio): Likewise.
	(peeks): Likewise.
	(pokes): Likewise.
	(PVM_RAISE_DIRECT): Define.
	(PVM_RAISE): Re-define in terms of PVM_RAISE_DIRECT.
	(raise): Use PVM_RAISE_DIRECT.
	(pushe): Get an Exception.
	* src/pvm.h (PVM_E_GENERIC_MSG): Define.
	(PVM_E_DIV_BY_ZERO_MSG): Likewise.
	(PVM_E_NO_IOS_MSG): Likewise.
	(PVM_E_NO_RETURN_MSG): Likewise.
	(PVM_E_OUT_OF_BOUNDS_MSG): Likewise.
	(PVM_E_MAP_BOUNDS_MSG): Likewise.
	(PVM_E_EOF_MSG): Likewise.
	(PVM_E_MAP_MSG): Likewise.
	(PVM_E_CONV_MSG): Likewise.
	(PVM_E_ELEM_MSG): Likewise.
	(PVM_E_CONSTRAINT_MSG): Likewise.
	(PVM_E_IO_MSG): Likewise.
	(PVM_E_SIGNAL_MSG): Likewise.
	(PVM_E_IOFLAGS_MSG): Likewise.
	* src/pkl-asm.c (pkl_asm_finish): Adapt to new exceptions.
	* src/pkl-typify.c (pkl_typify1_ps_raise_stmt): Likewise.
	* src/pkl-typify.c (pkl_typify1_ps_try_until_stmt): Likewise.
	* src/pkl-typify.c (pkl_typify1_ps_try_catch_stmt): Likewise.
	* src/pkl-gen.c (pkl_gen_ps_raise_stmt): Likewise.
	* src/pkl-gen.c (pkl_gen_pr_try_catch_stmt): Likewise.
	* src/pkl-promo.c (pkl_promo_ps_raise_stmt): Remove handler.
	(pkl_promo_ps_try_until_stmt): Likewise.
	(pkl_promo_ps_try_catch_stmt): Likewise.
	* src/ras: Adapt handling of PVM_E_* arguments to generate
	Exceptions instead of integers.
	* testsuite/poke.pkl/raise-2.pk: Adapt to new exceptions.
	* testsuite/poke.pkl/try-until-3.pk: Likewise.
	* testsuite/poke.pkl/try-until-2.pk: Likewise.
	* testsuite/poke.pkl/try-catch-diag-2.pk: Likewise.
	* testsuite/poke.pkl/try-catch-diag-1.pk: Likewise.
	* testsuite/poke.pkl/try-catch-7.pk: Likewise.
	* testsuite/poke.pkl/raise-5.pk: Likewise.
	* testsuite/poke.pkl/raise-4.pk: Likewise.
	* testsuite/poke.pkl/raise-3.pk: Likewise.
	* testsuite/poke.pkl/raise-6.pk: New test.
	* doc/poke.texi (Exceptions): Update.
	(try-until): Likewise.
	(try-catch): Likewise.

2020-03-06  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-ast.h (PKL_AST_STRUCT_FIELD_DUMMY): Define.
	(struct pkl_ast_struct_field): Add field `dummy'.
	* src/pkl-ast.c (pkl_ast_complete_scons): Annotate the dummy
	property in struct fields.
	* src/pkl-typify.c (pkl_typify1_ps_scons): Acknowledge the dummy
	annotation.
	* src/pkl-promo.c (pkl_promo_ps_scons): Likewise.

2020-03-06  Jose E. Marchesi  <jemarch@gnu.org>

	* HACKING: Mention non-restartable passes.

2020-03-06  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-typify.c (pkl_typify1_ps_struct): Avoid restarting the
	pass.
	* src/pkl-typify.c (pkl_typify1_ps_array): Likewise.
	* src/pkl-typify.c (pkl_typify1_ps_isa): Likewise.
	* src/pkl-typify.c (pkl_typify1_ps_cast): Likewise.
	* src/pkl-trans.c (pkl_trans1_ps_offset): Likewise.
	* src/pkl-trans.c (pkl_trans1_ps_print_stmt): Likewise.

2020-03-05  Jose E. Marchesi  <jemarch@gnu.org>

	* testsuite/lib/poke.exp (poke_start): Pass -q to poke to avoid
	acknowledging the user init file.
	* testsuite/poke.repl/repl.exp: Use a more meaningful test name.

2020-03-05  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-ast.h (PKL_AST_STRUCT_FIELD_COMPLETED): Remove.
	(struct pkl_ast_struct_field): Remove field `completed'.

2020-03-05  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-ast.c (pkl_ast_type_defval): This function cannot
	calculate the default value for structs and unions.
	* src/pkl-ast.h: Prototype for pkl_ast_complete_scons.
	* src/pkl-ast.c: New function.
	* src/pkl-trans.c (pkl_trans3_ps_scons): Call
	pkl_ast_complete_scons.
	* src/pkl-gen.c (pkl_gen_ps_scons): Compile ad-hoc struct
	constructors for anonymous structs/unions.
	* src/pkl-gen.pks (struct_constructor): handle completed struct
	fields properly.
	* src/pvm.jitter (tyissct): New instruction.
	* src/pkl-insn.def (PKL_INSN_TYISSCT): Define.
	* testsuite/poke.pkl/scons-26.pk: New test.
	* testsuite/poke.pkl/scons-27.pk: Likewise.
	* testsuite/poke.pkl/scons-28.pk: Likewise.
	* testsuite/poke.pkl/scons-29.pk: Likewise.

2020-03-05  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-gen.pks (struct_constructor): Support unions.
	* testsuite/poke.pkl/scons-union-1.pk: New test.
	* testsuite/poke.pkl/scons-union-2.pk: Likewise.
	* testsuite/poke.pkl/scons-union-8.pk: Likewise.
	* testsuite/poke.pkl/scons-union-6.pk: Likewise.
	* testsuite/poke.pkl/scons-union-5.pk: Likewise.
	* testsuite/poke.pkl/scons-union-4.pk: Likewise.
	* testsuite/poke.pkl/scons-union-3.pk: Likewise.

2020-03-05  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-typify.c (pkl_typify1_ps_indexer): No need to restart
	the pass.
	(pkl_typify1_ps_struct_field): Likewise.
	(pkl_typify1_ps_struct_ref): Likewise.
	(pkl_typify1_ps_type_array): Likewise.

2020-03-05  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pvm-val.h (PVM_PRINT_F_GET_MAPS): Define.
	* src/pk-cmd.c (pk_cmd_exec): Use PVM_PRINT_F_MAPS.
	* src/pvm.jitter (printv): Likewise.
	(strace): Likewise.
	(state-struct-runtime-c): Add field omaps.
	(state-initialization-c): omaps is 0 by default.
	* src/pvm.c (pvm_omaps): New function.
	(pvm_set_omaps): Likewise.
	(PVM_STATE_OMAPS): Define.
	* src/pvm.h: Prototypes for pvm_omaps and pvm_set_omaps.
	* src/pk-set.c (pk_cmd_set_omaps): New function.
	(set_cmds): Add set_omaps_cmd.
	* src/pvm-val.c (pvm_print_val_1): Do not print offsets of array
	elements or struct fields.
	Use PVM_PRINT_F_GET_MAPS.
	* testsuite/poke.cmd/set-omaps-1.pk: New test.
	* doc/poke.texi (set command): Document omaps.

2020-03-05  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pvm-val.c (pvm_print_val): Print struct offsets when invoked
	with F_MAPS.
	(pvm_print_val_1): Renamed from pvm_print_val, and added new
	argument `depth'.
	(pvm_print_val): New function.
	(pk_odepth): Remove.

2020-03-05  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-tab.y (struct): Remove rule.
	(expression): Remove corresponding alternative.
	* src/pkl-trans.c (pkl_trans3_ps_scons): Fix logic in loop.
	* src/pkl-gen.pks (struct_constructor): Fix offsets, and make sure
	the number of fields is stored in an ulong<64>.
	(struct_mapper): Likewise, for nfields.
	* testsuite/poke.pkl/ass-diag-6.pk: Remove.
	* testsuite/poke.pkl/structs-1.pk: Likewise.
	* testsuite/poke.pkl/structs-2.pk: Likewise.
	* testsuite/poke.pkl/arrays-3.pk: Adapt.
	* testsuite/poke.map/mapped-attr.pk: Likewise.
	* testsuite/poke.pkl/ass-1.pk: Likewise.
	* testsuite/poke.pkl/attr-length-1.pk: Likewise.
	* testsuite/poke.pkl/attr-length-2.pk: Likewise.
	* testsuite/poke.pkl/attr-size-10.pk: Likewise.
	* testsuite/poke.pkl/attr-size-11.pk: Likewise.
	* testsuite/poke.pkl/cast-struct-diag-2.pk: Likewise.
	* testsuite/poke.pkl/defvar-5.pk: Likewise.
	* testsuite/poke.pkl/isa.pk: Likewise.
	* testsuite/poke.pkl/printf-20.pk: Likewise.
	* testsuite/poke.pkl/printf-21.pk: Likewise.
	* testsuite/poke.pkl/printf-22.pk: Likewise.
	* testsuite/poke.pkl/printf-23.pk: Likewise.
	* testsuite/poke.pkl/printf-24.pk: Likewise.
	* testsuite/poke.pkl/printf-25.pk: Likewise.
	* testsuite/poke.pkl/printf-value-3.pk: Likewise.
	* testsuite/poke.pkl/printf-value-4.pk: Likewise.
	* testsuite/poke.pkl/sref-1.pk: Renamed from structs-3.pk
	* testsuite/poke.pkl/sref-2.pk: Renamed from structs-4.pk
	* testsuite/poke.pkl/scons-25.pk: Renamed from structs-5.pk.
	* testsuite/poke.pkl/scons-diag-6.pk: Renamed from
	structs-diag-1.pk.
	* testsuite/poke.pkl/attr-length-6.pk: New test.

2020-03-04  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-gen.pks (struct_constructor): Check field constraints in
	struct constructors.
	* testsuite/poke.pkl/scons-20.pk: New test.
	* testsuite/poke.pkl/scons-21.pk: Likewise.
	* testsuite/poke.pkl/scons-22.pk: Likewise.
	* testsuite/poke.pkl/scons-23.pk: Likewise.
	* testsuite/poke.pkl/scons-24.pk: Likewise.
	* doc/poke.texi (Struct Literals): Remove section.
	(Struct Constructors): Document that struct constructors take data
	integrity into account.

2020-03-04  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-gen.pks (struct_constructor): Handle the struct methods.
	* testsuite/poke.pkl/scons-18.pk: New test.
	* testsuite/poke.pkl/scons-19.pk: New test.

2020-03-04  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-ast.c: Remove trailing whitespaces.
	* src/pkl-promo.c: Likewise.

2020-03-04  Jose E. Marchesi  <jemarch@gnu.org>

	* doc/poke.texi (Struct Constructors): New section.

2020-03-04  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-promo.c (pkl_promo_ps_scons): New handler.
	(pkl_phase_promo): Install new handler.
	* testsuite/poke.pkl/scons-17.pk: New test.
	* testsuite/poke.pkl/scons-diag-4.pk: Adjust.

2020-03-04  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-ast.c (pkl_ast_type_defval): Fix the index of elements
	in array defvals.
	* src/pkl-trans.c (pkl_trans3_ps_scons): Set the number of
	elements in the created struct value.
	* src/pkl-gen.c (pkl_gen_pr_type_struct): Fix comment.
	* src/pkl-gen.pks (struct_constructor): Handle compile-time built
	fields.
	* testsuite/poke.pkl/scons-1.pk: New test.
	* testsuite/poke.pkl/scons-13.pk: Likewise.
	* testsuite/poke.pkl/scons-12.pk: Likewise.
	* testsuite/poke.pkl/scons-11.pk: Likewise.
	* testsuite/poke.pkl/scons-10.pk: Likewise.
	* testsuite/poke.pkl/scons-9.pk: Likewise.
	* testsuite/poke.pkl/scons-8.pk: Likewise.
	* testsuite/poke.pkl/scons-7.pk: Likewise.
	* testsuite/poke.pkl/scons-6.pk: Likewise.
	* testsuite/poke.pkl/scons-5.pk: Likewise.
	* testsuite/poke.pkl/scons-4.pk: Likewise.
	* testsuite/poke.pkl/scons-diag-5.pk: Likewise.
	* testsuite/poke.pkl/scons-3.pk: Likewise.
	* testsuite/poke.pkl/scons-2.pk: Likewise.
	* testsuite/poke.pkl/scons-14.pk: Likewise.
	* testsuite/poke.pkl/scons-16.pk: Likewise.
	* testsuite/poke.pkl/scons-15.pk: Likewise.

2020-03-04  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-ast.c (pkl_ast_type_defval): ASTREF the type of the
	index of new array elements.
	(pkl_ast_type_defval): Add missing `break'.

2020-03-03  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-trans.c (pkl_trans3_ps_scons): New handler.
	(pkl_phase_trans3): Likewise.

2020-03-03  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-ast.h: Prototype for pkl_at_type_defval.
	* src/pkl-ast.c (pkl_ast_type_defval): New function.

2020-03-03  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-gen.pks (struct_writer): Use the mapping attributes from
	the mapped objects instead of getting them as arguments.
	(array_writer): Likewise.
	* src/pkl-asm.pks (write): Adjust accordingly.
	* src/pkl-gen.c (pkl_gen_pr_type_array): Clarify why the offset
	and ios are not used in a comment.
	(pkl_gen_pr_type_struct): Likewise.

2020-03-03  Jose E. Marchesi  <jemarch@gnu.org>

	* testsuite/lib/poke-dg.exp (dg-nbd): Run nbdkit only when
	available.
	(dg-command): Do not append to poke_commands if the current test
	is being skipped as UNSUPPORTED.
	* testsuite/poke.pkl/ios-nbd-1.pk: dg-require nbd.
	* testsuite/poke.pkl/open-3.pk: Likewise.
	* testsuite/poke.cmd/nbd-1.pk: Likewise.
	* HACKING: Note that dg-require should be used before dg-command
	directives.

2020-03-03  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pk-utils.h (STREQ): Define.
	(STRNEQ): Likewise.
	* src/ios.c: Include pk-uttils.h.
	(STREQ): Remove.
	* src/pvm-val.c: Likewise.
	* src/pvm.jitter: Likewise.
	* src/pk-set.c: Likewise.
	* src/pk-hserver.c: Likewise.
	* src/pk-editor.c: Likewise.
	* src/pkl-typify.c: Likewise.
	* src/pkl-trans.c: Likewise.
	* src/pkl-fold.c: Likewise.
	* src/pkl-env.c: Likewise.
	* src/pkl-ast.c: Likewise.
	* src/pkl-anal.c: Likewise.
	* src/pk-misc.c: Likewise.
	* src/ios-dev-mem.c: Do not include assert.h.
	* src/ios-dev-nbd.c: Likewise.

2020-03-02  Eric Blake  <eblake@redhat.com>

	ios: Add Size to '.info ios'.
	* src/pk-ios.c (pk_cmd_info_ios, print_info_ios): Add Size
	column.
	* doc/poke.texi (info command): Document the addition.
	* testsuite/poke.cmd/file-mode.pk: Adjust expected output.
	* testsuite/poke.cmd/file-relative.pk: Likewise.

2020-03-02  Eric Blake  <eblake@redhat.com>

	* src/pk-ios.c (print_info_ios): Correct hyperlink.

2020-03-02  Eric Blake  <eblake@redhat.com>

	* .gitignore: Implementing '.doc' creates another file.

2020-03-02  Eric Blake  <eblake@redhat.com>

	nbd: Add testsuite coverage
	* HACKING (Using NBD connections in tests): New section.
	(Writing tests that depend on a certain capability): New capability.
	* testsuite/Makefile.am (check-DEJAGNU): Expose NBD witnesses.
	* configure.ac (AC_CHECK_PROGS): Check for nbdkit.
	* testsuite/lib/poke-dg.exp (dg-require): Add 'nbd' capability.
	(dg-tmpdir): New command to create safe short temp dir.
	(dg-nbd): New command to spawn nbdkit server.
	(poke_finish): Clean up nbdkit.
	* testsuite/poke.cmd/nbd-1.pk: New test of '.nbd'.
	* testsuite/poke.pkl/open-3.pk: New test of open("nbd...").
	* testsuite/poke.pkl/ios-nbd-1.pk: New test of nbd I/O.

2020-03-02  Eric Blake  <eblake@redhat.com>

	Add optional nbd:// io space support
	* configure.ac (PKG_CHECK_MODULES): Check for libnbd.
	* src/ios-dev-nbd.c: New file.
	* src/Makefile.am (poke_SOURCES): Optionally build it.
	* src/ios.c (ios_dev_ifs): Expose it through 'open'.
	* src/pk-ios.c (pk_cmd_nbd): Add .nbd command.
	* src/pk-cmd.c (dot_cmds): Load it.
	* doc/poke.texi (nbd command): New section.
	(open): Document nbd handler.
	* HACKING (libnbd): Mention it.

2020-03-02  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-gen.pks (array_mapper): Set the IOS of the mapped value.
	(struct_mapper): Likewise.
	* src/pvm.jitter (PVM_PEEK): Do not support ios == PVM_NULL.
	(PVM_POKE): Likewise.
	(peeks): Likewise.
	(pokes): Likewise.
	* src/pkl-gen.c (pkl_gen_pr_map): Push the current IOS if no IOS
	was specified in the map, instead of pushing PVM_NULL.
	* src/pkl-typify.c (pkl_typify1_ps_attr): Allow 'offset in any
	type.
	* src/pkl-gen.c (pkl_gen_ps_op_attr): Handle 'offset and 'ios in
	values of type any, checking at run-time.
	* testsuite/poke.pkl/attr-ios-diag-3.pk: New test.
	* testsuite/poke.map/maps-ios-8.pk: Likewise.
	* testsuite/poke.pkl/attr-ios-2.pk: Likewise.
	* testsuite/poke.pkl/attr-offset-diag-3.pk: Likewise.
	* testsuite/poke.pkl/attr-offset-diag-2.pk: Likewise.
	* testsuite/poke.pkl/attr-offset-3.pk: Likewise.
	* testsuite/poke.pkl/attr-offset-2.pk: Likewise.
	* testsuite/poke.pkl/attr-offset-diag-1.pk: Likewise.
	* testsuite/poke.pkl/attr-offset-1.pk: Likewise.
	* testsuite/poke.pkl/attr-ios-1.pk: Likewise.
	* testsuite/poke.pkl/attr-mapped-4.pk: Likewise.
	* testsuite/poke.pkl/attr-mapped-3.pk: Likewise.
	* testsuite/poke.pkl/attr-mapped-2.pk: Likewise.
	* testsuite/poke.pkl/attr-mapped-1.pk: Likewise.
	* TODO (or): Update.

2020-03-02  Eric Blake  <eblake@redhat.com>

	ios: Utilize buffer writes.
	* src/ios.c (IOS_PUT_C_ERR_CHCK): Add parameter.
	(ios_write_int_fast, ios_write_int_common): Consolidate writes.
	(ios_size): Drop useless ().

2020-03-02  Eric Blake  <eblake@redhat.com>

	ios: Utilize buffer reads.
	* src/ios.c (ios_read_int_common, ios_read_int, ios_read_uint):
	Consolidate reads.
	(IOS_READ_INTO_CHARRAY_1BYTE, IOS_READ_INTO_CHARRAY_2BYTES)
	(IOS_READ_INTO_CHARRAY_3BYTES, IOS_READ_INTO_CHARRAY_4BYTES)
	(IOS_READ_INTO_CHARRAY_5BYTES, IOS_READ_INTO_CHARRAY_6BYTES)
	(IOS_READ_INTO_CHARRAY_7BYTES, IOS_READ_INTO_CHARRAY_8BYTES)
	(IOS_READ_INTO_CHARRAY_9BYTES): Delete unused macros.

2020-03-02  Eric Blake  <eblake@redhat.com>

	ios: Change from getchar to pread device interface.
	* src/ios-dev.h (struct ios_dev_if): Replace get_c/put_c with
	pread/pwrite.
	* src/ios.c (IOS_GET_C_ERR_CHCK, IOS_PUT_C_ERR_CHCK)
	(ios_read_string, ios_write_string): Use the new interface.
	* src/ios-dev-file.c (ios_dev_file_getc, ios_dev_file_putc):
	Rewrite to...
	(ios_dev_file_pread, ios_dev_file_pwrite): ...this.
	* src/ios-dev-mem.c (ios_dev_mem_getc, ios_dev_mem_putc): Rewrite
	to...
	(ios_dev_mem_pread, ios_dev_mem_pwrite): ...this.

2020-03-02  Eric Blake  <eblake@redhat.com>

	ios: Drop unused seek/tell callbacks.
	* src/ios.c (ios_read_int, ios_read_uint, ios_read_string)
	(ios_write_int_common, ios_write_int, ios_write_uint)
	(ios_write_string): Drop redundant seek calls.
	* src/ios-dev.h (struct ios_dev_if): Drop unused seek and tell.
	* src/ios-dev-file.c (ios_dev_file_getc, ios_dev_file_putc): Set
	rather than assert offset.
	(ios_dev_file_tell, ios_dev_file_seek): Delete.
	* src/ios-dev-mem.c (ios_dev_mem_getc, ios_dev_mem_putc): Simplify.
	(ios_dev_mem_tell, ios_dev_mem_seek): Delete.
	* testsuite/poke.pkl/ios-mem-5.pk: Update the test.

2020-03-02  Eric Blake  <eblake@redhat.com>

	ios: Prove we don't need seek.
	* src/ios-dev.h (struct ios_dev_if): Add offset parameter to get_c
	and put_c.
	* src/ios.c (IOS_GET_C_ERR_CHCK, IOS_PUT_C_ERR_CHCK)
	(ios_read_string, ios_write_string): Pass offset through.
	* src/ios-dev-file.c (ios_dev_file_getc, ios_dev_file_putc):
	Update signature and add assertion.
	* src/ios-dev-mem.c (ios_dev_mem_getc, ios_dev_mem_putc):
	Likewise.

2020-03-02  Eric Blake  <eblake@redhat.com>

	ios: Pass offset to low-level macros.
	* src/ios.c (IOS_GET_C_ERR_CHCK, IOS_PUT_C_ERR_CHCK)
	(IOS_READ_INTO_CHARRAY_1BYTE, IOS_READ_INTO_CHARRAY_2BYTES)
	(IOS_READ_INTO_CHARRAY_3BYTES, IOS_READ_INTO_CHARRAY_4BYTES)
	(IOS_READ_INTO_CHARRAY_5BYTES, IOS_READ_INTO_CHARRAY_6BYTES)
	(IOS_READ_INTO_CHARRAY_7BYTES, IOS_READ_INTO_CHARRAY_8BYTES)
	(IOS_READ_INTO_CHARRAY_9BYTES): Add parameter (unused until next
	patch).
	(ios_write_int_fast): Add parameter.
	(ios_read_int_common, ios_read_int, ios_read_uint)
	(ios_write_int_common, ios_write_int, ios_write_uint): Adjust
	callers.

2020-03-02  Eric Blake  <eblake@redhat.com>

	ios: Avoid data leak and write-beyond-bounds in mem.
	* src/ios-dev-mem.c (ios_dev_mem_putc): Zero the added bytes, and
	track the updated size.
	(ios_dev_mem_seek): Forbid seeks beyond our desired growth amount.
	(ios_dev_mem_open): Zero the initial bytes.
	* testsuite/poke.pkl/ios-mem-2.pk: Actually obey comment.
	* testsuite/poke.pkl/ios-mem-3.pk: New test.
	* testsuite/poke.pkl/ios-mem-4.pk: Likewise.
	* testsuite/poke.pkl/ios-mem-5.pk: Likewise.

2020-03-02  Jose E. Marchesi  <jemarch@gnu.org>

	* testsuite/poke.pkl/funcall-vararg-1.pk: Split from
	funcall-vararg.pk
	* testsuite/poke.pkl/funcall-vararg-6.pk: Likewise.
	* testsuite/poke.pkl/funcall-vararg-5.pk: Likewise.
	* testsuite/poke.pkl/funcall-vararg-4.pk: Likewise.
	* testsuite/poke.pkl/funcall-vararg-3.pk: Likewise.
	* testsuite/poke.pkl/funcall-vararg-2.pk: Likewise.

2020-03-02  Jose E. Marchesi  <jemarch@gnu.org>

	* testsuite/poke.pkl/arrays-10.pk: s/catched/caught.
	* testsuite/poke.map/maps-unions-3.pk: Likewise.
	* testsuite/poke.map/maps-uint-diag-1.pk: Likewise.
	* testsuite/poke.map/maps-structs-constraints-1.pk: Likewise.
	* testsuite/poke.map/maps-strings-diag-4.pk: Likewise.
	* testsuite/poke.map/maps-strings-diag-2.pk: Likewise.
	* testsuite/poke.map/maps-strings-diag-1.pk: Likewise.
	* testsuite/poke.map/maps-simple-9.pk: Likewise.
	* testsuite/poke.map/maps-arrays-11.pk: Likewise.
	* testsuite/poke.map/maps-arrays-3.pk: Likewise.
	* testsuite/poke.pkl/try-until-3.pk: Likewise.
	* testsuite/poke.pkl/try-catch-diag-3.pk: Likewise.
	* testsuite/poke.pkl/try-catch-7.pk: Likewise.
	* testsuite/poke.pkl/try-catch-6.pk: Likewise.
	* testsuite/poke.pkl/trim-15.pk: Likewise.
	* testsuite/poke.pkl/trim-14.pk: Likewise.
	* testsuite/poke.pkl/trim-13.pk: Likewise.
	* testsuite/poke.pkl/trim-12.pk: Likewise.
	* testsuite/poke.pkl/trim-11.pk: Likewise.
	* testsuite/poke.pkl/sl-integers-12.pk: Likewise.
	* testsuite/poke.pkl/sl-integers-11.pk: Likewise.
	* testsuite/poke.pkl/sl-integers-10.pk: Likewise.
	* testsuite/poke.pkl/sl-integers-9.pk: Likewise.
	* testsuite/poke.pkl/sl-integers-6.pk: Likewise.
	* testsuite/poke.pkl/sl-integers-5.pk: Likewise.
	* testsuite/poke.pkl/promo-array-return-diag-2.pk: Likewise.
	* testsuite/poke.pkl/promo-array-arg-diag-7.pk: Likewise.
	* testsuite/poke.pkl/promo-array-arg-diag-4.pk: Likewise.
	* testsuite/poke.pkl/promo-array-arg-diag-3.pk: Likewise.
	* testsuite/poke.pkl/promo-array-arg-diag-2.pk: Likewise.
	* testsuite/poke.pkl/iosize-diag-1.pk: Likewise.
	* testsuite/poke.pkl/funcal-vararg.pk: Likewise.
	* testsuite/poke.pkl/funcall-vararg.pk: Likewise.
	* testsuite/poke.pkl/defun-12.pk: Likewise.
	* testsuite/poke.pkl/cast-array-siz-diag-3.pk: Likewise.
	* testsuite/poke.pkl/cast-array-siz-diag-2.pk: Likewise.
	* testsuite/poke.pkl/cast-array-siz-diag-1.pk: Likewise.
	* testsuite/poke.pkl/cast-array-diag-6.pk: Likewise.
	* testsuite/poke.pkl/cast-array-diag-3.pk: Likewise.
	* testsuite/poke.pkl/cast-array-diag-2.pk: Likewise.
	* testsuite/poke.pkl/attr-size-12.pk: Likewise.
	* testsuite/poke.pkl/attr-ios-diag-2.pk: Likewise.
	* testsuite/poke.pkl/attr-ios-diag-1.pk: Likewise.
	* testsuite/poke.pkl/ass-9.pk: Likewise.
	* testsuite/poke.pkl/array-siz-diag-1.pk: Likewise.
	* testsuite/poke.pkl/arrays-12.pk: Likewise.
	* testsuite/poke.pkl/arrays-11.pk: Likewise.

2020-03-02  Eric Blake  <eblake@redhat.com>

	* .gitignore: Broaden exclusion to cover all build objects.

2020-03-02  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-fold.c (PKL_PHASE_HANDLER_BIN_LOGIC): Renamed from
	PKL_PHASE_BIN_INT.
	(PKL_PHASE_HANDLER_BIN_INTOFF): Define.
	(PKL_PHASE_HANDLER_BIN_SHIFTPOW): Likewise.
	(ioro): Define semantic routines.
	(xoro): Likewise.
	(bando): Likewise.
	(slo): Likewise.
	(sro): Likewise.
	(powo): Likewise.
	(poso): Likewise.
	(nego): Likewise.
	(bonoto): Likewise.
	(OP_UNARY_OO): Define.
	* testsuite/poke.pkl/pos-offsets-1.pk: New test.

2020-03-02  Jose E. Marchesi  <jemarch@gnu.org>

	* src/Makefile.am (poke_SOURCES): Remove jitter generated sources.
	(poke_LDADD): Add libpvmjitter.a.
	(noinst_LIBRARIES): Define.
	(libpvmjitter_a_SOURCES): Likewise.
	(libpvmjitter_a_CPPFLAGS): Likewise.
	(libpvmjitter_a_CFLAGS): Likewise.
	* TODO: Another task bites the dust!

2020-03-02  Jose E. Marchesi  <jemarch@gnu.org>

	* testsuite/poke.pkl/sl-integers-1.pk: Rename from sl-1.pk
	* testsuite/poke.pkl/sl-integers-2.pk: Rename from sl-2.pk
	* testsuite/poke.pkl/sl-integers-3.pk: Rename from sl-3.pk
	* testsuite/poke.pkl/sl-integers-4.pk: Rename from sl-4.pk
	* testsuite/poke.pkl/sl-integers-5.pk: Rename from sl-5.pk
	* testsuite/poke.pkl/sl-integers-6.pk: Rename from sl-6.pk
	* testsuite/poke.pkl/sl-integers-7.pk: Rename from sl-7.pk
	* testsuite/poke.pkl/sl-integers-8.pk: Rename from sl-8.pk
	* testsuite/poke.pkl/sl-integers-9.pk: Rename from sl-9.pk
	* testsuite/poke.pkl/sl-integers-10.pk: Rename from sl-10.pk
	* testsuite/poke.pkl/sl-integers-11.pk: Rename from sl-11.pk
	* testsuite/poke.pkl/sl-integers-12.pk: Rename from sl-12.pk
	* testsuite/poke.pkl/sl-offsets-1.pk: New test.
	* testsuite/poke.pkl/sr-offsets-2.pk: Likewise.
	* testsuite/poke.pkl/sr-offsets-1.pk: Likewise.
	* testsuite/poke.pkl/sr-integers-2.pk: Likewise.
	* testsuite/poke.pkl/sr-integers-1.pk: Likewise.
	* testsuite/poke.pkl/sl-offsets-2.pk: Likewise.

2020-03-02  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-asm.c (pkl_asm_insn_binop): Remove gratuitous
	conditional.

2020-03-01  Jose E. Marchesi  <jemarch@gnu.org>

	* TODO: New task.

2020-03-01  Jose E. Marchesi  <jemarch@gnu.org>

	* pickles/bpf.pk (BPF_Insn_Offset): Fix offset type.

2020-03-01  Jose E. Marchesi  <jemarch@gnu.org>

	* src/poke.c (parse_args): Emit an error message if the specified
	data file cannot be opened.

2020-03-01  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-promo.c (pkl_promo_ps_op_binary_intoffstr): Renamed from
	pkl_promo_ps_op_add_sub_mod.
	(pkl_promo_ps_op_bshiftpow): Promote offset operand.
	* src/pkl-typify.c: ior, xor and band accept both integers and
	offsets as arguments.
	* src/pkl-gen.c (pkl_gen_ps_op_binexp): Renamed from
	pkl_gen_ps_op_intexp, and allow offsets for all operations.
	(pkl_gen_ps_op_pow): Remove.
	* src/pkl-asm.c (pkl_asm_insn_binop): Renamed from
	pkl_asm_insn_binop, and expanded to support binary offset
	macro-instructions.
	* src/pkl-typify.c (pkl_typify1_ps_bshift_pow): New handler.
	* testsuite/poke.pkl/pow-integers-1.pk: Renamed from pow-1.pk.
	* testsuite/poke.pkl/pow-integers-2.pk: Renamed from pow-2.pk.
	* testsuite/poke.pkl/pow-integers-3.pk: Renamed from pow-3.pk.
	* testsuite/poke.pkl/xor-integers-1.pk: Renamed from xor-1.pk
	* testsuite/poke.pkl/xor-integers-2.pk: Renamed from xor-2.pk
	* testsuite/poke.pkl/ior-integers-1.pk: Renamed from ior-1.pk.
	* testsuite/poke.pkl/ior-integers-2.pk: Renamed from ior-2.pk.
	* testsuite/poke.pkl/band-integers-1.pk: Renamed from band-1.pk.
	* testsuite/poke.pkl/band-integers-2.pk: Renamed from band-2.pk.
	* testsuite/poke.pkl/band-offsets-1.pk: New test.
	* testsuite/poke.pkl/band-offsets-2.pk: Likewise.
	* testsuite/poke.pkl/ior-offsets-1.pk: Likewise.
	* testsuite/poke.pkl/ior-offsets-2.pk: Likewise.
	* testsuite/poke.pkl/xor-offsets-1.pk: Likewise.
	* testsuite/poke.pkl/xor-offsets-2.pk: Likewise.
	* testsuite/poke.pkl/pow-diag-1.pk: Likewise.
	* testsuite/poke.pkl/sr-diag-1.pk: Likewise.
	* testsuite/poke.pkl/sl-diag-4.pk: Likewise.
	* testsuite/poke.pkl/sr-diag-2.pk: Likewise.
	* testsuite/poke.pkl/sl-diag-5.pk: Likewise.
	* testsuite/poke.pkl/pow-diag-2.pk: Likewise.
	* testsuite/poke.pkl/pow-offsets-1.pk: Likewise.
	* testsuite/poke.pkl/pow-offsets-2.pk: Likewise.
	* testsuite/poke.pkl/pow-offsets-3.pk: Likewise.
	* TODO: Update.

2020-03-01  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pvm.jitter: Remove trailing whitespaces.
	* src/pkl-fold.c: Likewise.
	* src/pk-editor.c (STREQ): Define.
	(pk_cmd_editor): use STREQ instead of strcmp.

2020-03-01  Jose E. Marchesi  <jemarch@gnu.org>

	* src/std.pk: Define standard units using the power operator, and
	use the same prefixes than coreutils.
	* src/pvm-val.h (PVM_VAL_OFF_UNIT_GIGABYTES): Define.
	(PVM_VAL_OFF_UNIT_KIBIBITS): Likewise.
	(PVM_VAL_OFF_UNIT_KIBIBYTES): Likewise.
	(PVM_VAL_OFF_UNIT_MEBIBITS): Likewise.
	(PVM_VAL_OFF_UNIT_MEBIBYTES): Likewise.
	(PVM_VAL_OFF_UNIT_KILOBITS): Changed to base 10.
	(PVM_VAL_OFF_UNIT_KILOBYTES): Likewise.
	(PVM_VAL_OFF_UNIT_MEGABITS): Likewise.
	(PVM_VAL_OFF_UNIT_MEGABYTES): Likewise.
	(PVM_VAL_OFF_UNIT_GIGABITS): Likewise.
	* src/pvm-val.c (pvm_print_val): Fix unit names.
	(print_unit_name): New function.
	(pvm_print_val): Use print_unit_name.
	* testsuite/poke.pkl/ass-offset-1.pk: Adjust test to new units.
	* testsuite/poke.pkl/promo-offset-arg-2.pk: Likewise.
	* testsuite/poke.pkl/promo-offset-arg-1.pk: Likewise.
	* testsuite/poke.pkl/offsets-53.pk: Likewise.
	* testsuite/poke.pkl/mod-offsets-diag-1.pk: Likewise.
	* testsuite/poke.pkl/div-offsets-diag-2.pk: Likewise.
	* testsuite/poke.pkl/units-8.pk: New test.

2020-03-01  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-ops.def (PKL_AST_OP_POW): New operator.
	* src/pkl-tab.y (POW): New token.
	(expression): New rule alternative for exponentiation.
	* src/pkl-lex.l: Handle POW.
	* src/pkl-typify.c: Handle the exponent operator.
	* src/pkl-fold.c: Likewise.
	* src/pkl-promo.c: Likewise.
	(pkl_promo_ps_op_bshiftpow): Renamed from pkl_promo_ps_op_bshift.
	* src/pvm.jitter (PVM_POWOP): Define.
	(powi): New instruction.
	(powiu): Likewise.
	(powl): Likewise.
	(powlu): Likewise.
	* src/pkl-insn.def (PKL_INSN_POWI): Define
	(PKL_INSN_POWIU): Likewise.
	(PKL_INSN_POWL): Likewise.
	(PKL_INSN_POWLU): Likewise.
	(PKL_INSN_POW): Likewise.
	* src/pkl-asm.c (pkl_asm_insn_intop): Implement the pow
	macro-instruction.
	(pkl_asm_insn): Handle PKL_INSN_POW.
	* src/pkl-gen.c (pkl_gen_ps_op_pow): New handler.
	* src/pk-utils.h: Prototypes for pk_ipow and pk_upow.
	* src/pk-utils.c (pk_ipow): New function.
	(pk_upow): Likewise.
	* testsuite/poke.pkl/pow-1.pk: New test.
	* testsuite/poke.pkl/pow-2.pk: Likewise.
	* testsuite/poke.pkl/pow-3.pk: Likewise.
	* doc/poke.texi (Arithmetic Operators): Mention the exponentiation
	operator.

2020-02-29  John Darrington <john@darrington.wattle.id.au>

	* src/pk-editor.c (pk_cmd_editor):  Correctly test
	the output from find_in_path:  if the program is not
	found, it returns its argument verbatim.

2020-02-29  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-tab.y (DEFUNIT): New token.
	* src/pkl-lex.l (DEFUNIT): Likewise.
	* src/pk-cmd.c (pk_cmd_exec): Recognize defunit.
	* src/pkl-env.h (PKL_ENV_NS_MAIN): Define.
	(PKL_ENV_NS_UNITS): Likewise.
	* src/pkl-env.c (struct pkl_env): New field units_hash_table.
	(pkl_env_free): Handle units_hash_table.
	(pkl_env_dup_toplevel): Handle the units hash table.
	(pkl_env_lookup): Get a new argument `namespace'.
	(pkl_env_lookup_1): Likewise.
	(pkl_env_register): Likewise.
	(get_ns_table): New function.
	(pkl_env_lookup_1): Handle `namespace'.
	(struct pkl_env): New field num_units.
	* src/pkl-lex.l: Pass namespace to pkl_env_lookup.
	* src/pkl-tab.y: Likewise.
	* src/pk-def.c (print_var_decl): Likewise.
	* src/pk-repl.c (pkl_complete_struct): Likewise.
	* src/pk-vm.c (pk_cmd_vm_disas_fun): Likewise.
	(pk_cmd_vm_disas_fun): Likewise.
	* src/pkl-ast.h (PKL_AST_DECL_KIND_UNIT): Define.
	* src/pkl-ast.c (pkl_ast_id_to_offset_unit): Remove function.
	* src/pkl-anal.c (pkl_anal1_ps_decl): New handler.
	(pkl_phase_anal1): Install new handler.
	* src/pkl-typify.c (pkl_typify1_ps_decl): New handler.
	(pkl_phase_typify1): Install new handler.
	* src/pkl-trans.c (pkl_trans1_ps_offset): Do not handle
	identifiers in offset units.
	(pkl_trans1_ps_type_offset): Remove.
	(pkl_trans2_ps_offset_type): Fix error location.
	* src/pkl-fold.c (pkl_fold_ps_cast): Do not overwrite unit nodes
	while constant-folding offset casts.  Create a new node instead.
	* src/pkl-gen.c (pkl_gen_pr_decl): Handle PKL_AST_DECL_KIND_UNIT.
	* src/pkl-asm.c (pkl_asm_call): Pass a namespace to
	pkl_env_lookup.
	* src/std.pk (b,N,B,Kb,KB,Mb,MB,Gb,GB): Define units.
	* testsuite/poke.pkl/units-1.pk: New test.
	* testsuite/poke.pkl/units-2.pk: Likewise.
	* testsuite/poke.pkl/units-3.pk: Likewise.
	* testsuite/poke.pkl/units-4.pk: Likewise.
	* testsuite/poke.pkl/units-5.pk: Likewise.
	* testsuite/poke.pkl/units-6.pk: Likewise.
	* testsuite/poke.pkl/units-diag-1.pk: Likewise.
	* testsuite/poke.pkl/units-diag-2.pk: Likewise.
	* testsuite/poke.pkl/units-diag-3.pk: Likewise.
	* doc/poke.texi (Offset Units): New section.
	(Standard Units): New chapter.

2020-02-29  John Darrington <john@darrington.wattle.id.au>

	* src/pk-editor.c (pk_cmd_editor): Do nothing if poke is not running
	interactively.

2020-02-29  John Darrington <john@darrington.wattle.id.au>

	* src/poke.c (parse_args): Set poke_interactive_p before any statements
	which might want to test it.

2020-02-27  Eric Blake  <eblake@redhat.com>

	ios: Drop Position column from .info ios
	* src/pk-ios.c (pk_cmd_info_ios, print_info_ios): Simplify.
	* src/ios.c (ios_tell): Delete.
	* src/ios.h (ios_tell): Likewise.
	* doc/poke.texi (info command): Update output.
	* testsuite/poke.cmd/file-mode.pk: Likewise.
	* testsuite/poke.cmd/file-relative.pk: Likewise.

2020-02-23  John Darrington <john@darrington.wattle.id.au>

	* src/pk-cmd.c (pk_cmd_exec_1)[case 'f']: Remove a lot
	of code which seems to serve no useful purpose.
	* src/pk-repl.c (escape_metacharacters): New function.
	* src/pk-repl.c (pk_repl): Initialize various readling
	parameters.

2020-02-27  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-lex.l: Set errno to 0 before calling strtoull.

2020-02-27  Jose E. Marchesi  <jemarch@gnu.org>

	* bootstrap.conf (gnulib_modules): Add module strtoull.
	* src/pkl-lex.l: Use strtoull instead of strtoll.
	* src/pkl-tab.y: Improve error message on integer overflow.

2020-02-27  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-tab.y (INTEGER_OVERFLOW): New token.
	(primary): Accept INTEGER_OVERFLOW as a primary.
	* src/pkl-lex.l: Return INTEGER_OVERFLOW whenever appropriate.
	* testsuite/poke.pkl/integers-diag-1.pk: New test.

2020-02-27  Jose E. Marchesi  <jemarch@gnu.org>

	* TODO: Update.

2020-02-26  Eric Blake  <eblake@redhat.com>

	open: Normalize tricky .file names.
	* src/ios-dev.h (struct ios_dev_if): Replace handler_p with
	handler_noramlize callback.
	* src/ios.c (ios_open): Store normalized name per ios.
	* src/ios-dev-file.c (ios_dev_file_handler_p): Rename...
	(ios_dev_file_handler_normalize): ...and prepend ./ to risky
	relative file names.
	* src/ios-dev-mem.c (ios_dev_mem_handler_p): Rename...
	(ios_dev_mem_handler_normalize): ...to this.
	(ios_dev_mem_open, ios_dev_mem_close): Drop unused handler member.
	* testsuite/poke.cmd/file-relative.pk: New test.

2020-02-26  Eric Blake  <eblake@redhat.com>

	* src/ios.c (ios_close): Avoid side-effect inside assert.
	* src/pk-def.c (print_var_decl, print_fun_decl): Likewise.
	* src/pk-term.c (pk_printf): Likewise.
	* src/pkl-asm.c (pkl_asm_call): Likewise.
	* src/pkl-tab.y (pkl_register_dummies): Likewise.
	* src/pkl.c (pkl_detailed_location): Likewise.

2020-02-26  Eric Blake  <eblake@redhat.com>

	* etc/git.orderfile (ChangeLog): Always list first.
	(Documentation): Correct spelling of doc/.
	(Build files): build-aux is not stored in git.

2020-02-25  Eric Blake  <eblake@redhat.com>

	* .gitignore: Ignore more testsuite leftovers.

2020-02-25  Eric Blake  <eblake@redhat.com>

	* src/pkl-tab.y (opt_comma): New rule.
	(array): Use it to simplify trailing comma in arrays.
	(struct, expression): Allow trailing comma in struct literals.
	* doc/poke.texi (Struct Literals): Document it.
	* testsuite/poke.pkl/structs-5.pk: Test it.
	* etc/poke.g4 (array, struct): Match the real grammar.

2020-02-25  Eric Blake  <eblake@redhat.com>

	maint: Fix syntax-check
	* .x-sc_prohibit_strncpy: Exempt pk-repl.c.
	* etc/poke.g4 (expression): Whitespace cleanups.
	* doc/poke.texi (String Concatenation): Likewise.
	* src/ios-dev-file.c (ios_dev_file_close): Likewise.
	* src/ios-dev-mem.c (ios_dev_mem_getc): Likewise.
	* src/ios.c: Likewise.
	* src/pk-hserver.c: Likewise.
	* src/pk-ios.c: Likewise.
	* src/pk-set.c: Likewise.
	* src/pkl-ast.c: Likewise.
	* src/pkl-ast.h: Likewise.
	* src/pkl-fold.c: Likewise.
	* src/pkl-insn.def: Likewise.
	* src/pkl-tab.y: Likewise.
	* src/pkl-typify.c: Likewise.
	* src/pvm.jitter: Likewise.
	* testsuite/poke.pkl/structs-diag-1.pk: Likewise.

2020-02-25  Eric Blake  <eblake@redhat.com>

	maint: Saner diff output
	* .gitattributes: New file.
	* etc/git.orderfile: New file.
	* bootstrap.conf (bootstrap_post_import_hook): Set it up.

2020-02-25  Eric Blake  <eblake@redhat.com>

	* .gitignore: Allow './configure -C'.

2020-02-25  Eric Blake  <eblake@redhat.com>

	* doc/poke.texi (Assignments): Typo fix.

2020-02-25  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pk-ios.c (mem_cmd): Do not accept IOS tags in the .mem
	command.
	* doc/poke.texi (mem command): Update accordingly.
	(file command): Likewise, for .file.
	(info command): Use .ios instead of .file in example.

2020-02-25  Jose E. Marchesi  <jemarch@gnu.org>

	* HACKING (Write After Approval): Add Eric Blake.

2020-02-24  Eric Blake  <eblake@redhat.com>

	* src/pkl-tab.y (array): Allow trailing comma in arrays.
	* doc/poke.texi (Array Literals): Document it.
	* testsuite/poke.pkl/arrays-9.pk: New file, to test it.

2020-02-24  Eric Blake  <eblake@redhat.com>

	* .gitignore: Ignore files created during 'make check'.

2020-02-24  Eric Blake  <eblake@redhat.com>

	maint: add run script for easier uninstalled usage
	* run.in: New file.
	* configure.ac (AC_CONFIG_FILES): Use it to build 'run'.
	* Makefile.am (noinst_SCRIPTS): Include template in tarball.
	* HACKING (Running an Uninstalled Poke): Document it.
	* .gitignore: Exempt new file.

2020-02-24  Jose E. Marchesi  <jemarch@gnu.org>

	* HACKING (Running and Uninstalled Poke): Update to cover
	POKEPICKLESDIR.

2020-02-23  Bruno Haible  <bruno@clisp.org>

	HACKING: Tell where to find the DejaGnu documentation.
	* HACKING (Test framework): New section.

2020-02-23  Bruno Haible  <bruno@clisp.org>

	Avoid a test failure, when running the test suite as root.
	* testsuite/poke.cmd/file-mode.pk: Allow /etc/passwd to be opened
	read-write.

2020-02-23  Jose E. Marchesi  <jemarch@gnu.org>

	* etc/poke.g4 (funcall_stmt_arg): Remove empty lines at EOF.
	* testsuite/poke.pkl/funcall-13.pk: Likewise.
	* testsuite/poke.pkl/close-2.pk: Likewise.
	* src/pk-utils.c: Likewise.

2020-02-22  John Darrington <john@darrington.wattle.id.au>

	* src/pk-ios.c (count_io_spaces): delete.
	* src/pk-ios.c (close_completion_function): Rename
	to ios_completion_function.
	* src/pk-ios.c (ios_completion_function): Do not
	assume that IO tags are consecutive integers.
	* src/pk-ios.c (ios_cmd): Add new completer.

2020-02-22  John Darrington <john@darrington.wattle.id.au>

	* src/ios.c (ios_begin): New function.
	* src/ios.c (ios_end): New function.
	* src/ios.c (ios_next): New function.
	* src/ios.h (ios_begin): New declaration.
	* src/ios.h (ios_end): New declaration.
	* src/ios.h (ios_next): New declaration.

2020-02-21  Jose E. Marchesi  <jemarch@gnu.org>

	* testsuite/poke.pkl/sizeof-1.pk: New test.
	* testsuite/poke.pkl/sizeof-2.pk: Likewise.
	* testsuite/poke.pkl/sizeof-3.pk: Likewise.
	* testsuite/poke.pkl/sizeof-12.pk: Likewise.
	* testsuite/poke.pkl/sizeof-11.pk: Likewise.
	* testsuite/poke.pkl/sizeof-10.pk: Likewise.
	* testsuite/poke.pkl/sizeof-9.pk: Likewise.
	* testsuite/poke.pkl/sizeof-8.pk: Likewise.
	* testsuite/poke.pkl/sizeof-7.pk: Likewise.
	* testsuite/poke.pkl/sizeof-6.pk: Likewise.
	* testsuite/poke.pkl/sizeof-5.pk: Likewise.
	* testsuite/poke.pkl/sizeof-4.pk: Likewise.

2020-02-16  John Darrington <john@darrington.wattle.id.au>

	* src/pk-repl.c (poke_getc): Revert to poke_completion_function
	if no complete command is on the repl's command line.

2020-02-16  John Darrington <john@darrington.wattle.id.au>

	* src/pk-editor.c (null_complete_function): delete
	* src/pk-repl.c (null_complete_function): add (move from above)
	* src/pk-repl.c (poke_getc): Use null_complete_function as the
	default completer.

2020-02-16  John Darrington <john@darrington.wattle.id.au>

	* src/pk-def.c: Explicitly set completer member of struct pk_cmd
	typed variables to NULL.
        * src/pk-help.c: ditto
        * src/pk-ios.c:  ditto
        * src/pk-misc.c: ditto
        * src/pk-set.c:  ditto
        * src/pk-vm.c:   ditto

2020-02-19  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-gen.c (pkl_gen_pr_try_until_stmt): Emit sync instruction
	before jumping back.

2020-02-18  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-promo.c (pkl_promo_ps_op_mul): Support multiplication of
	an integer by string.
	* src/pkl-typify.c (pkl_typify1_ps_mul): Likewise.
	* src/pkl-gen.c (pkl_gen_ps_op_mul): Likewise.
	* src/pkl-fold.c (OP_BINARY_SIS): Define.
	(EMUL_SIS): Likewise.
	(pkl_fold_mul): Use OP_BINARY_SIS.
	* src/pkl-insn.def (PKL_INSN_MULS): Define.
	* src/pvm.jitter (muls): New instruction.
	* testsuite/poke.pkl/mul-strings-1.pk: New test.
	* testsuite/poke.pkl/mul-strings-2.pk: Likewise.
	* testsuite/poke.pkl/mul-strings-3.pk: Likewise.
	* testsuite/poke.pkl/mul-strings-4.pk: Likewise.
	* testsuite/poke.pkl/mul-strings-5.pk: Likewise.
	* doc/poke.texi (String Concatenation): Document the * operator
	for strings.

2020-02-18  Carlo Caione  <ccaione@baylibre.com>

	* .gitignore: ignore more files
	* .gitmodules: ignore dirty sub-repo

2020-02-18  Carlo Caione  <ccaione@baylibre.com>

	* src/pk-repl.c: Rework poke_sigint_handler()

2020-02-17  Carlo Caione  <ccaione@baylibre.com>

	* src/pk-repl.c (pkl_complete_struct): new auto-complete function
	* src/pkl-ast.c (pkl_struct_type_traverse): new helper function
	* src/pkl-ast.h: likewise

2020-02-14  Jose E. Marchesi  <jemarch@gnu.org>

	* testsuite/poke.cmd/set-oacutoff-2.pk: New test.
	* src/pvm-val.c (pvm_print_val): Apply acutoff also in arrays that
	are not inside other structs.

2020-02-14  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pk-set.c (pk_cmd_set_endian): Fix handling of optional
	argument.
	(pk_cmd_set_nenc): Likewise.
	(pk_cmd_set_omode): Likewise.

2020-02-14  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pk-cmd.c (pk_cmd_exec): Honour pvm_oacutoff when calling
	pvm_print_val.

2020-02-14  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pk-set.c (set_oacutoff_cmd): Make argument optional.
	(set_oindent_cmd): Likewise.
	(set_odepth_cmd): Likewise.
	(pk_cmd_set_oacutoff): Print the current array cutoff if the set
	command is invoked without arguments.
	(pk_cmd_set_odepth): Likewise.
	(pk_cmd_set_obase): Likewise.
	* testsuite/poke.cmd/set-oacutoff-1.pk: New test.
	* testsuite/poke.cmd/set-odepth-2.pk: Likewise.
	* testsuite/poke.cmd/set-obase-1.pk: Likewise.
	* testsuite/poke.cmd/set-obase-2.pk: Likewise.
	* testsuite/poke.cmd/set-obase-4.pk: Likewise.
	* testsuite/poke.cmd/set-obase-3.pk: Likewise.
	* testsuite/poke.cmd/set-obase-5.pk: Renamed from set-obase.pk.

2020-02-14  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-ast.h (PKL_AST_PRINT_STMT_ARG_PRINT_MODE): Define.
	(struct pkl_ast_print_stmt_arg): New field print_mode.
	(PKL_AST_PRINT_STMT_ARG_PRINT_DEPTH): Define.
	(struct pkl_ast_print_stmt_arg): New field print_depth.
	* src/pkl-trans.c (pkl_trans1_ps_print_stmt): Support for
	numerical prefix and flag T for the %v format tag.
	* src/pvm.jitter (printv): Accept two arguments MODE and DEPTH.
	* src/pkl-insn.def: Annotate printv to get two numerical
	arguments.
	* src/pkl-gen.c (pkl_gen_pr_print_stmt): Emit a printv
	instruction with the right mode and depth.
	* src/pvm-val.h (PVM_PRINT_F_DEPTH): Define.
	(PVM_PRINT_F_GET_DEPTH): Likewise.
	(PVM_PRINT_F_MODE): Likewise.
	(PVM_PRINT_F_GET_MODE): Likewise.
	(PVM_PRINT_F_INDENT): Likewise.
	(PVM_PRINT_F_GET_INDENT): Likewise.
	(PVM_PRINT_F_ACUTOFF): Likewise.
	(PVM_PRINT_F_GET_ACUTOFF): Likewise.
	* src/pvm-val.c (pvm_print_val): `flags' is an unsigned 32-bit
	integer.
	(pvm_print_val): Extract the desired printing depth from the
	`flags', `mode', `acutoff' and `indent' arguments.
	* src/pk-cmd.c (pk_cmd_exec): Pass mode/depth/indent to
	pvm_print_val.
	* src/pk-set.c (pk_cmd_set_odepth): Check that the odepth is
	between 0 and 15.
	(pk_cmd_set_oacutoff): Likewise for oacutoff.
	* doc/poke.texi (printf): Document the additional options for %v.
	* testsuite/poke.pkl/printf-diag-14.pk: Adjust.
	* testsuite/poke.pkl/printf-diag-15.pk: New test.
	* testsuite/poke.pkl/printf-diag-16.pk: Likewise.
	* testsuite/poke.pkl/printf-20.pk: Likewise.
	* testsuite/poke.pkl/printf-21.pk: Likewise.
	* testsuite/poke.pkl/printf-22.pk: Likewise.
	* testsuite/poke.pkl/printf-23.pk: Likewise.
	* testsuite/poke.pkl/printf-24.pk: Likewise.
	* testsuite/poke.pkl/printf-25.pk: Likewise.

2020-02-14  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pk-term.c (pk_term_indent): Get a new argument `step'.
	* src/pvm-val.c (pvm_print_val): Call pk_term_indent only if
	output mode is `tree', and pass the indentation step.

2020-02-13  Carlo Caione  <ccaione@baylibre.com>

	* doc/poke.texi: add documentation
	* src/pk-set.c: new set oacutoff command
	* testsuite/poke.cmd/set-oacutoff.pk: new test file
	* src/pvm.c: helpers to retrieve oacutoff flag
	* src/pvm.h: likewise
	* src/pvm.jitter: new flag in the PVM state struct
	* src/pvm-val.c: support new array cutoff parameter

2020-02-13  Jose E. Marchesi  <jemarch@gnu.org>

	* src/poke.c (initialize): Initialize the hyperserver only if poke
	is used interactively.
	(finalize): Ditto for finalize.

2020-02-13  Jose E. Marchesi  <jemarch@gnu.org>

	* src/ras (pop_frame): Fix typo.

2020-02-13  Jose E. Marchesi  <jemarch@gnu.org>

	* HACKING (Write After Approval): Added Carlo Caione.
	* AUTHORS: Likewise.

2020-02-13  Carlo Caione  <ccaione@baylibre.com>

	* testsuite/poke.cmd/set-odepth.pk: new test
	* testsuite/poke.cmd/set-oindent.pk: likewise
	* testsuite/poke.cmd/set-odepth.pk: likewise
	* src/pvm.jitter: new flags in the PVM state struct
	* src/pvm.c: helpers to retrieve tree-related flags
	* src/pvm.h: likewise
	* src/pvm-val.c: support new printing modes
	* src/pk-term.c: new function to print indentation
	* src/pk-term.h: likewise
	* src/pk-set.c: new .set sub-commands
	* doc/poke.texi: updated documentation

2020-02-13  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-tab.y (load_module): Try to load modules from both
	poke_datadir and poke_picklesdir.
	* src/pk-cmd.c (pk_cmd_init): Do not load commands written in Poke
	from C.  Do it in pk-cmd.pk instead.
	* src/pk-cmd.pk: Load commands written in Poke.

2020-02-13  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-tab.y (load): Add a LOAD STRING syntactic variant.
	(load_module): Get a filename_p argument.
	* doc/poke.texi (Modules): Document the alternate syntax for
	`load'.
	* testsuite/poke.pkl/load-4.pk: New test.
	* testsuite/poke.pkl/load-diag-2.pk: Likewise.

2020-02-13  Jose E. Marchesi  <jemarch@gnu.org>

	* testsuite/poke.pkl/funcall-3.pk: Split from funcall.pk.
	* testsuite/poke.pkl/funcall-14.pk: Likewise.
	* testsuite/poke.pkl/funcall-13.pk: Likewise.
	* testsuite/poke.pkl/funcall-12.pk: Likewise.
	* testsuite/poke.pkl/funcall-11.pk: Likewise.
	* testsuite/poke.pkl/funcall-10.pk: Likewise.
	* testsuite/poke.pkl/funcall-9.pk: Likewise.
	* testsuite/poke.pkl/funcall-8.pk: Likewise.
	* testsuite/poke.pkl/funcall-7.pk: Likewise.
	* testsuite/poke.pkl/funcall-6.pk: Likewise.
	* testsuite/poke.pkl/funcall-5.pk: Likewise.
	* testsuite/poke.pkl/funcall-4.pk: Likewise.

2020-02-13  Jose E. Marchesi  <jemarch@gnu.org>

	* doc/poke.texi (Shebang): Document the shebang style that allows
	passing more arguments to poke.

2020-02-12  Jose E. Marchesi  <jemarch@gnu.org>

	* testsuite/Makefile.am (POKEDATADIR): Define.

2020-02-12  Jose E. Marchesi  <jemarch@gnu.org>

	* src/poke.c (parse_args): Handle -L after the data files
	specified in the command line are loaded.

2020-02-12  Jose E. Marchesi  <jemarch@gnu.org>

	* testsuite/poke.pkl/load-1.pk: New test.
	* testsuite/poke.pkl/load-2.pk: Likewise.
	* testsuite/poke.pkl/load-3.pk: Likewise.
	* testsuite/poke.pkl/load-diag-1.pk: Likewise.
	* doc/poke.texi (Modules): New chapter.

2020-02-12  Jose E. Marchesi  <jemarch@gnu.org>

	* src/poke.h (poke_picklesdir): New variable.
	* src/poke.c (initialize): Initialize poke_picklesdir.
	* src/pkl-lex.l: Recognize the token LOAD.
	* src/pkl-tab.y (load): New rule.
	(program_elem): New alternative `load'.
	(LOAD): New token.
	(load_module): New auxiliary function.
	* src/pk-ios.c: Include pk-utils.h.
	(pk_file_readable): Moved to pk-utils.c.
	* src/Makefile.am (poke_SOURCES): Add pk-utils.[hc].
	* src/pk-utils.h: New file.
	* src/pk-utils.c: Likewise.
	* pickles/ctf.pk: load elf.
	* HACKING (Appendix): List pk-utils.c and pk-utils.h.

2020-02-11  Jose E. Marchesi  <jemarch@gnu.org>

	* doc/poke.texi (Bitwise Operators): Document the behavior of the
	shifting operators.

2020-02-11  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-anal.c (pkl_anal1_ps_op_sl): New handler.
	(pkl_phase_anal1): Install handler.
	* testsuite/poke.pkl/sl-diag-1.pk: New test.
	* testsuite/poke.pkl/sl-diag-2.pk: Likewise.
	* testsuite/poke.pkl/sl-diag-3.pk: Likewise.
	* testsuite/poke.pkl/sl-9.pk: Likewise.
	* testsuite/poke.pkl/sl-10.pk: Likewise.
	* testsuite/poke.pkl/sl-11.pk: Likewise.
	* testsuite/poke.pkl/sl-12.pk: Likewise.
	* testsuite/poke.pkl/sl-5.pk: Adapt to new semantics.
	* testsuite/poke.pkl/sl-6.pk: Likewise.
	* src/pvm.jitter (PVM_BINOP_SL): Define.

2020-02-04  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-fold.c: Constant folding for bit shifts.
	* testsuite/poke.pkl/sl-1.pk: Test constant folding.
	* testsuite/poke.pkl/sl-2.pk: Likewise.
	* testsuite/poke.pkl/sl-3.pk: Likewise.
	* testsuite/poke.pkl/sl-4.pk: Likewise.
	* testsuite/poke.pkl/sl-5.pk: Likewise.
	* testsuite/poke.pkl/sl-6.pk: Likewise.
	* testsuite/poke.pkl/sl-7.pk: Likewise.
	* testsuite/poke.pkl/sl-8.pk: Likewise.

2020-02-11  Jose E. Marchesi  <jemarch@gnu.org>

	* testsuite/poke.pkl/arrays-8.pk: New test
	* testsuite/poke.pkl/arrays-diag-1.pk: Likewise.
	* testsuite/poke.pkl/arrays-diag-2.pk: Likewise.
	* testsuite/poke.pkl/arrays-diag-3.pk: Likewise.

2020-02-10  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-tab.y (array_initializer): Support expressions in .[]
	constructions in array initializers.
	* src/pkl-anal.c (pkl_anal2_ps_array): New handler.
	* src/pkl-trans.c (pkl_trans2_ps_array): Moved from trans1.
	* src/pkl-typify.c (pkl_typify2_ps_ass_stmt): Moved from typify1.
	* testsuite/poke.pkl/arrays-6.pk: New test.

2020-02-08  John Darrington <john@darrington.wattle.id.au>

	* src/pk-editor.c (pk_cmd_editor): Fix memory leak.

2020-02-07  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pvm.jitter: Add comments to instruction definitions.

2020-02-07  Jose E. Marchesi  <jemarch@gnu.org>

	* testsuite/poke.pkl/ass-2.pk: New file.
	* testsuite/poke.pkl/ass-8.pk: Likewise.
	* testsuite/poke.pkl/ass-7.pk: Likewise.
	* testsuite/poke.pkl/ass-6.pk: Likewise.
	* testsuite/poke.pkl/ass-5.pk: Likewise.
	* testsuite/poke.pkl/ass-4.pk: Likewise.
	* testsuite/poke.pkl/ass-3.pk: Likewise.

2020-02-07  Jose E. Marchesi  <jemarch@gnu.org>

	* TODO (fold bconc expressions): Task done.
	(fold array subscripts): Likewise.
	(fold .<< and .>> expressions): Likewise.

2020-02-06  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-ast.h (enum pkl_ast_code): Define PKL_AST_LAST_EXP.

2020-02-06  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-ast.c (pkl_ast_lvalue_p): Fix logic to avoid assignments
	to values.
	* testsuite/poke.pkl/ass-diag-6.pk: New test.
	* testsuite/poke.pkl/ass-1.pk: Likewise
	* testsuite/poke.pkl/ass-diag-7.pk: Likewise..
	* testsuite/poke.pkl/ass-diag-8.pk: Likewise.

2020-02-06  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-fold.c (pkl_fold_ps_cond_exp): New handler.

2020-02-06  Jose E. Marchesi  <jemarch@gnu.org>

	* doc/poke.texi (Conditional Expression): New section.

2020-02-06  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-gen.c (pkl_gen_pr_cond_exp): New handler.
	(pkl_phase_gen): Install handler.
	* testsuite/poke.pkl/cond-exp-1.pk: New file.
	* testsuite/poke.pkl/cond-exp-2.pk: Likewise.

2020-02-05  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-typify.c (pkl_typify1_ps_cond_exp): New handler.
	(pkl_phase_typify1): Install it.
	* src/pkl-tab.y (expression): New rule for the ternary conditional
	operator.
	* src/pkl-promo.c (pkl_promo_ps_cond_exp): New handler.
	(pkl_phase_promo): Install handler.
	* testsuite/poke.pkl/cond-exp-diag-1.pk: New file.
	* testsuite/poke.pkl/cond-exp-diag-3.pk: Likewise.
	* testsuite/poke.pkl/cond-exp-diag-2.pk: Likewise.

2020-02-05  Jose E. Marchesi  <jose.marchesi@oracle.com>

	* testsuite/poke.pkl/structs-diag-1.pk: New test.
	* testsuite/poke.pkl/struct-types-diag-11.pk: Likewise.

2020-02-05  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-promo.c (pkl_promo_ps_map): Add missing ICE.

2020-02-05  Jose E. Marchesi  <jemarch@gnu.org>

	* testsuite/poke.pkl/printf-diag-9.pk: New test.
	* testsuite/poke.pkl/printf-diag-10.pk: Likewise.
	* testsuite/poke.pkl/printf-diag-11.pk: Likewise.
	* testsuite/poke.pkl/printf-diag-12.pk: Likewise.
	* testsuite/poke.pkl/printf-diag-13.pk: Likewise.
	* testsuite/poke.pkl/printf-1.pk: Likewise.
	* testsuite/poke.pkl/printf-18.pk: Likewise.
	* testsuite/poke.pkl/printf-17.pk: Likewise.
	* testsuite/poke.pkl/printf-16.pk: Likewise.
	* testsuite/poke.pkl/printf-15.pk: Likewise.
	* testsuite/poke.pkl/printf-14.pk: Likewise.
	* testsuite/poke.pkl/printf-13.pk: Likewise.
	* testsuite/poke.pkl/printf-12.pk: Likewise.
	* testsuite/poke.pkl/printf-11.pk: Likewise.
	* testsuite/poke.pkl/printf-10.pk: Likewise.
	* testsuite/poke.pkl/printf-9.pk: Likewise.
	* testsuite/poke.pkl/printf-8.pk: Likewise.
	* testsuite/poke.pkl/printf-7.pk: Likewise.
	* testsuite/poke.pkl/printf-6.pk: Likewise.
	* testsuite/poke.pkl/printf-5.pk: Likewise.
	* testsuite/poke.pkl/printf-4.pk: Likewise.
	* testsuite/poke.pkl/printf-3.pk: Likewise.
	* testsuite/poke.pkl/printf-2.pk: Likewise.
	* testsuite/poke.pkl/offset-type-diag-4.pk: Likewise.
	* testsuite/poke.pkl/string-diag-1.pk: Likewise.
	* testsuite/poke.pkl/printf-class-diag-1.pk: Likewise.
	* testsuite/poke.pkl/printf-diag-14.pk: Likewise.
	* testsuite/poke.map/maps-structs-methods-8.pk: Likewise.
	* testsuite/poke.pkl/offset-type-diag-5.pk: Likewise.
	* testsuite/poke.pkl/structs-3.pk: Likewise.
	* testsuite/poke.pkl/structs-2.pk: Likewise.
	* testsuite/poke.pkl/structs-1.pk: Likewise.

2020-02-05  Jose E. Marchesi  <jemarch@gnu.org>

	* testsuite/poke.pkl/attr-size-12.pk: Renamed from attrs.pk
	* testsuite/poke.pkl/attr-size-1.pk: New test.
	* testsuite/poke.pkl/attr-length-5.pk: Likewise.
	* testsuite/poke.pkl/attr-length-4.pk: Likewise.
	* testsuite/poke.pkl/attr-length-3.pk: Likewise.
	* testsuite/poke.pkl/attr-length-2.pk: Likewise.
	* testsuite/poke.pkl/attr-length-1.pk: Likewise.
	* testsuite/poke.pkl/attr-signed-2.pk: Likewise.
	* testsuite/poke.pkl/attr-signed-1.pk: Likewise.
	* testsuite/poke.pkl/attr-magnitude-1.pk: Likewise.
	* testsuite/poke.pkl/attr-unit-1.pk: Likewise.
	* testsuite/poke.pkl/attr-size-11.pk: Likewise.
	* testsuite/poke.pkl/attr-size-10.pk: Likewise.
	* testsuite/poke.pkl/attr-size-9.pk: Likewise.
	* testsuite/poke.pkl/attr-size-8.pk: Likewise.
	* testsuite/poke.pkl/attr-size-7.pk: Likewise.
	* testsuite/poke.pkl/attr-size-6.pk: Likewise.
	* testsuite/poke.pkl/attr-size-5.pk: Likewise.
	* testsuite/poke.pkl/attr-size-4.pk: Likewise.
	* testsuite/poke.pkl/attr-size-3.pk: Likewise.
	* testsuite/poke.pkl/attr-size-2.pk: Likewise.
	* testsuite/poke.pkl/attr-diag-1.pk: Likewise.

2020-02-05  Jose E. Marchesi  <jemarch@gnu.org>

	* testsuite/poke.pkl/strings-4.pk: New test.

2020-02-05  Jose E. Marchesi  <jemarch@gnu.org>

	* testsuite/poke.map/maps-structs-endian-2.pk: New test.
	* src/pkl-gen.pks (struct_field_writer): Honour the struct field
	endianness while writing.

2020-02-05  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-gen.c (pkl_gen_pr_decl): Fix bug that causes to rebuild
	array writers at every usage.

2020-02-05  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-insn.def: Entries for iogetb and iosetb.
	* src/pvm.jitter (iogetb): New instruction.

2020-02-05  Jose E. Marchesi  <jemarch@gnu.org>

	* src/ios.h: Prototypes for ios_get_bias and ios_set_bias.
	* src/ios.c (struct ios): New field `bias'.
	(ios_open): Initialize the IOS bias to 0.
	(ios_get_bias): New function.
	(ios_set_bias): Likewise.
	(ios_read_int): Apply the IOS bias.
	(ios_read_uint): Likewise.
	(ios_read_string): Likewise.
	(ios_write_int): Likewise.
	(ios_write_uint): Likewise.
	(ios_write_string): Likewise.

2020-02-04  Jose E. Marchesi  <jemarch@gnu.org>

	* testsuite/poke.pkl/cdiv-integers-diag-1.pk: New test.

2020-02-04  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-gen.c (pkl_gen_pr_op_or): Normalize result to 1 or 0.
	(pkl_gen_pr_op_and): Likewise.
	* testsuite/poke.pkl/eq-integers-3.pk: New test.
	* testsuite/poke.pkl/eq-integers-4.pk: Likewise.
	* testsuite/poke.pkl/not-5.pk: Likewise.
	* testsuite/poke.pkl/sub-integers-5.pk: Likewise.
	* testsuite/poke.pkl/xor-2.pk: Likewise.
	* testsuite/poke.pkl/ior-2.pk: Likewise.
	* testsuite/poke.pkl/and-14.pk: Likewise.
	* testsuite/poke.pkl/or-5.pk: Likewise.
	* testsuite/poke.pkl/bnot-integers-3.pk: Likewise.
	* testsuite/poke.pkl/bnot-integers-4.pk: Likewise.
	* testsuite/poke.pkl/mod-integers-3.pk: Likewise.
	* testsuite/poke.pkl/cdiv-integers-3.pk: Likewise.
	* testsuite/poke.pkl/div-integers-3.pk: Likewise.
	* testsuite/poke.pkl/ge-integers-4.pk: Likewise.
	* testsuite/poke.pkl/le-integers-4.pk: Likewise.
	* testsuite/poke.pkl/gt-integers-3.pk: Likewise.
	* testsuite/poke.pkl/lt-integers-3.pk: Likewise.
	* testsuite/poke.pkl/ge-offsets-5.pk: Likewise.
	* testsuite/poke.pkl/le-offsets-4.pk: Likewise.
	* testsuite/poke.pkl/lt-offsets-5.pk: Likewise.
	* testsuite/poke.pkl/neq-offsets-5.pk: Likewise.
	* testsuite/poke.pkl/eq-offsets-7.pk: Likewise.
	* testsuite/poke.pkl/gt-offsets-5.pk: Likewise.
	* testsuite/poke.pkl/and-15.pk: Likewise.
	* testsuite/poke.pkl/mul-offsets-10.pk: Likewise.

2020-02-03  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pk-ios.c (ios_cmd): Define.
	(pk_cmd_ios): New function.
	(pk_cmd_file): Do not accept tag arguments.
	(pk_cmd_mem): Likewise.
	* src/pk-cmd.c (ios_cmd): Define.
	(dot_cmds): Add ios_cmd.
	* doc/poke.texi (ios command): New chapter.
	* testsuite/poke.pkl/ios-1.pk: New test.

2020-02-03  Egeyar Bagcioglu  <egeyar@gmail.com>

	* pickles/ctf.pk: Correct the filename on the first line of the file.
	* src/ios-dev-mem.c: Likewise.
	* src/ios.h: Fix typo.

2020-02-03  Jose E. Marchesi  <jemarch@gnu.org>

	* bootstrap.conf (gnulib_modules): Import pmccabe2html module.
	* Makefile.am (cyclo-$(PACKAGE).html): New target.
	* HACKING (Maintenance): Document make cyclo-poke.html.

2020-02-03  Jose E. Marchesi  <jemarch@gnu.org>

	* src/ios-dev-file.c (ios_dev_file_close): Free the IOD structure.
	* src/ios-dev-mem.c (ios_dev_mem_close): Likewise.
	* testsuite/poke.pkl/close-2.pk: New test.

2019-11-06  Darshit Shah  <darnir@gnu.org>

	* src/pk-hserver.c (read_from_client): Fix off by one when terminating
	the string
	* src/pk-file.c (print_info_file): Fix errors introduced when merging
	master into the hyperserver branch.

2019-11-06  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pk-file.c (print_info_file): Use terminal hyperlinks if
	available.

2019-11-06  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pk-hserver.c (pk_hserver_get_token): New function.
	(pk_hserver_make_hyperlink): Likewise.
	(pk_hserver_port): New function.
	* src/pk-repl.c (pk_repl): Emit an hyperlink for .help.
	* src/pk-term.c (pk_term_hyperlink): Fix guard.
	(pk_term_end_hyperlink): Likewise.

2019-11-06  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pk-repl.h: New file.
	* src/pk-repl.c: Likewise.
	* src/Makefile.am (poke_SOURCES): Add pk-repl.h and pk-repl.c.
	* src/poke.c (repl): Remove function.
	(main): Call pk_repl instead of repl.

2019-11-05  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pk-hserver.h: New file.
	* src/pk-hserver.c: Likewise.
	* src/poke.c: Initialize and finalize the hyperlinks server.
	* configure.ac: Add support for --enable-hserver and set the
	HSERVER automake conditional.
	* src/Makefile.am (poke_SOURCES): Add pk-hserver.h and
	pk-hserver.c.
	(poke_LDADD): Link with pthreads if the server is enabled.
	* HACKING (Appendix: The Source Tree): list server files.

2019-11-03  Jose E. Marchesi  <jemarch@gnu.org>

	* bootstrap.conf (gnulib_modules): Import the socket, bind and
	accept modules from gnulib.

2019-11-03  Jose E. Marchesi  <jemarch@gnu.org>,

	* bootstrap.conf (gnulib_modules): Import the `pthread' module
	from gnulib.

2020-02-02  Jose E. Marchesi  <jemarch@gnu.org>

	* testsuite/poke.cmd/copy-5.pk: New test.

2020-02-02  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pk-copy.pk: New file.
	* src/Makefile.am (dist_pkgdata_DATA): Add pk-copy.pk.
	* HACKING (Appendix): Mention pk-copy.pk.
	* src/pk-cmd.c (pk_cmd_init): Load pk-copy.pk.
	* src/pk-save.pk (save): Use copy.
	* testsuite/poke.cmd/copy-1.pk: New test.
	* testsuite/poke.cmd/copy-2.pk: Likewise.
	* testsuite/poke.cmd/copy-3.pk: Likewise.
	* testsuite/poke.cmd/copy-4.pk: Likewise.
	* doc/poke.texi (copy): New chapter.

2020-02-02  Jose E. Marchesi  <jemarch@gnu.org>

	* src/ios-dev-file.c (ios_dev_file_open): Remove handling of
	file://.
	* src/ios-dev-mem.c: New file.
	* src/Makefile.am (poke_SOURCES): Add ios-dev-mem.c.
	* src/ios.c (ios_dev_ifs): Register ios_dev_mem.
	* doc/poke.texi (open): Document memory buffer IOS.
	(info command): Updated.
	* testsuite/poke.pkl/open-2.pk: New file.
	* testsuite/poke.pkl/ios-mem-1.pk: Likewise.
	* testsuite/poke.pkl/ios-mem-2.pk: Likewise.
	* src/pk-misc.c (pk_cmd_mem): New function.
	* src/pk-cmd.c (dot_cmds): Register .mem.
	* src/pk-ios.c: Renamed from pk-file.c.
	* testsuite/poke.cmd/file-mode.pk: Updated.
	* doc/poke.texi (mem command): New chapter.

2020-02-02  Jose E. Marchesi  <jemarch@gnu.org>

	* src/ios-dev.h (IOD_ERROR): Define.
	(IOD_EINVAL): Likewise.
	* src/ios.h (IOS_EFLAGS): Likewise.
	(struct ios_dev_if): Add an `error' argument to `open'.
	* src/ios-dev-file.c (ios_dev_file_open): Adapt to interface
	change.
	* src/ios.c (ios_open): Return IOS_EFLAGS in case of invalid
	flags.
	* src/pvm.h (PVM_E_IOFLAGS): Define.
	* src/pkl-rt.pk (E_io_flags): Likewise.
	(_pkl_exception_handler): Handle E_io_flags.
	* src/pvm.jitter (open): Raise PVM_E_IOFLAGS whenever necessary.

2020-02-02  John Darrington <john@darrington.wattle.id.au>

	* bootstrap.conf (gnulib_modules): Add findprog.
	* src/pk-editor.c (pk_cmd_editor): Default to "sensible-editor"
	if the EDITOR variable is not set.

2020-02-02  Jose E. Marchesi  <jemarch@gnu.org>

	* testsuite/poke.cmd/save-1.pk: New file.

2020-02-02  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-rt.pk (IOS_F_APPEND): Remove.
	* src/ios.h (IOS_F_APPEND): Likewise.
	* src/ios-dev-file.c (ios_dev_file_open): Do not use "a" modes in
	fopen.
	* doc/poke.texi (open): Update.

2020-02-02  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pk-save.pk: New file.
	* src/pk-cmd.c (pk_cmd_init): Load pk-save.pk
	* src/Makefile.am (dist_pkgdata_DATA): Add pk-save.pk.
	* doc/poke.texi (save): New chapter.

2020-02-02  Jose E. Marchesi  <jemarch@gnu.org>

	* src/ios.h (IOS_M_RDONLY): Use parenthesis in macro definition.
	(IOS_M_WRONLY): Likewise.
	(IOS_M_RDWR): Likewise.
	* src/pk-cmd.c (pk_cmd_exec_1): Fix usage of ios_flags.

2020-02-02  Jose E. Marchesi  <jemarch@gnu.org>

	* doc/poke.texi (open): Document the `flags' optional argument to
	open.

2020-02-01  Jose E. Marchesi  <jemarch@gnu.org>

	* src/ios.h (ios_open): Get a flags argument.
	(IOS_F_READ): Define.
	(IOS_F_WRITE): Likewise.
	(IOS_F_APPEND): Likewise.
	(IOS_F_CREATE): Likewise.
	(IOS_F_TRUNCATE): Likewise.
	(IOS_M_RDONLY): Likewise.
	(IOS_M_WRONLY): Likewise.
	(IOS_M_RDWR): Likewise.
	* src/ios.c (ios_open): Likewise.
	* src/pkl-rt.pk (open): get an optional argument for the flags.
	(IOS_F_READ): Define.
	(IOS_F_WRITE): Likewise.
	(IOS_F_APPEND): Likewise.
	(IOS_F_CREATE): Likewise.
	(IOS_M_RDONLY): Likewise.
	(IOS_M_WRONLY): Likewise.
	(IOS_M_RDWR): Likewise.
	* src/pkl-gen.c (pkl_gen_ps_comp_stmt): The `open' instruction now
	takes two arguments.
	* src/pvm.jitter (open): Likewise.
	* src/pk-file.c (print_info_file): Adapt to new flags.

2020-02-01  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pvm.jitter (mka): Initialize non-initialized elements in the
	array.
	* testsuite/poke.pkl/arrays-4.pk: Update to new semantics.
	* testsuite/poke.pkl/arrays-index-1.pk: Likewise.
	* doc/poke.texi (Array Literals): Update.

2020-01-31  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-fold.c (pkl_fold_ps_indexer): New handler.
	(pkl_phase_fold): Register pkl_fold_ps_indexer.
	* testsuite/poke.pkl/strings-index-diag-1.pk: New test.
	* testsuite/poke.pkl/arrays-index-diag-1.pk: Likewise.
	* testsuite/poke.pkl/arrays-index-diag-2.pk: Likewise.
	* testsuite/poke.pkl/strings-index-diag-2.pk: Likewise.
	* testsuite/poke.pkl/arrays-index-diag-3.pk: Likewise.
	* testsuite/poke.pkl/arrays-index-1.pk: Likewise.
	* testsuite/poke.pkl/strings-index-diag-3.pk: Likewise.
	* testsuite/poke.pkl/arrays-2.pk: Adapt to constant folding.
	* testsuite/poke.pkl/arrays-6.pk: Likewise.
	* testsuite/poke.pkl/arrays-8.pk: Likewise.
	* testsuite/poke.pkl/arrays-9.pk: Likewise.
	* testsuite/poke.pkl/arrays-10.pk: Likewise.
	* testsuite/poke.pkl/arrays-11.pk: Likewise.

2020-01-31  Jose E. Marchesi  <jemarch@gnu.org>

	* src/ios.c (ios_read_string): Support reading strings from
	non-byte aligned offsets.
	(ios_write_string): Likewise, for writing.
	* testsuite/poke.map/maps-strings-2.pk: New test.
	* testsuite/poke.map/maps-strings-diag-1.pk: Likewise.
	* testsuite/poke.map/maps-strings-diag-2.pk: Likewise.
	* testsuite/poke.map/maps-strings-diag-4.pk: Likewise.
	* testsuite/poke.map/maps-strings-3.pk: Likewise.

2020-01-31  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-insn.def (PKL_INSN_IOSIZE): New instruction.
	* src/pkl-ast.h (PKL_AST_BUILTIN_IOSIZE): Define.
	* src/pkl-gen.c (pkl_gen_ps_comp_stmt): Handle iosize builtin.
	* src/pkl-lex.l: New token BUILTIN_IOSIZE.
	* src/pkl-rt.pk (iosize): New builtin.
	* src/pkl-tab.y (builtin): Handle the iosize builtin.
	* bootstrap.conf (gnulib_modules): Import `fstat' module.
	* src/ios.h: Prototype for ios_size.
	* src/ios.c (ios_size): Define.
	* src/ios-dev.h (struct ios_dev_if): New IOD operation `size'.
	* src/pvm.jitter (iosize): New instruction.
	* src/ios-dev-file.c (ios_dev_file_size): New function.
	* doc/poke.texi (iosize): New section.
	* testsuite/poke.pkl/iosize-1.pk: New file.
	* testsuite/poke.pkl/iosize-diag-1.pk: Likewise.

2020-01-31  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-insn.def (PKL_INSN_SYNC): Define.
	* src/pvm.c (pvm_run): Install the pvm signal handler to handle
	SIGINT.
	* src/pkl-asm.c (pkl_asm_endloop): Emit a sync instruction before
	branching back.
	(pkl_asm_for_endloop): Likewise.
	* src/pvm.h (PVM_E_SIGNAL): Define.
	* src/pkl-rt.pk (E_signal): Likewise.
	* src/pvm.jitter (sync): New instruction.
	(exit): Clear signals before exitting the PVM.
	(late-c): Define pvm_handle_signal.
	* HACKING (Signal Handling): New section.

2020-01-31  Jose E. Marchesi  <jemarch@gnu.org>

	* HACKING: Add Bruno Haible to the Write After Approval list.

2020-01-28  Darshit Shah  <darnir@gnu.org>

	* bootstrap.conf: Update minimum required Automake to 1.14
	Downgrade minimum required flex to 2.5.37
	Add makeinfo as a build dependency

2020-01-24  Jose E. Marchesi  <jemarch@gnu.org>

	* testsuite/poke.pkl/sl-2.pk: New test.
	* testsuite/poke.pkl/sl-8.pk: Likewise.
	* testsuite/poke.pkl/sl-7.pk: Likewise.
	* testsuite/poke.pkl/sl-6.pk: Likewise.
	* testsuite/poke.pkl/sl-5.pk: Likewise.
	* testsuite/poke.pkl/sl-4.pk: Likewise.
	* testsuite/poke.pkl/sl-3.pk: Likewise.

2020-01-17  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-tab.y (function_type_specifier): Fix definition to not
	allow trailing commas.
	(function_type_arg_list): The list of arguments can't be empty.
	* etc/poke.g4: Likewise.
	* testsuite/poke.pkl/fun-types-diag-2.pk: New test.

2020-01-17  Jose E. Marchesi  <jemarch@gnu.org>

	* etc/poke.g4: New file.
	* HACKING (Appendix): Add mention to etc/poke.g4.
	(Grammarinator): New section.

2020-01-17  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pvm-val.c (pvm_print_binary): Make non-static.
	* src/pvm-val.h: Prototype for pvm_print_binary.
	* src/pvm.jitter (PVM_PRINTI): Handle binary output.
	(PVM_PRINTL): Likewise.
	* testsuite/poke.pkl/printf-binary-1.pk: New test.
	* testsuite/poke.pkl/printf-binary-4.pk: Likewise.
	* testsuite/poke.pkl/printf-binary-3.pk: Likewise.
	* testsuite/poke.pkl/printf-binary-2.pk: Likewise.

2020-01-18 John Darrington <john@darrington.wattle.id.au>

	* configure.ac (AC_INIT): Change email address to poke-devel@gnu.org
	* bootstrap.conf: Remove MSGID_BUGS_ADDRESS
	* po/poke.pot: regenerate

2020-01-16  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pk-dump.pk (dump): Add new argument ios and use it in the
	maps.
	* doc/poke.texi (dump): Document the :ios option.
	* testsuite/poke.cmd/dump-8.pk: New test.

2020-01-16  Jose E. Marchesi  <jemarch@gnu.org>

	* src/poke.c (pk_print_version): Update copyright years.

2020-01-18 John Darrington <john@darrington.wattle.id.au>

	* src/pk-repl.c (poke_getc): Use xzalloc instead of xmalloc.
	* src/pkl-ast.c (pkl_ast_make_node): ditto
	* src/pkl-env.c (pkl_env_new): ditto
	* src/pkl-parser.c (pkl_parser_init): ditto
	* src/pkl.c (pkl_new): ditto
	* src/pvm.c (pvm_init): ditto

2020-01-16  Darshit Shah  <darnir@gnu.org>

	* bootstrap.conf: Set --skip-po to be the default option.
	* testsuite/poke.map/maps-arrays-19.pk: Extend test to ensure e_EOF is
	thrown when reading through End-of-File.

2020-01-16  Jose E. Marchesi  <jemarch@gnu.org>

	* testsuite/poke.map/maps-arrays-19.pk: Fix test logic.

2020-01-18 John Darrington <john@darrington.wattle.id.au>

	* src/pkl.c: Use std macro for bug report address.

2020-01-14  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-anal.c (pkl_anal2_ps_offset): Remove unused local
	variable.

2020-01-14  Jose E. Marchesi  <jemarch@gnu.org>

	* HACKING (Using data files in tests): New section.
	(Writing tests that depend on a certain capability): Likewise.
	* testsuite/lib/poke-dg.exp (dg-require): Add a note.

2020-01-14  Jose E. Marchesi  <jemarch@gnu.org>

	* TODO: New task.

2020-01-14  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-typify.c (pkl_typify1_ps_trimmer): check that the
	operator of a trimming operation is either an array or a string.
	* testsuite/poke.pkl/trim-diag-5.pk: New test.

2020-01-14  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-typify.c (pkl_typify1_ps_struct_type_field): struct
	fields cannot be of type `any' nor `void'.
	* testsuite/poke.pkl/struct-types-diag-9.pk: New test.
	* testsuite/poke.pkl/struct-types-diag-10.pk: Likewise.

2020-01-14  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-pass.h (PKL_PASS_SUBPASS): fix detection of error when
	calling pkl_do_subpass.

2020-01-14  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl.c (pkl_ice): do not dump files in /etc if --quiet is
	used in the command line.

2020-01-14  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-typify.c (pkl_typify1_ps_op_boolean): make sure the
	arguments to relational operators are integral.
	* testsuite/poke.pkl/and-diag-1.pk: New test.
	* testsuite/poke.pkl/xor-diag-1.pk: Likewise.
	* testsuite/poke.pkl/or-diag-1.pk: Likewise.

2020-01-13  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-tab.y: Do not try to pop lexical frames in <ast>
	destructors.

2020-01-13  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-typify.c (pkl_typify1_ps_cast): Casting to/from void is
	not allowed.
	* testsuite/poke.pkl/cast-void-diag-1.pk: New test.

2020-01-13  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-typify.c (pkl_typify1_ps_first_operand): Check the type
	of the operand for NEG, POS and BNOT.
	* testsuite/poke.pkl/neg-diag-1.pk: New test.
	* testsuite/poke.pkl/bnot-diag-1.pk: Likewise.
	* testsuite/poke.pkl/pos-diag-1.pk: Likewise.

2020-01-13  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-insn.def (PKL_INSN_OSETM): Define.
	* src/pvm.jitter (osetm): new instruction.
	* src/pkl-gen.c (pkl_gen_ps_op_intexp): Adapt to offsets.
	* src/pkl-asm.c (pkl_asm_insn_intop): Likewise.
	* testsuite/poke.pkl/neg-offsets-1.pk: New test.
	* testsuite/poke.pkl/bnot-offsets-1.pk: Likewise.
	* testsuite/poke.pkl/bnot-integers-1.pk: Renamed from bnot-1.pk
	* testsuite/poke.pkl/bnot-integers-2.pk: Likewise.

2020-01-13  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-typify.c (pkl_typify1_ps_cast): Check casts from arrays.
	* testsuite/poke.pkl/cast-array-diag-8.pk: New file.

2020-01-13  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-fold.c (pkl_fold_cdiv): Fix detection of division by zero
	for offsets with implicit magnitudes.
	(pkl_fold_div): Likewise.
	* testsuite/poke.pkl/cdiv-offsets-3.pk: New file.
	* testsuite/poke.pkl/div-offsets-4.pk: Likewise.

2020-01-13  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-fold.c (pkl_fold_mod): Fix detection of division by zero
	for offsets with implicit magnitudes.
	* testsuite/poke.pkl/mod-offsets-5.pk: New file.

2020-01-13  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-anal.c (pkl_anal1_ps_offset): New handler.
	(pkl_phase_anal1): Add handler.
	* testsuite/poke.pkl/offset-type-diag-3.pk: New test.
	* testsuite/poke.pkl/offsets-diag-2.pk: Likewise.
	* doc/poke.texi (Offset Literals): Document that the unit of
	offsets shall be bigger than 0.

2020-01-13  Jose E. Marchesi  <jemarch@gnu.org>

	* TODO: Several updates.

2020-01-13  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pk-file.c (print_info_file): Use the IO's id as tags.
	(pk_cmd_info_files): Adapt accordingly.
	* testsuite/poke.cmd/file-mode.pk: Adjust accordingly.

2020-01-13  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-lex.l: Ignore form feed characters.
	* testsuite/poke.pkl/formfeedchar.pk: New file.
	* doc/poke.texi (Comments): New chapter.

2020-01-12  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pvm-val.c (pvm_print_val): Fix printing of hexadecimal
	values with odd widths.
	* testsuite/poke.map/maps-uint-19.pk: Test for the above.

2020-01-12 John Darrington <john@darrington.wattle.id.au>

	* doc/poke.texi: Fixed various typos.

2020-01-12 Egeyar Bagcioglu <egeyar@gmail.com>

	* src/ios.c (ios_get): Remove.
	* src/ios.h (ios_get): Likewise.
	* src/pk-file.c (pk_cmd_file): Replace the bogus call to ios_get
	with ios_search_by_id.
	(pk_cmd_close): Replace the bogus call to ios_get with
	ios_search_by_id.

2020-01-12  Jose E. Marchesi  <jemarch@gnu.org>

	* testsuite/poke.pkl/chars-1.pk: New file.
	* testsuite/poke.pkl/chars-8.pk: Likewise.
	* testsuite/poke.pkl/chars-7.pk: Likewise.
	* testsuite/poke.pkl/chars-6.pk: Likewise.
	* testsuite/poke.pkl/chars-5.pk: Likewise.
	* testsuite/poke.pkl/chars-4.pk: Likewise.
	* testsuite/poke.pkl/chars-3.pk: Likewise.
	* testsuite/poke.pkl/chars-9.pk: Renamed from chars.pk

2020-01-12  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-lex.l (CHAR): Allow '\r' as character literals.
	* testsuite/poke.pkl/chars-2.pk: New file.

2020-01-12  Jose E. Marchesi  <jemarch@gnu.org>

	* src/ios.c (ios_read_string): Fix detection of EOF.

2020-01-12 Egeyar Bagcioglu <egeyar@gmail.com>

	* src/ios.c (ios_open): Add argument set_cur to control making
	the newly opened IO space the current IO space.
	* src/ios.h (ios_open): Add the new argument, set_cur.
	* src/poke.c (parse_args): Call ios_open with set_cur 1.
	* src/pk-file.c (pk_cmd_file): Likewise.
	* src/pvm.jitter (instruction open): Call ios_open with set_cur 0.
	* testsuite/poke.pkl/close-1.pk: Adjust.
	* testsuite/poke.pkl/set-ios-1.pk: Likewise.

2020-01-12 Egeyar Bagcioglu <egeyar@gmail.com>

	* src/pkl-gen.c (pkl_gen_ps_comp_stmt): Remove PKL_INSN_RETURN from
	PKL_AST_BUILTIN_CLOSE which returns void.
	* src/pvm.jitter (close): Add JITTER_DROP_STACK.

2020-01-11 Egeyar Bagcioglu <egeyar@gmail.com>

	* src/ios.c (ios_write_int_common): Add specifiers "static inline".

2020-01-05  Jose E. Marchesi  <jemarch@gnu.org>

	* src/ras: Stop claiming posix compatibility both as the current
	state and a goal.

2020-01-05  Jose E. Marchesi  <jemarch@gnu.org>

	* bootstrap.conf (gnulib_modules): Import module
	`update-copyright'.

2020-01-03 Egeyar Bagcioglu <egeyar@gmail.com>

	* testsuite/poke.map/maps-uint-write-01.pk: New test.
	* testsuite/poke.map/maps-uint-write-02.pk: Likewise.
	* testsuite/poke.map/maps-uint-write-03.pk: Likewise.
	* testsuite/poke.map/maps-uint-write-04.pk: Likewise.
	* testsuite/poke.map/maps-uint-write-05.pk: Likewise.
	* testsuite/poke.map/maps-uint-write-06.pk: Likewise.
	* testsuite/poke.map/maps-uint-write-07.pk: Likewise.
	* testsuite/poke.map/maps-uint-write-08.pk: Likewise.
	* testsuite/poke.map/maps-uint-write-09.pk: Likewise.
	* testsuite/poke.map/maps-uint-write-10.pk: Likewise.
	* testsuite/poke.map/maps-uint-write-11.pk: Likewise.
	* testsuite/poke.map/maps-uint-write-12.pk: Likewise.
	* testsuite/poke.map/maps-uint-write-13.pk: Likewise.
	* testsuite/poke.map/maps-uint-write-14.pk: Likewise.
	* testsuite/poke.map/maps-uint-write-15.pk: Likewise.
	* testsuite/poke.map/maps-uint-write-16.pk: Likewise.
	* testsuite/poke.map/maps-uint-write-17.pk: Likewise.
	* testsuite/poke.map/maps-uint-write-18.pk: Likewise.
	* testsuite/poke.map/maps-uint-write-19.pk: Likewise.
	* testsuite/poke.map/maps-uint-write-20.pk: Likewise.
	* testsuite/poke.map/maps-uint-write-21.pk: Likewise.
	* testsuite/poke.map/maps-uint-write-22.pk: Likewise.
	* testsuite/poke.map/maps-uint-write-23.pk: Likewise.
	* testsuite/poke.map/maps-uint-write-24.pk: Likewise.
	* testsuite/poke.map/maps-uint-write-25.pk: Likewise.
	* testsuite/poke.map/maps-uint-write-26.pk: Likewise.
	* testsuite/poke.map/maps-uint-write-27.pk: Likewise.
	* testsuite/poke.map/maps-uint-write-28.pk: Likewise.
	* testsuite/poke.map/maps-uint-write-29.pk: Likewise.
	* testsuite/poke.map/maps-uint-write-30.pk: Likewise.
	* testsuite/poke.map/maps-uint-write-31.pk: Likewise.
	* testsuite/poke.map/maps-uint-write-32.pk: Likewise.
	* testsuite/poke.map/maps-uint-write-33.pk: Likewise.
	* testsuite/poke.map/maps-uint-write-34.pk: Likewise.
	* testsuite/poke.map/maps-uint-write-35.pk: Likewise.
	* testsuite/poke.map/maps-uint-write-36.pk: Likewise.
	* testsuite/poke.map/maps-uint-write-37.pk: Likewise.
	* testsuite/poke.map/maps-uint-write-38.pk: Likewise.
	* testsuite/poke.map/maps-uint-write-39.pk: Likewise.
	* testsuite/poke.map/maps-uint-write-40.pk: Likewise.
	* testsuite/poke.map/maps-uint-write-41.pk: Likewise.
	* testsuite/poke.map/maps-uint-write-42.pk: Likewise.
	* testsuite/poke.map/maps-uint-write-43.pk: Likewise.
	* testsuite/poke.map/maps-uint-write-44.pk: Likewise.
	* testsuite/poke.map/maps-uint-write-45.pk: Likewise.
	* testsuite/poke.map/maps-uint-write-46.pk: Likewise.
	* testsuite/poke.map/maps-uint-write-47.pk: Likewise.
	* testsuite/poke.map/maps-uint-write-48.pk: Likewise.
	* testsuite/poke.map/maps-uint-write-49.pk: Likewise.
	* testsuite/poke.map/maps-uint-write-50.pk: Likewise.
	* testsuite/poke.map/maps-uint-write-51.pk: Likewise.
	* testsuite/poke.map/maps-uint-write-52.pk: Likewise.
	* testsuite/poke.map/maps-uint-write-53.pk: Likewise.
	* testsuite/poke.map/maps-uint-write-54.pk: Likewise.
	* testsuite/poke.map/maps-uint-write-55.pk: Likewise.
	* testsuite/poke.map/maps-uint-write-56.pk: Likewise.
	* testsuite/poke.map/maps-uint-write-57.pk: Likewise.
	* testsuite/poke.map/maps-uint-write-58.pk: Likewise.
	* testsuite/poke.map/maps-uint-write-59.pk: Likewise.
	* testsuite/poke.map/maps-uint-write-60.pk: Likewise.
	* testsuite/poke.map/maps-uint-write-61.pk: Likewise.
	* testsuite/poke.map/maps-uint-write-62.pk: Likewise.
	* testsuite/poke.map/maps-uint-write-63.pk: Likewise.
	* testsuite/poke.map/maps-uint-write-64.pk: Likewise.
	* testsuite/poke.map/maps-uint-write-65.pk: Likewise.
	* testsuite/poke.map/maps-uint-write-66.pk: Likewise.
	* testsuite/poke.map/maps-uint-write-67.pk: Likewise.
	* testsuite/poke.map/maps-uint-write-68.pk: Likewise.
	* testsuite/poke.map/maps-uint-write-69.pk: Likewise.
	* testsuite/poke.map/maps-uint-write-70.pk: Likewise.
	* testsuite/poke.map/maps-uint-write-71.pk: Likewise.
	* testsuite/poke.map/maps-uint-write-72.pk: Likewise.
	* testsuite/poke.map/maps-uint-write-73.pk: Likewise.
	* testsuite/poke.map/maps-uint-write-74.pk: Likewise.

2020-01-03 Egeyar Bagcioglu <egeyar@gmail.com>

	* src/ios.c (IOS_PUT_C_ERR_CHCK): New macro.
	(ios_write_int_fast): New function.
	(ios_write_int_common): Likewise.
	(ios_write_int): Rewrite.
	(ios_write_uint): Rewrite.

2020-01-03 Egeyar Bagcioglu <egeyar@gmail.com>

	* src/ios.c (ios_mask_first_byte): Replace this function with ...
	(IOS_CHAR_GET_LSB): ... this macro.
	(ios_mask_last_byte): Replace this function with ...
	(IOS_CHAR_GET_MSB): ... this macro.
	(ios_read_int_common): Replace the calls to ios_mask_first_byte
	and ios_mask_last_byte with IOS_CHAR_GET_LSB and
	IOS_CHAR_GET_MSB, respectively.

2019-12-29 John Darrington <john@darrington.wattle.id.au>

	* src/ios-dev-file.c (ios_dev_file_open): Use a more reliable
	method to determine the file's mode.
	(ios_dev_file_get_mode): New function.
	* src/ios-dev.h (struct ios_dev_if) [get_mode]: New member.
	* src/ios.c (ios_mode): Use method from implementation.
	* src/ios.h (IOS_M_RDONLY): New macro.
	* testsuite/poke.cmd/file-mode.pk: New file.

2019-12-22 John Darrington <john@darrington.wattle.id.au>

	* src/pkl.c (pkl_ast): Fix bugs dealing with path search.

2019-12-22 John Darrington <john@darrington.wattle.id.au>

	* src/pk-cmd.c (pk_cmd_exec_1): Properly initialise argc
	instead of relying on subsequent assignment.

2019-12-21 John Darrington <john@darrington.wattle.id.au>

	* src/pk-file.c (pk_cmd_file): Fix memory leaks and
	check for failures on opening file.

2019-12-21  Jose E. Marchesi  <jemarch@gnu.org>

	* src/std.pk (days_in_month): Simplify the code a bit.

2019-12-16  Dan Čermák  <dan.cermak@cgc-instruments.com>

	* src/pk-repl.c (pk_repl): fix memory leak of poke_history
	* src/pk-cmd.c (pk_cmd_exec): fix memory leak of ecmd
	* src/pk-cmd.c (pk_cmd_exec_1): fix memory leak of filename
	* src/pk-cmd.c (null_cmd): properly initialize struct

2019-12-15 John Darrington <john@darrington.wattle.id.au>

	*src/ios.c (ios_mask_last_byte) simplify
	*src/ios.c (ios_mask_first_byte) simplify

2019-12-16  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-asm.pks (atrim): The mka instruction expects the type of
	the array, not the type of the elements stored in the array.
	* testsuite/poke.pkl/trim-25.pk: New test.

2019-12-15 John Darrington <john@darrington.wattle.id.au>

	* doc/poke.texi (Date and Time Functions): New chapter.
	* src/std.pk (posix_time32): New type.
	* testsuite/poke.std/time32.pk: New file.

2019-12-15 John Darrington <john@darrington.wattle.id.au>

	* doc/poke.texi (Scripts): Elaborate on what scripts are
	(and what they are not).

2019-12-13  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-typify.c (pkl_typify1_ps_ass_stmt): Remove obsolete
	check.
	* testsuite/poke.pkl/ass-function-1.pk: New test.

2019-12-13  Dan Čermák  <dan.cermak@posteo.net>

	* src/pkl-env.c (hash_string): Avoid overflow of signed integers
	in hash calculation.

2019-12-13  Dan Čermák  <dan.cermak@posteo.net>

	* src/pk-cmd.c (pk_cmd_get_next_match): Fix buffer overflow.

2019-12-12  Dan Čermák  <dan.cermak@posteo.net>

	* src/pkl-ast.c (pkl_print_type): Fix call to fprintf to use "%s"
	to print a non-constant string.

2019-12-10  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-ast.c (pkl_ast_type_is_complete): Struct types having
	fields with labels are no complete types.
	(pkl_ast_sizeof_type): Assert if a struct type with field labels
	is not marked as complete.
	* testsuite/poke.pkl/offsets-diag-1.pk: New test.

2019-12-08 John Darrington <john@darrington.wattle.id.au>

	* src/pkl-lex. (CHAR): Accept \\ as a CHAR token.
	* testsuite/poke.pkl/chars.pk: Add new test.
	* doc/poke.texi (Characters): Document new escape sequence.

2019-12-01 John Darrington <john@darrington.wattle.id.au>

	* doc/poke.texi (Offset Literals):  Change the example to agree with the text.

2019-12-10  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-typify.c (pkl_typify1_ps_mul): Do not accept multiplying
	strings.
	* testsuite/poke.pkl/mul-strings-diag-1.pk: New test.

2019-12-10  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-tab.y (offset_type_specifier): Allow integer literals as
	offset units.
	* src/pkl-anal.c (pkl_anal1_ps_type_offset): New handler.
	(pkl_phase_anal1): Install handler.
	* testsuite/poke.pkl/casts-offsets-4.pk: New test.
	* testsuite/poke.pkl/cast-offsets-diag-3.pk: Likewise.
	* doc/poke.texi (Offset Types): Mention using integers as offset
	type units.

2019-12-09  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pk-cmd.h: Document the value returned by pk_cmd_exec.
	* src/pk-cmd.c (pk_cmd_exec_script): Fix the value returned by the
	function to match the function prototype documentation.
	* src/poke.c (parse_args): Improve the check for the result value
	of pk_cmd_exec_script.
	(initialize_user): Likewise.

2019-12-05  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl.c (pkl_ice): Use an hyperlink for the bug report
	address.
	* src/pkl-asm.c (pkl_asm_catch): Remove obsolete comment.
	* src/pkl-env.c (pkl_env_dup_toplevel): Likewise.

2019-12-05  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-insn.def: New instruction ASETO.
	* src/pvm.jitter (aseto): Define.

2019-12-05  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-typify.c (pkl_typify1_ps_cast): Detect invalid casts,
	and diagnose them.
	* testsuite/poke.pkl/cast-struct-diag-1.pk: New test.
	* testsuite/poke.pkl/cast-offsets-diag-2.pk: Likewise.
	* testsuite/poke.pkl/cast-offsets-diag-1.pk: Likewise.
	* testsuite/poke.pkl/cast-str-diag-1.pk: Likewise.
	* testsuite/poke.pkl/cast-struct-diag-2.pk: Likewise.

2019-12-05  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-fold.c: Define cdivo semantic routines for UUU and III
	cases.
	(pkl_fold_cdiv): Fold /^ operations on offsets.

2019-12-05  Jose E. Marchesi  <jemarch@gnu.org>

	* testsuite/poke.pkl/offset-arg-1.pk: New test.
	* testsuite/poke.pkl/offset-arg-2.pk: Likewise.

2019-12-05  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-fold.c: Define pkl_fold_gcd using gnulib's <gcd.c.>
	(EMUL_UUU): Define for gcd.
	(pkl_fold_gcd): Define handler.
	(pkl_phase_fold): Register handler.
	(OP_BINARY_OOI): Make sure operands are offsets
	before accessing their magnitude/units.
	(OP_BINARY_OOO): Likewise.
	(OP_BINARY_OOI): Fix handling of base_type.

	* src/pkl-promo.c (promote_offset): Support non-integer units.
	(pkl_promo_ps_op_div): Adjust to new API.
	(pkl_promo_ps_op_add_sub_mod): Likewise.
	(pkl_promo_ps_op_mul): Likewise.
	(pkl_promo_ps_op_rela): Likewise.
	(pkl_promo_ps_type_array): Likewise.
	(pkl_promo_ps_ass_stmt): Likewise.
	(pkl_promo_ps_funcall): Likewise.
	(pkl_promo_ps_return_stmt): Likewise.
	(pkl_promo_ps_func_arg): Likewise.
	(pkl_promo_ps_map): Likewise.
	(pkl_promo_ps_struct_type_field): Likewise.
	(pkl_promo_ps_op_in): Likewise.
	* src/pkl-ops.def: Define PKL_AST_OP_GCD.
	* src/pkl-typify.c (CASE_OFFSET): Use pkl_ast_make_binary_exp and
	do not assume the unit types are integers, but avoid superfluous
	casts whenever possible.
	(CASE_OFFSET): Likewise.
	* src/pkl.c (rest_of_compilation): Run a constant folding phase at
	the beginning of the middle end pass.
	* testsuite/poke.pkl/add-offsets-9.pk: New test.
	* testsuite/poke.pkl/eq-offsets-6.pk: Likewise.
	* testsuite/poke.pkl/eq-offsets-5.pk: Likewise.
	* testsuite/poke.pkl/mod-offsets-4.pk: Likewise.
	* testsuite/poke.pkl/mod-offsets-3.pk: Likewise.
	* testsuite/poke.pkl/div-offsets-3.pk: Likewise.
	* testsuite/poke.pkl/div-offsets-2.pk: Likewise.
	* testsuite/poke.pkl/mul-offsets-9.pk: Likewise.
	* testsuite/poke.pkl/sub-offsets-8.pk: Likewise.
	* testsuite/poke.pkl/sub-offsets-7.pk: Likewise.
	* testsuite/poke.pkl/add-offsets-10.pk: Likewise.

2019-12-01 John Darrington <john@darrington.wattle.id.au>

	* bootstrap.conf: Remove "system"

2019-12-04  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-gen.c (pkl_gen_pr_type_array): Do not calculate the
	array bound when building array types.
	* testsuite/poke.map/maps-arrays-18.pk: New test.

2019-12-04  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-trans.c (pkl_phase_transl): Install
	pkl_transl_{pr,ps}_map handlers for struct type fields.
	(pkl_transl_pr_type_struct): Only break the pass when into a map.
	* testsuite/poke.map/maps-arrays-17.pk: New test.

2019-12-04  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-typify.c (pkl_typify1_ps_if_stmt): New handler.
	(pkl_phase_typify1): Install it.
	* testsuite/poke.pkl/if-diag-1.pk: New test.
	* testsuite/poke.pkl/if-diag-2.pk: Likewise.
	* testsuite/poke.pkl/if-diag-3.pk: Likewise.

2019-12-03  Jose E. Marchesi  <jemarch@gnu.org>

	* pickles/elf.pk (Elf64_Sym): New type.
	(STB_LOCAL): New variable.
	(STB_GLOBAL): Likewise.
	(STB_WEAK): Likewise.
	(STB_LOOS): Likewise.
	(STB_HIOS): Likewise.
	(STB_LOPROC): Likewise.
	(STB_HIPROC): Likewise.
	(STV_DEFAULT): Likewise.
	(STV_INTERNAL): Likewise.
	(STV_HIDDEN): Likewise.
	(STV_PROTECTED): Likewise.

2019-12-01 John Darrington <john@darrington.wattle.id.au>

	* doc/poke.texi (dump): Numerous minor changes.

2019-12-01 Luca Saiu <positron@gnu.org>

	* src/pkl-insn.def (PKL_INSN_TUCK): Define new instruction.
	* src/pvm.jitter (rot, nrot): Simplify definition using Jitter
	macro.
	(tuck): New instruction.
	(revn): Add specialized arguments.  Use unsigned JITTER_ARGU0 to
	catch bugs more easily.
	(swap-over-to-tuck): New rewrite rule.
	(rot-swap-to-quake): Re-introduce deleted rewrite rule, which was
	actually correct.
	* pkl-asm.pks (remap, write, addo, subo, mulo, divo, modo, atrim)
	(cdivo, ais, bconc): Simplify and optimize using new instructions.
	* src/pkl-gen.pks (struct_field_mapper): Likewise.

2019-12-01 John Darrington <john@darrington.wattle.id.au>

	* src/pk_dump.pk (dump): New parameter cluster_by

2019-12-01 John Darrington <john@darrington.wattle.id.au>

	* doc/poke.texi (dump): Document the dump command.

2019-11-30 John Darrington <john@darrington.wattle.id.au>

	* testsuite/poke.std/crc32.pk: New file.

2019-11-30 John Darrington <john@darrington.wattle.id.au>

	* src/pk-cmd.c (pk_cmd_find):  Use STREQ instead of strcmp.

2019-11-29  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-gen.c (pkl_gen_pr_map): Fix bug in optimization.
	* testsuite/poke.pkl/map-offset-expr-1.pk: New test.

2019-11-29  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-asm.pks (atrim): Fix calculation of the resulting mapped
	array offset.
	* testsuite/poke.map/maps-trims-1.pk: New test.

2019-11-29  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pvm.jitter (siz): Modify to generate a bit-offset in an
	ulong<64> instead of an offset.
	* src/pkl-gen.pks (off_plus_sizeof): Remove.
	(array_mapper): Adapt accordingly.
	(array_valmapper): Likewise.
	(struct_field_mapper): Likewise.
	* src/pkl-asm.pks (array_conv_siz): Likewise.
	* src/pkl-gen.c (pkl_gen_ps_op_attr): Likewise.

2019-11-29  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-gen.pks (array_valmapper): Adapt to bit-offsets.

2019-11-29  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-asm.pks (atrim): Adapt to bit-offsets.

2019-11-29  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-gen.c (pkl_gen_ps_op_attr): Convert the value returned
	by mgeto to an offset value.

2019-11-29  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pvm-val.c (pvm_sizeof): Struct fields now store bit-offsets
	instead of offsets.

2019-11-29  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-gen.c (pkl_gen_pr_type_offset): Fix regression.

2019-11-29  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-gen.c (pkl_gen_pr_type_array): Convert sbounds in maps
	to bit-offsets.

2019-11-29  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-gen.pks (struct_writer): Adapt to bit-offsets.
	(struct_field_writer): Likewise.
	(array_writer): Likewise.

2019-11-29  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-gen.pks (struct_mapper): Use bit-offsets for the struct
	offsets.
	(struct_field_mapper): Likewise.
	(handle_struct_field_label): Likewise.
	(off_plus_sizeof): Likewise.

2019-11-29  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-gen.pks (array_mapper): Use bit-offsets for the array
	offsets and for sbound.

2019-11-29  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-gen.c (pkl_gen_pr_map): Convert map argument to
	bit-offset.
	(pkl_gen_pr_ass_stmt): Likewise.
	(pkl_gen_pr_type_offset): Do not convert to bit-offset.
	(pkl_gen_ps_type_integral): Likewise.
	(pkl_gen_ps_type_string): Likewise.
	* src/pvm.jitter: Remove invalid rot-swap-to-quake rewrite.

2019-11-29  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pvm.jitter: Update comments to reflect that peek/poke
	instructions get bit-offsets, not regular offsets.

2019-11-24 John Darrington <john@darrington.wattle.id.au>
            * src/pk-file (pk_file_readable): New function.
            (pk_cmd_load_file): Use it to check files before
            opening.

2019-11-24 John Darrington <john@darrington.wattle.id.au>

	* src/pk-term.c: Remove unnecessary #include <sys/stat.h>

2019-11-28  Jose E. Marchesi  <jemarch@gnu.org>

	* testsuite/lib/poke-dg.exp (dg-data): Avoid appending duplicated
	file names to poke_data_files.
	(poke_finish): Fix deleting the temporary files.

2019-11-28  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pvm.jitter: Add ios_write_string to the list of wrapped
	functions.
	(pokes): Implement instruction.
	* src/ios.c (ios_write_string): Implement.
	* testsuite/poke.map/ass-map-3.pk: New test.
	* testsuite/poke.map/ass-map-4.pk: Likewise.
	* testsuite/poke.map/ass-map-5.pk: Likewise.

2019-11-28  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-anal.c (pkl_anal1_ps_return_stmt): New handler.
	(pkl_phase_anal1): Register it.
	* testsuite/poke.pkl/return-diag-2.pk: New test.

2019-11-28  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-typify.c (pkl_typify1_ps_type_offset): New handler.
	(pkl_phase_typify1): Register it.
	* testsuite/poke.pkl/offset-type-diag-1.pk: New test.
	* testsuite/poke.pkl/offset-type-diag-2.pk: Likewise.

2019-11-24 John Darrington <john@darrington.wattle.id.au>

        * src/std.pk (crc32): New function.
        * doc/poke.texi (CRC Functions): New node.

2019-11-27  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pvm.jitter (quake): New instruction.
	(rot-swap-to-quake): New rewrite rule.

2019-11-24 John Darrington <john@darrington.wattle.id.au>

	* src/pk-cmd.c (pk_cmd_exec_script): Use getline instead
	of a loop and getc.

2019-11-26  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pvm-alloc.c (pvm_realloc): New function.
	* src/pkl-asm.c (pkl_asm_insn): Remove hard limit
	PKL_AST_MAX_POINTERS, reallocating memory as necessary.
	(pkl_asm_new): Initialize pointers to NULL.

2019-11-26  Jose E. Marchesi  <jemarch@gnu.org>

	* testsuite/lib/poke-dg.exp (poke-dg-test): Pass -q to poke to
	avoid reading ~/.pokerc.

2019-11-26  Jose E. Marchesi  <jemarch@gnu.org>

	* src/ios.c (IOS_GET_C_ERR_CHCK): Make sure to check get_c return
	value as an int before casting it.
	* src/ios-dev-file.c (ios_dev_file_getc): Do not rely on EOF ==
	IOD_EOF.

2019-11-22  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-ast.c (pkl_ast_type_is_complete): Handle function types.
	* src/pkl-typify.c (pkl_typify1_ps_op_unmap): New handler.
	* testsuite/poke.pkl/unmap-diag-1.pk: New test.

2019-11-22  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-ast.c (pkl_ast_type_is_complete): Fix handling of
	structs.

2019-11-22  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-ast.c (pkl_ast_type_mappable_p): New function.
	* src/pkl-typify.c (pkl_typify1_ps_map): Check for types that
	cannot be mapped and error about it.
	* testsuite/poke.pkl/map-diag-3.pk: Likewise.
	* testsuite/poke.pkl/map-diag-2.pk: Likewise.
	* testsuite/poke.pkl/map-diag-1.pk: New test.
	* testsuite/poke.pkl/map-diag-7.pk: Likewise.
	* testsuite/poke.pkl/map-diag-6.pk: Likewise.
	* testsuite/poke.pkl/map-diag-5.pk: Likewise.
	* testsuite/poke.pkl/map-diag-4.pk: Likewise.

2019-11-22  Jose E. Marchesi  <jemarch@gnu.org>

	* testsuite/poke.pkl/struct-types-diag-8.pk: Rewrite.

2019-11-22  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-tab.y (offset_type_specifier): Allow simple types only
	for the offset unit.

2019-11-19 John Darrington <john@darrington.wattle.id.au>

	* doc/poke.texi: Add indeces.

2019-11-19 John Darrington <john@darrington.wattle.id.au>

        * src/pk-dump.pk (print_ascii): New function. (print_hex) New function.
        (print_data): Deal properly with EOF and data not ending on 16#B boundary.
        * testsuite/poke.cmd/dump-5.pk: New file.
        * testsuite/poke.cmd/dump-6.pk: New file.
        * testsuite/poke.cmd/dump-7.pk: New file.

2019-11-17 John Darrington <john@darrington.wattle.id.au>

	* doc/poke.texi (Standard Integral Types): Correct size of nibble.

2019-11-21  Jose E. Marchesi  <jemarch@gnu.org>

	* doc/poke.texi (Field Constraints): New section.

2019-11-15  Jose E. Marchesi  <jemarch@gnu.org>

	* doc/poke.texi (__LINE__ and __FILE__): New chapter.

2019-11-15  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-gen.pks: Fix handling of sboundm.
	* testsuite/poke.map/maps-arrays-16.pk: New test.

2019-11-15  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-tab.y: New tokens UU_LINE_UU and UU_FILE_UU.
	* src/pkl-lex.l: Rules for __FILE__ and for __LINE__.
	* testsuite/poke.pkl/uu-line-1.pk: New test.
	* testsuite/poke.pkl/uu-file-1.pk: Likewise.

2019-11-15  Jose E. Marchesi  <jemarch@gnu.org>

	* man/Makefile.am (poke.1): Go back to depend on the source file
	to avoid distcheck to fail.  This time, make sure the executable
	exists before invoking help2man.

2019-11-15  Jose E. Marchesi  <jemarch@gnu.org>

	* pickles/leb128.pk: Remove trailing blanks.
	* testsuite/lib/poke-dg.exp: Likewise.
	* src/pvm.jitter: Likeise.
	* src/pkl-typify.c: Likewise.
	* src/pkl-tab.y: Likewise.
	* src/pkl-promo.c: Likewise.
	* src/pkl-gen.c: Likewise.
	* src/pkl-ast.h: Likewise.
	* src/pkl-ast.c: Likewise.
	* src/pk-editor.c: Likewise.
	* testsuite/poke.map/ass-map-1.pk: Remove empty lines at EOF.
	* testsuite/poke.std/atoi-9.pk: Likewise.
	* testsuite/poke.std/atoi-8.pk: Likewise.
	* testsuite/poke.std/atoi-7.pk: Likewise.
	* testsuite/poke.std/atoi-6.pk: Likewise.
	* testsuite/poke.std/atoi-5.pk: Likewise.
	* testsuite/poke.std/atoi-4.pk: Likewise.
	* testsuite/poke.std/atoi-3.pk: Likewise.
	* testsuite/poke.std/atoi-2.pk: Likewise.
	* testsuite/poke.std/atoi-13.pk: Likewise.
	* testsuite/poke.std/atoi-12.pk: Likewise.
	* testsuite/poke.std/atoi-11.pk: Likewise.
	* testsuite/poke.std/atoi-10.pk: Likewise.
	* testsuite/poke.std/atoi-1.pk: Likewise.
	* testsuite/poke.pkl/try-until-3.pk: Likewise.
	* testsuite/poke.pkl/strings-1.pk: Likewise.
	* testsuite/poke.pkl/ass-map-diag-2.pk: Likewise.
	* testsuite/poke.pkl/ass-map-diag-1.pk: Likewise.
	* testsuite/poke.map/maps-offsets-2.pk: Likewise.
	* testsuite/poke.map/maps-offsets-1.pk: Likewise.
	* testsuite/poke.map/maps-ios-1.pk: Likewise.
	* testsuite/poke.map/ass-map-2.pk: Likewise.
	* .x-sc_prohibit_atoi_atof: New file.
	* doc/poke.texi (IO Spaces): s/filesystem/file system/.
	* src/ios.c: Avoid double word in comment.
	* man/Makefile.am (poke.1): Do not use $< in this non-implicit
	rule.

2019-11-13 John Darrington <john@darrington.wattle.id.au>

	* src/pk-cmd.h (completer_t): New typedef.
	(pk_cmd) [completer]: New member;

2019-11-13 John Darrington <john@darrington.wattle.id.au>

	* src/pkl-env.h (pkl_ast_node_iter): New struct.
	(pkl_env_iter_begin): New declaration.
	(pkl_env_iter_next): New declaration.
	(pkl_env_iter_end): New declaration.
	* src/pkl-env.c (pkl_env_iter_begin): New function.
	(pkl_env_iter_next): New function.
	(pkl_env_iter_end): New function.
	(pkl_env_map_decls): Use them to implement this function.

2019-11-13 John Darrington <john@darrington.wattle.id.au>

	* src/pk-cmd.c (cmds): Rename to dot_cmds.
	(pk_cmd_init): Deal with the consequences.

2019-11-14  Jose E. Marchesi  <jemarch@gnu.org>

	* man/Makefile.am: New file.
	* Makefile.am (SUBDIRS): Add the man directory.
	* doc/poke.texi (pokerc): New chapter.
	* configure.ac: Initialize HELP2MAN.

2019-11-14  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-insn.def: peeklu, peekiu, pokelu and pokeiu get two
	arguments, not three.
	* testsuite/poke.pkl/struct-types-endian-1.pk: New test.

2019-11-13  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-gen.c (pkl_gen_ps_op_in): Delete commented out code.

2019-11-13  Jose E. Marchesi  <jemarch@gnu.org>

	* HACKING (Installing Obvious Changes): Fix typo

2019-11-13 John Darrington <john@darrington.wattle.id.au>

	* HACKING (Dejagnu): Fix typo.
	(libtextstyle): Fix typo.

2019-11-13 John Darrington <john@darrington.wattle.id.au>

	* src/pk-repl.c (pk_repl): Remove superfluous tests of the
	variable "line".

2019-11-13 John Darrington <john@darrington.wattle.id.au>

	* src/poke.c (pk_print_version): Update translatable strings.

2019-11-13  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-tab.y: Add missing trailing ';' in the try-until syntax
	rule.

2019-11-13  Jose E. Marchesi  <jemarch@gnu.org>

	* doc/poke.texi (Exceptions): Document the ranges of exceptions.

2019-11-13  Jose E. Marchesi  <jemarch@gnu.org>

	* testsuite/poke.pkl/get-ios-1.pk: New test.
	* testsuite/poke.pkl/get-ios-2.pk: Likewise.
	* testsuite/poke.pkl/set-ios-1.pk: Likewise.
	* testsuite/poke.pkl/close-1.pk: Likewise.
	* testsuite/poke.pkl/open-1.pk: Likewise.

2019-11-13  Jose E. Marchesi  <jemarch@gnu.org>

	* doc/poke.texi (IO Spaces): New section.
	(open): New subsection.
	(close): Likewise.
	(get_ios): Likewise.
	(set_ios): Likewise.
	(The Map Operator): Update to cover the ternary map operator.

2019-11-13  Jose E. Marchesi  <jemarch@gnu.org>

	* testsuite/lib/poke-dg.exp (dg-data): Accept a file name
	argument.
	(poke_finish): poke_data_files is now a list.
	* testsuite/poke.map/maps-ios-1.pk: New test.
	* testsuite/poke.map/maps-ios-2.pk: Likewise.
	* testsuite/poke.map/maps-ios-3.pk: Likewise.
	* testsuite/poke.map/maps-ios-4.pk: Likewise.
	* testsuite/poke.map/maps-ios-5.pk: Likewise.
	* testsuite/poke.map/maps-ios-6.pk: Likewise.
	* testsuite/poke.map/maps-ios-7.pk: Likewise.

2019-11-12  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pvm.jitter (peeks): Take an IOS argument.
	(PVM_PEEK): Likewise.
	(PVM_POKE): Likewise.
	* src/pkl-gen.c (pkl_gen_pr_map): Pass the IO argument to the
	mappers.
	(pkl_gen_ps_type_integral): Take an IOS argument for mappers and
	writers.
	(pkl_gen_ps_type_string): Likewise.
	(pkl_gen_pr_type_offset): Likewise.
	(pkl_gen_pr_type_array): Likewise.
	(pkl_gen_pr_type_struct): Likewise.
	(pkl_gen_pr_ass_stmt): Pass IOS to the l-value map.
	* src/pkl-gen.pks (array_mapper): Likewise.
	(array_writer): Likewise.
	(struct_mapper): Likewise.
	(struct_field_mapper): Likewise.
	(op_unmap): Set ios to null.
	* src/pkl-asm.pks (write): Pass the mapped object's IOS to the
	writer.
	(remap): Pass the mapped object's IOS to the mapper.
	* src/pkl-tab.y (struct_type_specifier): Register 3 dummies in the
	compile-time lexical environment to reflect lexical changes in
	struct_mapper.
	* testsuite/poke.map/maps-strings-1.pk: New test.
	* testsuite/poke.map/maps-offsets-1.pk: Likewise.
	* testsuite/poke.map/maps-offsets-2.pk: Likewise.

2019-11-12  Jose E. Marchesi  <jemarch@gnu.org>

	* src/ios.c (struct ios): New field `id'.
	(ios_next_id): New static variable.
	(ios_open): Return the id of the opened ios.
	(ios_search_by_id): New function.
	* src/poke.c (parse_args): Adapt to the new interface of ios_open.
	* src/pvm.jitter (close): Use ios_search_by_id.

2019-11-12  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-ast.h (PKL_AST_BUILTIN_OPEN): Define.
	(PKL_AST_BUILTIN_CLOSE): Likewise.
	* src/pkl-tab.y (builtin): Handle BUILTIN_OPEN and BUILTIN_CLOSE.
	(BUILTIN_OPEN): New token.
	(BUILTIN_CLOSE): Likewise.
	* src/pkl-lex.l: Add __PKL_BUILTIN_OPEN__ and
	__PKL_BUILTIN_CLOSE__.
	* src/pkl-rt.pk (open): Define.
	(close): Likewise.
	* src/pkl-insn.def (open): New instruction.
	(close): Likewise.
	* src/pvm.jitter (open): New instruction.
	(close): Likewise.
	* src/pkl-gen.c (pkl_gen_ps_comp_stmt): Handle
	PKL_AST_BUILTIN_OPEN and PKL_AST_BUILTIN_CLOSE.

2019-11-11  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-ast.h (PKL_AST_BUILTIN_GET_IOS): Define.
	(PKL_AST_BUILTIN_SET_IOS): Likewise.
	* src/pkl-gen.c (pkl_gen_ps_comp_stmt): Handle get_ios and set_ios
	builtins.
	* src/pkl-insn.def: Define instructions PKL_INSN_PUSHIOS and
	PKL_INSN_POPIOS.
	* src/pvm.jitter (pushios): New instruction.
	(popios): Likewise.
	* src/pkl-rt.pk (get_ios): New function.
	(set_ios): Likewise.
	* src/pkl-lex.l: Rules for __PKL_BUILTIN_GET_IOS__ and
	__PKL_BUILTIN_SET_IOS__.
	* src/pkl-tab.y: Define tokens BUILTIN_GET_IOS and
	BUILTIN_SET_IOS.

2019-11-11  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-ast.c (pkl_ast_make_map): Get an `ios' argument.
	(pkl_ast_node_free): Handle the map ios.
	(pkl_ast_print_1): Likewise.
	* src/pkl-ast.h (struct pkl_ast_map): New attribute `ios'.
	* src/pkl-tab.y (map): Add ternary variant of the operator.
	* src/pkl-pass.c (pkl_do_pass_1): Visit the ios node of maps.
	* src/pkl-typify.c (pkl_typify1_ps_map): Check whether the IOS
	expression evaluates to an integral value.
	(pkl_typify1_ps_attr): The type of the 'io attribute is an
	int<32>.
	* src/pkl-promo.c (pkl_promo_ps_map): Promote the ios argument to
	the map operator.
	* src/pkl-gen.c (pkl_gen_ps_op_attr): Generate code for the 'ios
	attribute.
	* src/pkl-attrs.def: Define PKL_AST_ATTR_IOS.
	* src/pkl-insn.def: New instructions mgetio and msetio.
	* src/pvm.jitter (mgetio): New instruction.
	(msetio): Likewise.
	* testsuite/poke.pkl/map-ios-diag-1.pk: New test.
	* testsuite/poke.pkl/map-ios-diag-2.pk: Likewise.
	* testsuite/poke.pkl/attr-ios-diag-1.pk: Likewise.
	* testsuite/poke.pkl/attr-ios-diag-2.pk: Likewise.
	* src/pvm-val.h (PVM_VAL_IO): Define.
	(PVM_VAL_SET_IO): Likewise.
	(PVM_VAL_ARR_IO): Likewise.
	(PVM_VAL_SCT_IO): Likewise.
	(struct pvm_struct): New field io.
	(struct pvm_array): Likewise.
	* src/pvm-val.c (pvm_make_array): Initialize io.
	(pvm_make_struct): Likewise.

2019-11-12  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-lex.l: Handle token UNTIL.
	* src/pkl-tab.y (UNTIL): New token.
	* src/pkl-ast.h (PKL_AST_TRY_UNTIL_STMT_CODE): Define.
	(PKL_AST_TRY_UNTIL_STMT_EXP): Likewise.
	(struct pkl_ast_try_until_stmt): New struct.
	* src/pkl-ast.c (pkl_ast_make_try_until_stmt): New function.
	(pkl_ast_node_free): Handle try-until AST nodes.
	(pkl_ast_finish_breaks_1): Likewise.
	(pkl_ast_finish_returns_1): Likewise.
	(pkl_ast_print_1): Likewise.
	* src/pkl-pass.c (pkl_do_pass_1): Likewise.
	* src/pkl-typify.c (pkl_typify1_ps_try_until_stmt): New handler.
	* src/pkl-promo.c (pkl_promo_ps_try_until_stmt): Likewise.
	* src/pkl-gen.c (pkl_gen_pr_try_until_stmt): New handler.
	* doc/poke.texi (try-until): New section.
	* testsuite/poke.pkl/try-until-diag-1.pk: New test.
	* testsuite/poke.pkl/try-until-1.pk: Likewise.
	* testsuite/poke.pkl/try-until-2.pk: Likewise.
	* testsuite/poke.pkl/try-until-3.pk: Likewise.

2019-11-12 John Darrington <john@darrington.wattle.id.au>

	* src/pkl-lex.l (YYFATAL_ERROR): Redefine

2019-11-12 John Darrington <john@darrington.wattle.id.au>

	* src/std.pk (ltrim): New function.
	* src/std.pk (rtrim): New function.
	* doc/poke.texi (String Functions): New chapter.
	* testsuite/poke.std/ltrim.pk: New file.
	* testsuite/poke.std/rtrim.pk: New file.

2019-11-12 John Darrington <john@darrington.wattle.id.au>

        * src/pk-file.c (pk_cmd_file): Use strerror for reason.
        (pk_cmd_load_file): ditto.

2019-11-11  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-trans.c (pkl_trans1_ps_string): Handle \".
	* src/pvm-val.c (pvm_print_val): Likewise.
	* testsuite/poke.pkl/strings-1.pk: New test.
	* testsuite/poke.pkl/strings-2.pk: Likewise.
	* testsuite/poke.pkl/strings-3.pk: Likewise.
	* doc/poke.texi (String Literals): Document \".

2019-11-11 John Darrington <john@darrington.wattle.id.au>

	* src/pk-editor.c (pk_cmd_editor): Initialize newline

2019-11-11 John Darrington <john@darrington.wattle.id.au>

	* src/pk-repl.c (pk_repl): Use ~/.poke_history to persist repl
	commands.
	* doc/poke.texi (The REPL): Document the use of readline and the
	poke_history file.

2019-11-11 John Darrington <john@darrington.wattle.id.au>

        * doc/poke.texi (The REPL): Fix typo

2019-11-11  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pk-print.c: Remove.
	* src/pk-cmd.c (print_cmd): Likewise.
	(cmds): Remove print_cmd.
	* src/Makefile.am (poke_SOURCES): Remove pk-print.c
	* testsuite/poke.map/maps-simple-1.pk: New test.
	* testsuite/poke.map/maps-simple-8.pk: Likewise.
	* testsuite/poke.map/maps-simple-7.pk: Likewise.
	* testsuite/poke.map/maps-simple-6.pk: Likewise.
	* testsuite/poke.map/maps-simple-5.pk: Likewise.
	* testsuite/poke.map/maps-simple-4.pk: Likewise.
	* testsuite/poke.map/maps-simple-3.pk: Likewise.
	* testsuite/poke.map/maps-simple-2.pk: Likewise.
	* testsuite/poke.pkl/sl-1.pk: Do not use .print.
	* testsuite/poke.map/maps-arrays-10.pk: Likewise.
	* testsuite/poke.map/maps-arrays-9.pk: Likewise.
	* testsuite/poke.map/maps-arrays-8.pk: Likewise.
	* testsuite/poke.map/maps-arrays-7.pk: Likewise.
	* testsuite/poke.map/maps-arrays-6.pk: Likewise.
	* testsuite/poke.map/maps-arrays-1.pk: Likewise.
	* testsuite/poke.map/valmaps-arrays.pk: Likewise.
	* testsuite/poke.map/trimmed-map-4.pk: Likewise.
	* testsuite/poke.map/trimmed-map-3.pk: Likewise.
	* testsuite/poke.map/trimmed-map-2.pk: Likewise.
	* testsuite/poke.map/trimmed-map.pk: Likewise.

2019-11-11  Jose E. Marchesi  <jemarch@gnu.org>

	* doc/poke.texi (.file): Add note about blank characters trimming
	from paths.

2019-11-11  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pk-cmd.c (pk_cmd_exec_1): Do not include trailing blanks in
	tag arguments.

2019-11-11  Jose E. Marchesi  <jemarch@gnu.org>

	* doc/poke.texi (The isa Operator): New chapter.

2019-11-10  Jose E. Marchesi  <jemarch@gnu.org>

	* doc/poke.texi (Functions): New chapter.
	(Function Declarations): New section.
	(Optional Arguments): Likewise.
	(Variadic Functions): Likewise.
	(Calling Functions): Likewise.
	(Function Types): Likewise.

2019-11-10  Jose E. Marchesi  <jemarch@gnu.org>

	* HACKING (Write After Approval): Add John Darrington.

2019-11-09  John Darrington  <john@darrington.wattle.id.au>

	* src/pk-repl.c: Include signa.h.
	(poke_sigint_handler): New function.
	(pk_repl): Install signal handler for SIGINT.

2019-11-09  John Darrington  <john@darrington.wattle.id.au>

	* src/ras: Correct punctuation in default error message.

2019-11-09  John Darrington  <john@darrington.wattle.id.au>

	* src/pk-editor.c (pk_cmd_editor): Use xrealloc instead of
	realloc.

2019-11-09  John Darrington  <john@darrington.wattle.id.au>

	* src/pk-editor.c (pk_cmd_editor): Fix memory leak.

2019-11-09  Jose E. Marchesi  <jemarch@gnu.org>

	* configure.ac: Make libreadline a hard requirement.
	* HACKING (readline): Document that now a full implementation of
	readline is required.

2019-11-09  Egeyar Bagcioglu  <egeyar@gmail.com>

	* testsuite/poke.map/maps-int-01.pk: New test.
	* testsuite/poke.map/maps-int-02.pk: Likewise.
	* testsuite/poke.map/maps-int-03.pk: Likewise.
	* testsuite/poke.map/maps-int-04.pk: Likewise.
	* testsuite/poke.map/maps-int-05.pk: Likewise.
	* testsuite/poke.map/maps-int-06.pk: Likewise.
	* testsuite/poke.map/maps-int-07.pk: Likewise.
	* testsuite/poke.map/maps-int-08.pk: Likewise.
	* testsuite/poke.map/maps-int-09.pk: Likewise.
	* testsuite/poke.map/maps-int-10.pk: Likewise.
	* testsuite/poke.map/maps-int-11.pk: Likewise.
	* testsuite/poke.map/maps-int-12.pk: Likewise.
	* testsuite/poke.map/maps-int-13.pk: Likewise.
	* testsuite/poke.map/maps-int-14.pk: Likewise.
	* testsuite/poke.map/maps-int-15.pk: Likewise.
	* testsuite/poke.map/maps-int-16.pk: Likewise.
	* testsuite/poke.map/maps-int-17.pk: Likewise.
	* testsuite/poke.map/maps-int-18.pk: Likewise.
	* testsuite/poke.map/maps-int-19.pk: Likewise.
	* testsuite/poke.map/maps-int-20.pk: Likewise.
	* testsuite/poke.map/maps-int-21.pk: Likewise.
	* testsuite/poke.map/maps-int-22.pk: Likewise.
	* testsuite/poke.map/maps-int-23.pk: Likewise.
	* testsuite/poke.map/maps-int-24.pk: Likewise.
	* testsuite/poke.map/maps-int-25.pk: Likewise.
	* testsuite/poke.map/maps-int-26.pk: Likewise.
	* testsuite/poke.map/maps-int-27.pk: Likewise.
	* testsuite/poke.map/maps-int-28.pk: Likewise.
	* testsuite/poke.map/maps-int-29.pk: Likewise.
	* testsuite/poke.map/maps-int-30.pk: Likewise.
	* testsuite/poke.map/maps-int-31.pk: Likewise.
	* testsuite/poke.map/maps-int-32.pk: Likewise.
	* testsuite/poke.map/maps-int-33.pk: Likewise.
	* testsuite/poke.map/maps-int-34.pk: Likewise.
	* testsuite/poke.map/maps-int-35.pk: Likewise.
	* testsuite/poke.map/maps-int-36.pk: Likewise.
	* testsuite/poke.map/maps-int-37.pk: Likewise.
	* testsuite/poke.map/maps-int-38.pk: Likewise.
	* testsuite/poke.map/maps-int-39.pk: Likewise.
	* testsuite/poke.map/maps-int-40.pk: Likewise.
	* testsuite/poke.map/maps-int-41.pk: Likewise.
	* testsuite/poke.map/maps-int-42.pk: Likewise.
	* testsuite/poke.map/maps-int-43.pk: Likewise.
	* testsuite/poke.map/maps-int-44.pk: Likewise.
	* testsuite/poke.map/maps-int-45.pk: Likewise.
	* testsuite/poke.map/maps-int-46.pk: Likewise.
	* testsuite/poke.map/maps-int-47.pk: Likewise.
	* testsuite/poke.map/maps-int-48.pk: Likewise.
	* testsuite/poke.map/maps-int-49.pk: Likewise.
	* testsuite/poke.map/maps-int-50.pk: Likewise.

2019-11-08  Jose E. Marchesi  <jemarch@gnu.org>

	* doc/poke.texi (Unmapping): New section.

2019-11-08  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-tab.y (stmt): Set location of assignments to maps.
	* src/pkl-ast.c (pkl_ast_lvalue_p): Allow maps in lvalues.
	* src/pkl-typify.c (pkl_typify1_ps_ass_stmt): The type of a map in
	an l-value shall be simple.
	* src/pkl-gen.c (pkl_gen_pr_ass_stmt): Handle maps in l-values.
	* doc/poke.texi (Assignments): Document maps in l-values.
	* testsuite/poke.pkl/ass-map-diag-1.pk: New test.
	* testsuite/poke.pkl/ass-map-diag-2.pk: Likewise.
	* testsuite/poke.map/ass-map-1.pk: Likewise.
	* testsuite/poke.map/ass-map-2.pk: Likewise.

2019-11-08  Jose E. Marchesi  <jemarch@gnu.org>

	* doc/poke.texi (Conditionals): New chapter.
	(if-else): New section.
	(Loops): New chapter.
	(while): New section.
	(for-in): Likewise.

2019-11-08  Jose E. Marchesi  <jemarch@gnu.org>

	* doc/poke.texi (Exception Handling): New chapter.
	(Exceptions): New section.
	(try-catch): Likewise.
	(raise): Likewise.

2019-11-08  Jose E. Marchesi  <jemarch@gnu.org>

	* src/std.pk (substr): Remove.
	(strstr): Likewise.
	(format): Likewise.
	* testsuite/poke.std/substr.pk: Remove test.
	* testsuite/poke.std/strstr.pk: Likewise.

2019-11-08  Jose E. Marchesi  <jose.marchesi@oracle.com>

	* doc/poke.texi (Standard Integral Types): New chapter.
	(Standard Offset Types): Likewise.
	(Coversion Functions): Likewise.
	(catos): New section.
	(atoi): Likewise.
	(Sorting Functions): New chapter.
	(qsort): New section.

2019-11-08  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pk-repl.c (banner): New function.
	(pk_repl): Call banner.
	(pk_repl_display_begin): Use rl_prompt instead of a literal
	string.

2019-11-08  Jose E. Marchesi  <jemarch@gnu.org>

	* src/std.pk (catos): Stop at the first null character '\0'.
	* testsuite/poke.std/catos-3.pk: New test.

2019-11-08  Jose E. Marchesi  <jemarch@gnu.org>

	* bootstrap.conf (gnulib_modules): Import the module unlink from
	gnulib.
	* src/pk-editor.c (pk_cmd_editor): Open result file and extract
	the new line from it.
	Remove the temporary file.
	* doc/poke.texi (.editor): New chapter.

2019-11-07  Jose E. Marchesi  <jemarch@gnu.org>

	* bootstrap.conf (gnulib_modules): Import `system' gnulib module.
	* src/pk-editor.c: New file.
	* src/pk-cmd.c (editor_cmd): New extern.
	(cmds): Add editor_cmd.
	* src/Makefile.am (poke_SOURCES): Add pk_editor.c.

2019-11-08  Jose E. Marchesi  <jemarch@gnu.org>

	* pickles/bpf.pk (BPF_Insn_Opcode._print): Simply using the `in'
	operator.
	(bpf_class_is_alujmp): Likewise.
	* pickles/btf.pk (BTF_Type): Likewise.

2019-11-08  Michael Drüing <michael@drueing.de>

	* src/std.pk (atoi): New function.
	* testsuite/poke.std/atoi-1.pk: New test.
	* testsuite/poke.std/atoi-2.pk: Likewise.
	* testsuite/poke.std/atoi-3.pk: Likewise.
	* testsuite/poke.std/atoi-4.pk: Likewise.
	* testsuite/poke.std/atoi-5.pk: Likewise.
	* testsuite/poke.std/atoi-6.pk: Likewise.
	* testsuite/poke.std/atoi-7.pk: Likewise.
	* testsuite/poke.std/atoi-8.pk: Likewise.
	* testsuite/poke.std/atoi-9.pk: Likewise.
	* testsuite/poke.std/atoi-10.pk: Likewise.
	* testsuite/poke.std/atoi-11.pk: Likewise.
	* testsuite/poke.std/atoi-12.pk: Likewise.
	* testsuite/poke.std/atoi-13.pk: Likewise.

2019-11-08  Jose E. Marchesi  <jose.marchesi@oracle.com>

	* HACKING (Writing poke Tests): New section.

2019-11-08  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-tab.y: Handle compound statements in the parser
	destructor.

2019-11-07  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pk-repl.h: New file.
	* src/pk-repl.c: Likewise.
	* src/Makefile.am (poke_SOURCES): Add pk-repl.c and pk-repl.h
	* HACKING (Appendix): Add src/pk-repl.h and src/pk-repl.c to the
	list of sources.
	* src/poke.c: Include pk-repl.h
	(repl): Remove function.
	(main): Use pk_repl.

2019-11-06  Darshit Shah  <darnir@gnu.org>

    * bootstrap.conf: Exit out if jitter's bootstrap fails

2019-11-06  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pk-term.c (pk_term_hyperlink): Fix guard.
	(pk_term_end_hyperlink): Likewise.

2019-11-06  Jose E. Marchesi  <jemarch@gnu.org>

	* HACKING (Write After Approval): Add Darshit Shah to the list of
	commiters.

2019-11-05  Jose E. Marchesi  <jemarch@gnu.org>

	* testsuite/poke.pkl/union-diag-7.pk: New test.
	* src/pkl-tab.y (struct_type_field): Adjust location for $$ when
	the first token in the rule is empty.

2019-11-05  Jose E. Marchesi  <jemarch@gnu.org>

	* doc/poke.texi (Field Endianness): New section.

2019-11-05  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-gen.h (struct pkl_gen_payload): New field endian.
	* src/pkl-gen.pks (struct_field_mapper): Handle field endianness.
	* src/pkl-gen.c (pkl_gen_ps_type_integral): Likewise.
	* src/pkl-asm.c (pkl_asm_insn): Handle PKL_INSN_POKE.
	(pkl_asm_insn_poke): New function.
	* src/pkl-insn.def: Define PKL_INSN_POKE.
	* testsuite/poke.map/maps-structs-endian-1.pk: New test.

2019-11-05  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-ast.h (PKL_AST_STRUCT_TYPE_FIELD_ENDIAN): Define.
	(enum pkl_ast_endian): New entry PKL_AST_DFL.
	(struct pkl_ast_struct_type_field): New field endian.
	* src/pkl-ast.c (pkl_ast_make_struct_type_field): Handle the
	`endian' attribute.
	(pkl_ast_dup_type): Likewise.
	(pkl_ast_print_1): Likewise.
	* src/pkl-typify.c (pkl_typify1_ps_struct): Likewise.
	* src/pkl-lex.l: Tokens BIG and LITTLE.
	* src/pkl-tab.y (struct_type_field): handle endianness in fields.
	(endianness): New rule.
	* src/pkl-anal.c (pkl_anal2_ps_struct_type_field): New handler.
	(pkl_phase_anal2): Register handler.
	* testsuite/poke.pkl/struct-endian-diag-1.pk: New test.
	* testsuite/poke.pkl/struct-types-endian-diag-2.pk: Likewise.

2019-11-05  Jose E. Marchesi  <jemarch@gnu.org>

	* testsuite/Makefile.am (POKESTYLESDIR): Define when invoking
	dejagnu.
	* testsuite/lib/poke-dg.exp (dg-require): Mark the test as
	unsupported if appropriate.
	* testsuite/poke.pkl/printf-class-1.pk: Require libtextstyle.
	* testsuite/poke.pkl/printf-class-4.pk: Likewise.
	* testsuite/poke.pkl/printf-class-3.pk: Likewise.
	* testsuite/poke.pkl/printf-class-2.pk: Likewise.

2019-11-05  Jose E. Marchesi  <jemarch@gnu.org>

	* HACKING (Building): it is no longer necessary to pass
	--with-jitter to configure.

2019-11-05  Luca Saiu  <positron@gnu.org>

	* HACKING: Replace "program" to "routine".  Update data
	structure description.  Update debugging and configuration
	information as related to Jitter.  Minor rewording and grammar
	fixes.
	* TODO: Change "program" to "routine".
	* Makefile.am (SUBDIRS): Add jitter.
	* acinclude.m4: Remove file.
	* bootstrap.conf (bootstrap_post_import_hook): New function.
	* configure.ac: Include m4/jitter.m4, now copied from jitter by
	bootstrap.
	(AC_JITTER): Remove along with checks.  Replace with
	AC_JITTER_SUBPACKAGE, which includes tests.
	(--enable-debug, --disable-debug): Remove options.
	(ENABLE_DEBUG): Remove variable.  Remove substitution.
	(POKE_DEBUG): Remove Automake conditional.
	* src/Makefile.am (poke_CPPFLAGS, poke_CFLAGS, poke_LDADD)
	(poke_LDFLAGS): Unconditionalize.
	* src/pvm-val.h: Change to Jitter unified routine API.
	Include jitter/jitter-routine.h to break dependency cycle.
	Add comments.
	(struct pvm_cls): Rename field program to routine, type
	from struct jitter_program * to jitter_routine.
	Change type for field entry_point from void * to
	jitter_program_point.
	(pvm_program): Remove typedef.  Now the include cycle breaking works
	differently.
	* src/pvm-val.c: Change to Jitter unified routine API.
	* src/pk-cmd.c: Change to Jitter unified routine API.
	* src/pk-cmd.h: Change to Jitter unified routine API.
	* src/pk-print.c: Change to Jitter unified routine API.
	* src/pkl-asm.c: Change to Jitter unified routine API.
	* src/pkl-gen.c: Change to Jitter unified routine API.
	* src/pkl-gen.h: Change to Jitter unified routine API.
	* src/pkl.c: Change to Jitter unified routine API.
	* src/pkl.h: Change to Jitter unified routine API.
	* src/pvm-alloc.c: Change to Jitter unified routine API.
	* src/pvm-env.h: Change to Jitter unified routine API.
	* src/pvm.c: Change to Jitter unified routine API.
	* src/pvm.h: Change to Jitter unified routine API.
	* src/ras: Change to Jitter unified routine API.

2019-11-04  Jose E. Marchesi  <jemarch@gnu.org>

	* doc/poke.texi (Structs): New chapter.
	(Struct Literals): New section.
	(Struct Types): Likewise.
	(Unions): Likewise.
	(Pinned Structs): Likewise.
	(Struct Attributes): Likewise.
	(Methods): Likewise.
	(Declarations in Structs): Likewise.

2019-11-04  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-asm.pks (remap): Do not check for a null value.

2019-11-04  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-asm.pks (bconc): New macro.
	* src/pkl-asm.c (pkl_asm_insn_bconc): Use bconc macro.
	* src/pkl-fold.c (pkl_fold_bconc): New handler.
	* testsuite/poke.pkl/bconc-1.pk: New file.
	* testsuite/poke.pkl/bconc-2.pk: Likewise.
	* testsuite/poke.pkl/bconc-3.pk: Likewise.
	* testsuite/poke.pkl/bconc-4.pk: Likewise.
	* testsuite/poke.pkl/bconc-5.pk: Likewise.
	* testsuite/poke.pkl/bconc-6.pk: Likewise.

2019-11-04  Jose E. Marchesi  <jemarch@gnu.org>

	* etc/poke-ras-mode.el (poke-ras-mode): Indent labels properly.

2019-11-04  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-asm.pks (ais): Remove unused argument atype.
	* src/pkl-asm.c (pkl_asm_insn_ais): Adjust accordintly.

2019-11-04  Jose E. Marchesi  <jemarch@gnu.org>

	* HACKING: Add information about maintainers.

2019-11-03  Darshit Shah  <darnir@gnu.org>

	* m4/libtextstyle-hyperlink.m4: New file with autoconf macro to
	test for hyperlink support in libtextstyle
	* configure.ac: Invoke new macro AX_LIBTEXTSTYLE_HYPERLINK
	* src/pk-term.c (pk_term_hyperlink): Conditionally invoke the
	function styled_ostream_set_hyperlink based on whether
	libtextstyle supports it
	(pk_term_end_hyperlink): Same

2019-11-03  Luca Saiu  <positron@gnu.org>

	* src/Makefile.am (.pks.pkc): Do not rely on GNU Make extension.

2019-11-03  Egeyar Bagcioglu  <egeyar@gmail.com>

	* src/ios.c (ios_read_int): Rewrite.
	(ios_read_uint): Move the common functionality between read_ios_int
	and read_ios_uint from here ...
	(ios_read_int_common): ... to here.

2019-11-03  Darshit Shah  <darnir@gnu.org>

	* bootstrap.conf (MSGID_BUGS_ADDRESS): Fix bug reporting address
	(buildreq): Add a list of build prerequisites
	(gnulib_modules): Sort and split list into separate lines. Also
	deduplicate list (readline, getopt-gnu)
	Remove gendocs-template which is not a gnulib module

2019-11-03  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-insn.def: New instruction ais.
	* src/pkl-asm.c (pkl_asm_insn): Handle AIS.
	(pkl_asm_insn_ais): New function.
	* src/pkl-asm.pks (ais): New macro.
	* src/pkl-gen.c (pkl_gen_ps_op_in): Use PKL_INSN_AIS.
	* doc/poke.texi (Array Elements): New section.

2019-11-02  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-ops.def: Define IN operator.
	* src/pkl-tab.y: Rule for the IN binary operator.
	* src/pkl-typify.c (pkl_typify1_ps_op_in): New handler.
	(pkl_phase_typify1): Register handler.
	* src/pkl-promo.c (pkl_promo_ps_op_in): New handler.
	(pkl_phase_promo): Register handler.
	* src/pkl-asm.c (pkl_asm_insn_cmp): Add support for offsets.
	* src/pkl-gen.c (pkl_gen_ps_op_rela): Adjust accordingly.
	* src/pkl-gen.c (pkl_gen_ps_op_in): New handler.
	(pkl_phase_gen): Register handler.
	* testsuite/poke.pkl/in-diag-1.pk: New test.
	* testsuite/poke.pkl/in-diag-2.pk: Likewise.
	* testsuite/poke.pkl/in-diag-3.pk: Likewise.
	* testsuite/poke.pkl/in-diag-4.pk: Likewise.
	* testsuite/poke.pkl/in-3.pk: Likewise.
	* testsuite/poke.pkl/in-2.pk: Likewise.
	* testsuite/poke.pkl/in-1.pk: Likewise.

2019-11-02  Egeyar Bagcioglu  <egeyar@gmail.com>

        * src/ios.c (ios_read_uint): Fix the fast track for 40 bit integers.
        * testsuite/poke.map/maps-uint-41.pk: New test.
        * testsuite/poke.map/maps-uint-42.pk: Likewise.
        * testsuite/poke.map/maps-uint-43.pk: Likewise.
        * testsuite/poke.map/maps-uint-44.pk: Likewise.
        * testsuite/poke.map/maps-uint-45.pk: Likewise.
        * testsuite/poke.map/maps-uint-46.pk: Likewise.
        * testsuite/poke.map/maps-uint-47.pk: Likewise.
        * testsuite/poke.map/maps-uint-48.pk: Likewise.
        * testsuite/poke.map/maps-uint-49.pk: Likewise.
        * testsuite/poke.map/maps-uint-50.pk: Likewise.
        * testsuite/poke.map/maps-uint-51.pk: Likewise.
        * testsuite/poke.map/maps-uint-52.pk: Likewise.
        * testsuite/poke.map/maps-uint-53.pk: Likewise.
        * testsuite/poke.map/maps-uint-54.pk: Likewise.

2019-11-02  Egeyar Bagcioglu  <egeyar@gmail.com>

        * testsuite/poke.map/maps-uint-1.pk: New test.
        * testsuite/poke.map/maps-uint-2.pk: Likewise.
        * testsuite/poke.map/maps-uint-3.pk: Likewise.
        * testsuite/poke.map/maps-uint-4.pk: Likewise.
        * testsuite/poke.map/maps-uint-5.pk: Likewise.
        * testsuite/poke.map/maps-uint-6.pk: Likewise.
        * testsuite/poke.map/maps-uint-7.pk: Likewise.
        * testsuite/poke.map/maps-uint-8.pk: Likewise.
        * testsuite/poke.map/maps-uint-9.pk: Likewise.
        * testsuite/poke.map/maps-uint-10.pk: Likewise.
        * testsuite/poke.map/maps-uint-11.pk: Likewise.
        * testsuite/poke.map/maps-uint-12.pk: Likewise.
        * testsuite/poke.map/maps-uint-13.pk: Likewise.
        * testsuite/poke.map/maps-uint-14.pk: Likewise.
        * testsuite/poke.map/maps-uint-15.pk: Likewise.
        * testsuite/poke.map/maps-uint-16.pk: Likewise.
        * testsuite/poke.map/maps-uint-17.pk: Likewise.
        * testsuite/poke.map/maps-uint-18.pk: Likewise.
        * testsuite/poke.map/maps-uint-19.pk: Likewise.
        * testsuite/poke.map/maps-uint-20.pk: Likewise.
        * testsuite/poke.map/maps-uint-21.pk: Likewise.
        * testsuite/poke.map/maps-uint-22.pk: Likewise.
        * testsuite/poke.map/maps-uint-23.pk: Likewise.
        * testsuite/poke.map/maps-uint-24.pk: Likewise.
        * testsuite/poke.map/maps-uint-25.pk: Likewise.
        * testsuite/poke.map/maps-uint-26.pk: Likewise.
        * testsuite/poke.map/maps-uint-27.pk: Likewise.
        * testsuite/poke.map/maps-uint-28.pk: Likewise.
        * testsuite/poke.map/maps-uint-29.pk: Likewise.
        * testsuite/poke.map/maps-uint-30.pk: Likewise.
        * testsuite/poke.map/maps-uint-31.pk: Likewise.
        * testsuite/poke.map/maps-uint-32.pk: Likewise.
        * testsuite/poke.map/maps-uint-33.pk: Likewise.
        * testsuite/poke.map/maps-uint-34.pk: Likewise.
        * testsuite/poke.map/maps-uint-35.pk: Likewise.
        * testsuite/poke.map/maps-uint-36.pk: Likewise.
        * testsuite/poke.map/maps-uint-37.pk: Likewise.
        * testsuite/poke.map/maps-uint-38.pk: Likewise.
        * testsuite/poke.map/maps-uint-39.pk: Likewise.
        * testsuite/poke.map/maps-uint-40.pk: Likewise.
        * testsuite/poke.map/maps-uint-diag-1.pk: Likewise.

2019-11-02  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-fold.c (EMUL_UUU): For cdiv.
	(EMUL_III): Likewise.
	(pkl_fold_cdiv): New handler.
	* src/pkl-asm.pks (cdiv): New macro.
	(cdivo): New macro.
	* src/pkl-asm.c (pkl_asm_insn_cdivo, pvm_make_integral): New
	function.
	(pkl_asm_insn_cdiv): Likewise.
	(pkl_asm_insn_cdivo): Likewise.
	(pkl_asm_insn): Call pkl_asm_insn_cdiv and pkl_asm_insn_cdivo.
	* src/pkl-insn.def (PKL_INSN_CDIV): New instruction.
	(PKL_INSN_CDIVO): Likewise.
	* src/pkl-gen.c (pkl_gen_ps_op_ceildiv): New handler.
	(pkl_phase_gen): Register the handler.
	* src/pkl-promo.c (pkl_phase_promo): Register pkl_promo_ps_op_div
	to promote ceildiv nodes.
	* src/pkl-typify.c (pkl_typify1_ps_op_ceildiv): New handler.
	(pkl_phase_typify1): Register handler.
	(CASE_OFFSET): Handle ceildiv.
	* src/pkl-ops.def (PKL_AST_OP_CEILDIV): Define.
	* src/pkl-tab.y: New token CEILDIV.
	* src/pkl-lex.l: Rule for CEILDIV.
	* testsuite/poke.pkl/cdiv-offsets-2.pk: Likewise.
	* testsuite/poke.pkl/cdiv-offsets-1.pk: Likewise.
	* testsuite/poke.pkl/cdiv-integers-2.pk: Likewise.
	* testsuite/poke.pkl/cdiv-integers-1.pk: New test.
	* doc/poke.texi (Offset Operations): Document /^ for offsets.
	(Arithmetic Operators): Likewise for integers.

2019-11-02  Jose E. Marchesi  <jemarch@gnu.org>

	* doc/poke.texi (.set): The default endianness is big endian, not
	host endian.

2019-10-30  Jose E. Marchesi  <jemarch@gnu.org>

	* doc/poke.texi (Shebang): New section.
	(Scripts): Likewise.
	(Invoking poke): Likewise.

2019-10-30  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pvm.jitter (pvm_literal_printer): Use poke_obase.
	(pvm_literal_printer_lo): Likewise.
	(strace): Likewise.

2019-10-29  Jose E. Marchesi  <jemarch@gnu.org>

	* pickles/bpf.pk (BPF_Insn_Offset): New type.
	(BPF_Insn): Use BPF_Insn_Offset.

2019-10-29  Jose E. Marchesi  <jemarch@gnu.org>

	* pickles/btf.pk (btf_types): New function.
	(btf_strings): Likewise.

2019-10-29  Jose E. Marchesi  <jemarch@gnu.org>

	* doc/poke.texi (Commanding poke): New chapter.
	(The REPL): New section.
	(Evaluation): New section.
	(Commands): Likewise.
	(Scripts): Likewise.
	(Shebang): Likewise.
	(.load): New chapter.

2019-10-29  Jose E. Marchesi  <jemarch@gnu.org>

	* doc/poke.texi (.vm): New chapter.
	(.vm disassemble): New section.

2019-10-29  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-fold.c (pkl_fold_pr_type): New handler.
	(pkl_phase_fold): Register handler.
	* src/pkl-promo.c (pkl_promo_pr_type): New handler.
	(pkl_phase_promo): Register handler.
	* src/pkl-typify.c (pkl_typify_pr_type): New handler.
	(pkl_phase_typify1): Register handler.
	Likewise.
	* src/pkl-anal.c: Do not define nor use a pkl_anal_ps_type
	handler.  It is unneccessary.
	* src/pkl-trans.c: Set the `compiled' flag of types AST nodes only
	in trans4.

2019-10-29  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-ast.h (struct pkl_ast_type): New field `compiled'.
	(PKL_AST_TYPE_COMPILED): Define.
	* src/pkl-anal.c (pkl_anal_pr_type): Define.
	(pkl_anal_ps_type): Define.
	(pkl_phase_anal1): Registers the handlers.
	(pkl_phase_anal2): Likewise.
	(pkl_phase_analf): Likewise.
	* src/pkl-trans.c (pkl_trans_pr_type): Define.
	(pkl_trans_ps_type): Define.
	(pkl_phase_trans1): Registers the handlers.
	(pkl_phase_trans2): Likewise.
	(pkl_phase_trans3): Likewise.
	(pkl_phase_trans4): Likewise.

2019-10-29  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-gen.c (pkl_gen_pr_decl): Avoid recompiling type closures
	(mapper, writer, constructor, etc) again and again.

2019-10-29  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-gen.pks (struct_constructor): Set/clear
	payload->in_constructor and not payload->in_mapper.
	* testsuite/poke.pkl/struct-types-6.pk: New test.

2019-10-29  Jose E. Marchesi  <jemarch@gnu.org>

	* doc/poke.texi (.set): New section.
	(.exit): Likewise.
	(.file): Likewise.
	(.info): Likewise.

2019-10-29  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-lex.l: Remove token TRIMOP.
	* src/pkl-tab.y: Use ':' instead of TRIMOP in trimmers rules.
	* src/std.pk (substr): Adapt to the new syntax.
	* trim.pk: Remove.
	* testsuite/poke.pkl/trim-1.pk: From trim.pk and adapted to new
	syntax.
	* testsuite/poke.pkl/trim-24.pk: Likewise.
	* testsuite/poke.pkl/trim-23.pk: Likewise.
	* testsuite/poke.pkl/trim-22.pk: Likewise.
	* testsuite/poke.pkl/trim-21.pk: Likewise.
	* testsuite/poke.pkl/trim-20.pk: Likewise.
	* testsuite/poke.pkl/trim-19.pk: Likewise.
	* testsuite/poke.pkl/trim-18.pk: Likewise.
	* testsuite/poke.pkl/trim-17.pk: Likewise.
	* testsuite/poke.pkl/trim-16.pk: Likewise.
	* testsuite/poke.pkl/trim-15.pk: Likewise.
	* testsuite/poke.pkl/trim-14.pk: Likewise.
	* testsuite/poke.pkl/trim-13.pk: Likewise.
	* testsuite/poke.pkl/trim-12.pk: Likewise.
	* testsuite/poke.pkl/trim-11.pk: Likewise.
	* testsuite/poke.pkl/trim-10.pk: Likewise.
	* testsuite/poke.pkl/trim-9.pk: Likewise.
	* testsuite/poke.pkl/trim-8.pk: Likewise.
	* testsuite/poke.pkl/trim-7.pk: Likewise.
	* testsuite/poke.pkl/trim-6.pk: Likewise.
	* testsuite/poke.pkl/trim-5.pk: Likewise.
	* testsuite/poke.pkl/trim-4.pk: Likewise.
	* testsuite/poke.pkl/trim-3.pk: Likewise.
	* testsuite/poke.pkl/trim-2.pk: Likewise.
	* testsuite/poke.map/trimmed-map.pk: Adapt to new syntax.
	* testsuite/poke.map/trimmed-map-4.pk: Likewise.
	* testsuite/poke.map/trimmed-map-3.pk: Likewise.
	* testsuite/poke.map/trimmed-map-2.pk: Likewise.

2019-10-29  Jose E. Marchesi  <jemarch@gnu.org>

	* doc/poke.texi (Array Indexing): New section.
	(Array Trimming): Likewise.
	(Array Attributes): Likewise.

2019-10-28  Jose E. Marchesi  <jemarch@gnu.org>

	* doc/poke.texi: New chapters and sections.

2019-10-28  Jose E. Marchesi  <jemarch@gnu.org>

	* doc/poke.texi (Integers): New chapter.
	(Integer Literals): New section.
	(Characters): Likewise.
	* testsuite/poke.pkl/printf-value-2.pk: Remove empty line at EOF.
	* testsuite/poke.pkl/printf-value-5.pk: Likewise.

2019-10-27  Jose E. Marchesi  <jemarch@gnu.org>

	* doc/poke.texi (Offsets): New chapter.
	(Why offsets): New section.
	(Offset values): Likewise.
	(Offset operations): Likewise.

2019-10-27  Jose E. Marchesi  <jemarch@gnu.org>

	* doc/poke.texi (Endianness): New chapter.
	(.set endian): New section.
	(Endian built-ins): Likewise.

2019-10-27  Jose E. Marchesi  <jemarch@gnu.org>

	* bootstrap.conf (gnulib_modules): Import the gendocs-template
	gnulib module.

2019-10-27  Jose E. Marchesi  <jemarch@gnu.org>

	* doc/poke.texi (Output): New chapter.
	(print): New section.
	(printf): Likewise.
	(Styling): Likewise.

2019-10-27  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-promo.c (pkl_promo_ps_print_stmt): Fix bug handling %v
	printf arguments.
	* pickles/bpf.pk: Use %v in imm64 pretty-printer.
	* testsuite/poke.pkl/printf-value-5.pk: New test.

2019-10-27  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pvm.jitter (printv): Use the global poke_obase.
	* testsuite/poke.pkl/printf-value-1.pk: .set obase.
	* testsuite/poke.pkl/printf-value-2.pk: Likewise.
	* testsuite/poke.pkl/printf-value-3.pk: Likewise.
	* testsuite/poke.pkl/printf-value-4.pk: New file.

2019-10-26  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-ast.h (PKL_AST_PRINT_STMT_ARG_PRINT_VALUE_P): Define.
	* src/pkl-trans.c (pkl_trans1_ps_print_stmt): Handle %v tags in
	format strings.
	* src/pkl-typify.c (pkl_typify1_ps_print_stmt): Allow any type for
	%v.
	* src/pkl-asm.c (pkl_asm_insn_print): Issue a `printv' instruction
	to print values in %v tags.
	* src/pkl-insn.def: New instruction printv.
	* src/pvm.jitter (printv): Implement.
	* testsuite/poke.pkl/printf-value-1.pk: New test.
	* testsuite/poke.pkl/printf-value-2.pk: Likewise.
	* testsuite/poke.pkl/printf-value-3.pk: Likewise.

2019-10-26  Jose E. Marchesi  <jemarch@gnu.org>

	* HACKING (Writing Poke): Recommend using the #<...> convention
	for pretty-printed values.

2019-10-26  Jose E. Marchesi  <jemarch@gnu.org>

	* pickles/bpf.pk (BPF_Reg): Use styling when printing register
	names.
	(BPF_Insn_Opcode): Likewise for instruction mnemonics.
	* etc/poke-default.css (.insn-register): New class.
	(.insn-mnemonic): Likewise.

2019-10-26  Jose E. Marchesi  <jemarch@gnu.org>

	* pickles/bpf.pk (bpf_alu_opcodes): New variable.
	(bpf_jmp_opcodes): Likewise.
	(bpf_ldst_sizes): Likewise.
	(BPF_Insn_Opcode): Pretty printers.
	(BPF_Insn): Pretty printer for imm64.

2019-10-26  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-gen.c (pkl_gen_pr_op_and): New handler.
	(pkl_gen_pr_op_or): Likewise.
	(pkl_gen_ps_op_and): Remove.
	(pkl_gen_ps_op_or): Likewise.
	* testsuite/poke.pkl/and-13.pk: New test.
	* testsuite/poke.pkl/or-4.pk: Likewise.

2019-10-26  Jose E. Marchesi  <jemarch@gnu.org>

	* pickles/bpf.pk: New file.
	* pickles/btf.pk: Likewise.
	* pickles/Makefile.am (dist_pkgdata_DATA): Add bpf.pk and btf.pk.

2019-10-26  Egeyar Bagcioglu  <egeyar@gmail.com>

	* bootstrap.conf (gnulib_modules): Import the module byteswap from
	gnulib.
	* src/ios.c (IOS_GET_C_ERR_CHCK): Define.
	(IOS_READ_INTO_CHARRAY_1BYTE): Likewise.
	(IOS_READ_INTO_CHARRAY_2BYTES): Likewise.
	(IOS_READ_INTO_CHARRAY_3BYTES): Likewise.
	(IOS_READ_INTO_CHARRAY_4BYTES): Likewise.
	(IOS_READ_INTO_CHARRAY_5BYTES): Likewise.
	(IOS_READ_INTO_CHARRAY_6BYTES): Likewise.
	(IOS_READ_INTO_CHARRAY_7BYTES): Likewise.
	(IOS_READ_INTO_CHARRAY_8BYTES): Likewise.
	(IOS_READ_INTO_CHARRAY_9BYTES): Likewise.
	(ios_mask_first_byte): New function.
	(ios_mask_last_byte): Likewise.
	(ios_read_uint): Rewrite.

2019-10-25  Jose E. Marchesi  <jemarch@gnu.org>

	* HACKING (Writing RAS): New section.

2019-10-25  Jose E. Marchesi  <jemarch@gnu.org>

	* src/ras: Recognize empty .c lines without a trailing whitespace.

2019-10-25  Jose E. Marchesi  <jemarch@gnu.org>

	* pickles/future/bson.pk: Syntax-check fixes.
	* src/pkl.c: Likewise.
	* testsuite/poke.map/maps-structs-methods-5.pk: Likewise.
	* src/pkl-trans.c: Likewise.
	* src/pkl-gen.pks: Likewise.
	* src/pkl-gen.c: Likewise.
	* src/pkl-ast.c: Likewise.
	* src/pkl-anal.c: Likewise.
	* src/ios.c: Likewise.
	* pickles/leb128.pk: Likewise.
	* etc/poke-ras-mode.el: Likewise.
	* testsuite/poke.map/maps-unions-8.pk: Likewise.
	* testsuite/poke.pkl/struct-pretty-print-3.pk: Likewise.
	* testsuite/poke.pkl/struct-pretty-print-1.pk: Likewise.
	* testsuite/poke.pkl/printf-class-2.pk: Likewise.
	* testsuite/poke.pkl/printf-class-1.pk: Likewise.
	* testsuite/poke.map/maps-structs-methods-7.pk: Likewise.
	* testsuite/poke.map/maps-structs-methods-6.pk: Likewise.

2019-10-25  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pvm.jitter (PVM_PEEK): Raise exceptionspa in case of IO
	end-of-file and generic IO error.
	(PVM_POKE): Likewise.
	(peeks): Likewise.
	* src/pkl-gen.c (pkl_gen_pr_map): Do not handle EOF.
	* src/pkl-rt.pk (_pkl_exception_handler): Handle E_io.
	* src/pkl-gen.pks (array_mapper): Adjust to the new handling of
	EOF.
	* testsuite/poke.map/maps-unions-7.pk: New test.
	* testsuite/poke.map/maps-unions-8.pk: Likewise.

2019-10-25  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-anal.c (pkl_anal1_ps_type_struct): Do not allow
	declarations after union fields.
	* testsuite/poke.map/maps-unions-6.pk: Likewise.
	* testsuite/poke.pkl/union-diag-6.pk: Likewise.
	* testsuite/poke.pkl/union-diag-5.pk: Likewise.
	* testsuite/poke.pkl/union-diag-4.pk: New test.

2019-10-24  Jose E. Marchesi  <jose.marchesi@oracle.com>

	* HACKING (Dejagnu): Mention as a dependency.

2019-10-24  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-ast.h (PKL_AST_BUILTIN_GET_ENDIAN): Define.
	(PKL_AST_BUILTIN_SET_ENDIAN): Likewise.
	* src/pkl-tab.y (BUILTIN_GET_ENDIAN): New token.
	(BUILTIN_SET_ENDIAN): Likewise.
	(builtins): New rule.
	(comp_stmt): Use rule `builtins'.
	* src/pkl-lex.l: Tokens for get_endian and set_endian built-ins.
	* src/pvm.jitter (pushend): New instruction.
	(popend): Likewise.
	* src/pkl-insn.def (PKL_INSN_PUSHEND): Define.
	(PKL_INSN_POPEND): Likewise.
	* src/pkl-rt.pk (get_endian): Define.
	(set_endian): Likewise.
	(ENDIAN_LITTLE): New variable.
	(ENDIAN_BIG): Likewise.
	* src/pkl-gen.c (pkl_gen_ps_comp_stmt): Generate code for
	PKL_AST_BUILTIN_GET_ENDIAN and PKL_AST_BUILTIN_SET_ENDIAN
	builtins.
	* testsuite/poke.pkl/get-endian-1.pk: New test.
	* testsuite/poke.pkl/set-endian-1.pk: Likewise.

2019-10-24  Jose E. Marchesi  <jemarch@gnu.org>

	* src/ios.c (ios_read_uint): Add support for reading 4-bit
	unsigned integers from addresses aligned to 8 or 4 bytes.

2019-10-23  Jose E. Marchesi  <jemarch@gnu.org>

	* pickles/Makefile.am (dist_pkgdata_DATA): Add leb128.pk

2019-10-22  Jose E. Marchesi  <jemarch@gnu.org>

	* testsuite/poke.pkl/struct-types-diag-8.pk: New file.
	* testsuite/poke.map/maps-structs-methods-6.pk: Likewise.
	* testsuite/poke.map/maps-structs-methods-7.pk: Likewise.

2019-10-22  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-typify.c (pkl_typify1_ps_struct_ref): fix compile-time
	detection of invalid fields in struct references.

2019-10-22  Jose E. Marchesi  <jemarch@gnu.org>

	* pickles/leb128.pk: Rewritten and moved from future/.
	* etc/poke-default.css (.leb128): New class.

2019-10-22  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-ast.h (struct pkl_ast_print_stmt): New field
	fmt_processed_p.
	(PKL_AST_PRINT_STMT_FMT_PROCESSED_P): Define.
	* src/pkl-trans.c (pkl_trans1_ps_print_stmt): Handle
	fmt_processed_p.
	* HACKING (Middle End Handlers should be Re-executable): New
	section.

2019-10-22  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-gen.pks (struct_mapper): Fix bug in method handling.
	* testsuite/poke.map/maps-structs-methods-5.pk: New file.

2019-10-22  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pvm.h: Prototypes for pvm_pretty_print and
	pvm_set_pretty_print.
	* src/pvm.c (pvm_pretty_print): New function.
	(pvm_set_pretty_print): Likewise.
	(PVM_STATE_PRETTY_PRINT): Define.
	* src/pvm.jitter (state-struct-runtime-c): Add pretty_print.
	(state-initialization-c): Initialize pretty_print to 0.
	* src/pk-set.c (pk_cmd_set_pretty_print): New function.
	(set_pretty_print_cmd): New struct.
	(set_cmds): Add set-pretty_print_cmd.
	* src/pvm-val.h: Prototype for pvm_get_struct_method.
	Prototype for pvm_call_cls.
	* src/pvm-val.c (pvm_get_struct_method): New function.
	(pvm_call_pretty_printer): Likewise.
	* testsuite/poke.pkl/struct-pretty-print-1.pk: New file.
	* testsuite/poke.pkl/struct-pretty-print-2.pk: New file.
	* testsuite/poke.pkl/struct-pretty-print-3.pk: Likewise.
	* testsuite/poke.pkl/struct-pretty-print-4.pk: Likewise.

2019-10-22  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-typify.c (pkl_typify1_ps_struct_ref): Allow using dot
	notation to refer to struct methods.
	* src/pkl-trans.c (pkl_trans2_ps_struct_ref): Turn struct
	references to parameterless methods into funcalls.
	* src/pvm-val.c (pvm_ref_struct): Allow referencing to methods by
	name.
	* testsuite/poke.map/maps-structs-18.pk: New test.
	* testsuite/poke.map/maps-structs-methods-1.pk: Likewise.
	* testsuite/poke.map/maps-structs-methods-2.pk: Likewise.
	* testsuite/poke.map/maps-structs-methods-3.pk: Likewise.

2019-10-22  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pvm.jitter (mksct): Change instruction to get a list of
	methods.
	* src/pkl-gen.pks (struct_mapper): Adapt to the new form of mksct.
	(struct_constructor): Likewise.
	* testsuite/poke.map/maps-structs-14.pk: New test.
	* testsuite/poke.map/maps-structs-15.pk: Likewise.
	* testsuite/poke.map/maps-structs-16.pk: Likewise.
	* testsuite/poke.map/maps-structs-17.pk: Likewise.

2019-10-18  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pvm-val.h (PVM_VAL_SCT_METHOD): Define.
	(PVM_VAL_SCT_NMETHODS): Likewise.
	(pvm_make_struct): Add argument nmethods.
	(struct pvm_struct_method): New struct.
	(PVM_VAL_SCT_METHOD_NAME): Define.
	(PVM_VAL_SCT_METHOD_VALUE): Likewise.
	* src/pvm-val.c (pvm_make_struct): Likewise.
	* src/pvm.jitter (mksct): pass the number of methods to
	pvm_make_struct.

2019-10-22  Darkstar <michael@drueing.de>

	* src/poke.c: Several typos in comments fixed.
	(pk_print_version): Likewise.
	(initialize_user): Likewise.

2019-10-22  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-trans.c (pkl_trans1_ps_print_stmt): Avoid adding an
	empty suffix to the last arg when a %- tag finished the format
	string.

2019-10-22  Jose E. Marchesi  <jemarch@gnu.org>

	* configure.ac: Warn the user about not finding a full-fledged
	readline.

2019-10-21  Jose E. Marchesi  <jemarch@gnu.org>

	* src/poke.c (repl): print a newline when the user does Ctrl-D.

2019-10-21  Jose E. Marchesi  <jemarch@gnu.org>

	* src/Makefile.am (AM_YFLAGS): Do not pass -y to bison, as we are
	using non-POSIX capabilities.

2019-10-21  Jose E. Marchesi  <jemarch@gnu.org>

	* src/std.pk (catos): New function.
	* testsuite/poke.std/catos-1.pk: New file.
	* testsuite/poke.pkl/catos-2.pk: Likewise.

2019-10-21  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-lex.l (SHEBANG_COMMENT): New context.
	Rules to support multi-line #! ... !# comments.
	* src/poke.c (LOAD_AND_QUIT_ARG): Define.
	(print_help): Document -L.
	(parse_args): Implement -L.

2019-10-21  Jose E. Marchesi  <jemarch@gnu.org>

	* etc/poke-default.css (.error): Bold.

2019-10-21  Jose E. Marchesi  <jemarch@gnu.org>

	* testsuite/poke.cmd/set-error-on-warning.pk: New test.

2019-10-21  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl.h: Make pkl_error and pkl_warning to get a `compiler'
	option.
	* src/pkl.c (pkl_error_internal): New function.
	(pkl_error): Rewrite to be a wrapper for pkl_error_internal.
	* src/pkl-pass.h (PKL_ERROR): Define.
	(PKL_WARNING): Likewise.
	* src/pkl-anal.c (pkl_anal2_ps_type_struct): Use PKL_WARNING.
	* src/pkl-parser.h (struct pkl_parser): New field `compiler'.
	Make pkl_parse_file and pkl_parse_buffer get a new argument
	`compiler'.
	* src/pkl-parser.c (pkl_parse_file): Get a `compiler' option.
	(pkl_parse_buffer): Likewise.
	* src/pkl.c (pkl_compile_file): Pass `compiler' to pkl_parse_file.
	(pkl_compile_expression): Pass `compiler' to pkl_parse_buffer.
	(pkl_compile_buffer): Likewise.
	(pkl_compile_statement): Likewise.
	* src/pkl-tab.y: Pass pkl_parser->compiler to pkl_error calls.
	* src/pkl-anal.c: Use PKL_ERROR instead of pkl_error for
	diagnostics.
	* src/pkl-fold.c: Likewise.
	* src/pkl-trans.c: Likewise.
	* src/pkl-typify.c: Likewise.

2019-10-20  Jose E. Marchesi  <jemarch@gnu.org>

	* etc/poke-default.css (.dump-ruler): New class.
	(.dump-address): Likewise.
	(.dump-ascii): Likewise.
	* src/pk-dump.pk (dump): Stylize output.

2019-10-20  Jose E. Marchesi  <jemarch@gnu.org>

	* testsuite/Makefile.am (check-DEJAGNU): Set POKESTYLESDIR.
	* testsuite/poke.pkl/printf-class-1.pk: New test.
	* testsuite/poke.pkl/printf-class-4.pk: Likewise.
	* testsuite/poke.pkl/printf-class-3.pk: Likewise.
	* testsuite/poke.pkl/printf-class-2.pk: Likewise.

2019-10-20  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-trans.c (pkl_trans1_ps_print_stmt): Fix diagnostic for
	unclosed styling class tags.
	* testsuite/poke.pkl/printf-diag-6.pk: New file.
	* testsuite/poke.pkl/printf-diag-7.pk: Likewise.
	* testsuite/poke.pkl/printf-diag-8.pk: Likewise.

2019-10-20  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-promo.c (pkl_promo_ps_print_stmt): Skip arguments
	without associated values.
	* src/pkl-typify.c (pkl_typify1_ps_print_stmt): Likewise.
	* src/pkl-gen.c (pkl_gen_pr_print_stmt): Generate code for styling
	class format directives.
	* src/pkl-trans.c (pkl_trans1_ps_print_stmt): Support %<class: and
	%> format directives.

2019-10-19  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-ast.h (struct pkl_ast_print_stmt_arg): New fields
	begin_sc and end_sc.
	(PKL_AST_PRINT_STMT_ARG_BEGIN_SC): Define.
	(PKL_AST_PRINT_STMT_ARG_END_SC): Likewise.
	* src/pkl-ast.c (pkl_ast_node_free): Dispose the memory of
	begin_sc and end_sc.
	(pkl_ast_print_1): Print begin_sc and end_sc fields.

2019-10-19  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pvm.jitter (wrapped-functions): Add pk_term_class and
	pk_term_end_class.
	(begsc): New instruction.
	(endsc): Likewise.
	* src/pkl-insn.def: Define instructions begsc and endsc.

2019-10-19  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-pass.h (PKL_PASS_COMPILER): Define.
	(PKL_PASS_SUBPASS): Pass compiler to pkl_do_subpass.
	(PKL_PHASE_BEGIN_HANDLER): The node handler gets a compiler.
	(pkl_do_pass): Get a compiler argument.
	* src/pkl-pass.c (pkl_do_subpass): Handle new argument compiler.
	(pkl_do_pass): Likewise.
	(pkl_call_node_handlers): Likewise.
	(pkl_do_pass_1):  Likewise.
	(PKL_CALL_PHASES): Pass `compiler' to pkl_do_pass_1.
	(PKL_CALL_PHASES_SINGLE): Likewise.
	(PKL_PASS): Likewise.
	(PKL_PASS_CHAIN): Likewise.
	(pkl_do_pass_1): Likewise.
	(pkl_do_subpass): Likewise.
	* src/pkl.c (rest_of_compilation): Pass poke_compiler to
	pkl_do_pass.

2019-10-19  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl.c (struct pkl_compiler): New field error_on_warning.
	(pkl_error_on_warning): New function.
	(pkl_set_error_on_warning): Likewise.
	* src/pkl.h: Prototypes for pkl_error_on_warning and
	pkl_set_error_on_warning.
	* src/pk-cmd.c (pk_cmd_exec_1): Support `-' characters in command
	names.
	* src/pk-set.c (set_error_on_warning_cmd): New variable.
	(pk_cmd_set_error_on_warning): New function.
	(set_cmds): Add set_error_on_warning_cmd.

2019-10-19  Jose E. Marchesi  <jemarch@gnu.org>

	* TODO (#B0 remove hard limit in PKL_AST_MAX_POINTERS): New todo
	entry.
	(#A1 fold "isa" expressions): Likewise.

2019-10-18  Jose E. Marchesi  <jemarch@gnu.org>

	* testsuite/poke.map/maps-unions-5.pk: New file.

2019-10-18  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-gen.pks (struct_mapper): Generate code for declarations.
	(struct_constructor): Likewise.
	* testsuite/poke.pkl/struct-types-2.pk: New file.
	* testsuite/poke.map/maps-structs-11.pk: Likewise.
	* testsuite/poke.pkl/struct-types-3.pk: Likewise.
	* testsuite/poke.pkl/struct-types-4.pk: Likewise.
	* testsuite/poke.map/maps-structs-12.pk: Likewise.
	* testsuite/poke.pkl/struct-types-5.pk: Likewise.
	* testsuite/poke.map/maps-structs-13.pk: Likewise.

2019-10-18  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-ast.h (struct pkl_ast_type): Add nelem and ndecl fields
	to struct types.
	* src/pkl-trans.c (pkl_trans1_ps_type_struct): Count number of
	fields and declarations.
	* src/pkl-ast.c (pkl_ast_print_1): Print nfield and ndecl of
	struct types.
	(pkl_ast_dup_type): Copy ndecl and nfield when
	duplicating struct types.
	(pkl_ast_make_struct_type): Get nfield and ndecl arguments.
	* src/pkl-typify.c (pkl_typify1_ps_struct): Pass extra arguments
	to pkl_ast_make_struct_type.
	* src/pkl-gen.c (pkl_gen_ps_type_struct): Use
	PKL_AST_TYPE_S_NFIELD.

2019-10-18  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-tab.y (struct_field_type): Fix location of diagnostic
	for duplicated struct elements.
	* src/pkl-anal.c (pkl_anal1_ps_struct): Improve diagnostic.
	* testsuite/poke.pkl/struct-types-diag-5.pk: New test.
	* testsuite/poke.pkl/struct-types-diag-6.pk: Likewise.
	* testsuite/poke.pkl/struct-types-diag-7.pk: Likewise.

2019-10-18  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-anal.c (pkl_nala1_ps_type_struct): Fix typo in variable
	names.

2019-10-18  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-gen.c (pkl_gen_pr_decl): Rename type_struct_fields to
	type_struct_elems.
	(pkl_gen_pr_type_struct): Likewise.
	* src/pkl-gen.pks: Adapt to the fact struct type elements can be
	either struct type fields or declarations.

2019-10-18  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-ast.c (pkl_ast_dup_type): Adapt to the fact struct type
	elements can be either struct type fields or declarations.
	(pkl_ast_sizeof_type): Likewise.
	(pkl_print_type): Likewise.

2019-10-18  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-typify.c (pkl_typify1_ps_struct_ref): Adapt to the fact
	struct type elements can be either struct type fields or
	declarations.
	(pkl_typify1_ps_scons): Likewise.

2019-10-18  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-anal.c (pkl_anal1_ps_type_struct): Adapt to the fact
	struct type elements can be either struct type fields or
	declarations.
	(pkl_anal2_ps_type_struct): Likewise.

2019-10-18  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-ast.h: Document that struct elements can be fields or
	declarations.
	* src/pkl-tab.y: Rename the struct_type_field_list rule to
	struct_type_elem_list.
	(struct_type_elem_list): Add declarations.

2019-10-18  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-anal.c (pkl_anal1_ps_type_struct): Rename
	struct_field_type to struct_type_field.
	(pkl_anal2_ps_type_struct): Likewise.
	* src/pkl-typify.c (pkl_typify1_ps_struct): Likewise.
	(pkl_typify1_ps_struct_ref): Likewise.
	(pkl_typify1_ps_scons): Likewise.
	(pkl_typify1_ps_attr): Likewise.
	* src/pkl-tab.y: Likewise.
	* src/pkl-promo.c (pkl_promo_ps_struct_type_field): Likewise.
	* src/pkl-pass.c (pkl_do_pass_1): Likewise.
	* src/pkl-gen.pks (handle_struct_field_name): Likewise.
	(check_struct_field_constraint): Likewise.
	(struct_mapper): Likewise.
	(struct_field_mapper): Likewise.
	* src/pkl-gen.c (pkl_gen_pr_type): Likewise.
	(pkl_gen_pr_type_array): Likewise.
	(pkl_gen_pr_struct_type_field): Likewise.
	* src/pkl-ast.h (enum pkl_ast_code): Likewise.
	(PKL_AST_STRUCT_TYPE_FIELD_NAME): Likewise.
	(PKL_AST_STRUCT_TYPE_FIELD_TYPE): Likewise.
	(PKL_AST_STRUCT_TYPE_FIELD_CONSTRAINT): Likewise.
	(PKL_AST_STRUCT_TYPE_FIELD_LABEL): Likewise.
	(struct pkl_ast_struct_type_field): Likewise.
	* src/pkl-ast.c (pkl_ast_make_struct_field_type): Likewise.
	(pkl_ast_dup_type): Likewise.
	(pkl_ast_sizeof_type): Likewise.
	(pkl_print_type): Likewise.
	(pkl_ast_node_free): Likewise.
	(pkl_ast_print_1): Likewise.

2019-10-17  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-asm.c (pkl_asm_pushlevel): Use pvm_alloc instead of
	malloc.
	(pkl_asm_new): Likewise.
	(pkl_asm_poplevel): Do not free memory.
	(pkl_asm_finish): Likewise.
	* src/pvm-alloc.c (pvm_alloc_initialize): Enable garbage
	collection.

2019-10-17  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl.h: Add an additional POINTERS to pkl_compile_expression.
	* src/pkl.c (pkl_compile_expression): Likewise.
	* src/pk-cmd.c (pk_cmd_exec_1): Keep a `pointers' variable in the
	stack and pass it to pkl_compile_expression.
	* src/pvm-alloc.c (pvm_alloc_initialize): Disable garbage
	collection.

2019-10-16  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-asm.c (pkl_asm_new): fix pasm->pointers initialization.

2019-10-16  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-anal.c (pkl_anal2_ps_type_struct): adjust conditions for
	the "unreachable alternative in union" warning.

2019-10-16  Jose E. Marchesi  <jemarch@gnu.org>

	* pickles/future/bson.pk: Rewrite in modern Poke.

2019-10-16  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-gen.pks (struct_mapper): Raise E_constraint if no valid
	alternatives are found while mapping an union.
	* testsuite/poke.map/maps-unions-3.pk: Fix the test to reflect the
	above change.

2019-10-16  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pvm.jitter (pvm_literal_printer_cast): flush output buffers
	to assure the right order in the output.
	(pvm_literal_printer): Likewise.
	(pvm_literal_printer_hi): Likewise.
	(pvm_literal_printer_lo): Likewise.
	(popf_printer): Likewise.
	(bits_printer): Likewise.
	(endian_printer): Likewise.
	(nenc_printer): Likewise.

2019-10-16  Jose E. Marchesi  <jemarch@gnu.org>

	* testsuite/poke.pkl/cast-array-diag-5.pk: Fix test.

2019-10-16  Jose E. Marchesi  <jemarch@gnu.org>

	* etc/poke-ras-mode.el: New file.
	* src/pkl-gen.pks: Use poke-ras-mode.
	* src/pkl-asm.pks: Likewise.
	* HACKING (Appendix): Mention etc/poke-ras-mode.el.

2019-10-16  Jose E. Marchesi  <jemarch@gnu.org>

	* src/ras: Support .label directives.
	* src/pkl-gen.pks (struct_mapper): Use .label.

2019-10-16  Jose E. Marchesi  <jemarch@gnu.org>
	    Bruno Haible <bruno@clisp.org>

	* HACKING (Boehm GC): New section.
	(Running an Uninstalled Poke): Mention POKESTYLESDIR.
	(Continuous Integration): New section.
	(Jitter): Clarify instructions on how to install jitter.

2019-10-15  Jose E. Marchesi  <jemarch@gnu.org>

	* testsuite/lib/poke-dg.exp (dg-command): Add a comment block
	explaining what the function does.
	(dg-command): Avoid a font-lock problem in Emacs.
	(dg-data): Fix indentation.

2019-10-15  Jose E. Marchesi  <jemarch@gnu.org>

	* TODO (#A0 fix multi-line warning messages): New todo entry.
	* HACKING (Future Developments): add note about supporting
	compile-time type checking for unions with alternatives with the
	same name.

2019-10-15  Jose E. Marchesi  <jemarch@gnu.org>

	* etc/poke-default.css: Remove trailing whitespaces.
	* src/pkl.c: Likewise.
	* src/poke.c: Likewise.
	* src/pvm-val.c: Likewise.

2019-10-15  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-gen.pks (struct_mapper): Support unions in the mapping
	algorithm.
	* testsuite/poke.map/maps-unions-1.pk: New file.
	* testsuite/poke.map/maps-unions-2.pk: Likewise.
	* testsuite/poke.map/maps-unions-3.pk: Likewise.
	* testsuite/poke.map/maps-unions-4.pk: Likewise.

2019-10-15  Jose E. Marchesi  <jemarch@gnu.org>

	* testsuite/poke.pkl/union-1.pk: Test fixed.

2019-10-15  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-anal.c (pkl_anal2_ps_type_struct): Pass an AST argument
	to pkl_warning.

2019-10-15  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-anal.c (pkl_anal2_ps_type_struct): New handler.
	(pkl_phase_anal2): Register pkl_anal2_ps_type_struct.
	* testsuite/poke.pkl/union-diag-1.pk: New file.
	* testsuite/poke.pkl/union-diag-2.pk: Likewise.
	* testsuite/poke.pkl/union-diag-3.pk: Likewise.

2019-10-15  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-ast.h (struct pkl_ast_type): New field union_p for
	struct types.
	(PKL_AST_TYPE_S_UNION): Define.
	(pkl_ast_make_struct_type): Get an union_p argument.
	* src/pkl-ast.c (pkl_ast_make_struct_type): Initialize union_p.
	(pkl_ast_dup_type): Handle union_p.
	(pkl_ast_print_1): Likewise.
	* src/pkl-tab.y (struct_type_specifier): Pass union_p to
	pkl_ast_make_struct_type.
	* src/pkl-typify.c (pkl_typify1_ps_struct): Likewise.

2019-10-15  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-lex.l: Support for token union.
	* src/pkl-tab.y (UNION): New token.
	(struct_or_union): New rule.
	(struct_type_specifier): Use struct_or_union.

2019-10-15  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl.c (pkl_warning): Emit the filename containing the error.
	(pkl_error): Use <stdin> as the filename whenever necessary.
	(pkl_warning): Likewise.

2019-10-15  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl.c (pkl_detailed_location): Get an additional argument
	specifying the style class to use for terminal output.
	(pkl_error): Pass the style class to pkl_detailed_location.
	(pkl_warning): Likewise.

2019-10-15  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl.h: Make pkl_warning to get an AST argument.
	* src/pkl.c (pkl_detailed_location): New function.
	(pkl_error): Use pkl_detailed_location.
	(pkl_warning): Likewise.

2019-10-15  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pk-file.c (pk_cmd_file): Use pk_printf instead of printf.
	(pk_cmd_close): Likewise.
	(print_info_file): Likewise.
	(pk_cmd_info_files): Likewise.
	(pk_cmd_load_file): Likewise.

2019-10-15  Jose E. Marchesi  <jemarch@gnu.org>

	* HACKING (libtextstyle): New section.

2019-10-14  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pk-term.h: Prototypes for pk_term_hyperlink and
	pk_term_end_hyperlink.
	* src/pk-term.c (pk_term_hyperlink): New function.
	(pk_term_end_hyperlink): Likewise.
	* src/poke.c (pk_print_version): Use a terminal hyperlink for the
	GPLv3 webpage.

2019-10-14  Jose E. Marchesi  <jemarch@gnu.org>

	* HACKING (Terminal Handling): New chapter.
	(pk-term): New section.
	(Styling Classes): Likewise.
	(Debugging Styling): Likewise.

2019-10-14  Jose E. Marchesi  <jemarch@gnu.org>

	* configure.ac (ENABLE_DEBUG): ac_subst.
	(WITH_JITTER): Likewise.
	* Makefile.am (AM_DISTCHECK_CONFIGURE_FLAGS): Specify
	--with-jitter and --enable-debug options.
	* src/Makefile.am (poke_SOURCES): Add pkl-insn.def, pkl-ops.def
	and pkl-attrs.def.
	(BUILT_SOURCES): Add pvm-vm.h, pvm-vm1.c and pvm-vm2.c.

2019-10-10  Jose E. Marchesi  <jemarch@gnu.org>

	* etc/poke-default.css: New file.
	* src/pk-term.c: Likewise.
	* Makefile.am (SUBDIRS): Add etc/.
	* src/pvm.jitter: pk_printf is a wrapped function.
	Include pk-term.h in early-c.
	Use pk-term printing services in pretty printers and instructions.
	* src/pvm-val.h: pvm_print_string and pvm_print_val do not take a
	FILE* argument any longer.
	* src/pvm-val.c (pvm_print_binary): Likewise.
	(pvm_print_val): Likewise.
	(pvm_print_string): Likewise.
	* src/poke.c: Include pk-term.h.
	Support --color and --style long options.
	(print_help): Use print services from pk-term.
	(pk_print_version): Likewise.
	(finalize): Shutdown the pk-term subsystem.
	(repl): Likewise.
	(parse_args): Handle --color and -style.
	(initialize): Get argc and argv as arguments.
	(initialize): Initialize the pk-term subsytem.
	(main): Pass argc and argv to `initialize'.
	* src/pkl.c (pkl_new): Likewise.
	(pkl_error): Likewise.
	(pkl_warning): Likewise.
	(pkl_ice): Likewise.
	* src/pk-vm.c (pk_cmd_vm_disas_fun): Use print services from
	pk-term.
	(pk_cmd_vm_disas_map): Likewise.
	(pk_cmd_vm_disas_writ): Likewise.
	* src/pk-term.h: Include textstyle.h.
	Remove obsolete constants.
	Add prototypes for pk-term services.
	* src/pk-set.c: Include pk-term.h.
	(pk_cmd_set_obase): Use print services form pk-term.
	(pk_cmd_set_endian): Likewise.
	(pk_cmd_set_nenc): Likewise.
	* src/pk-print.c: Include pk-term.h.
	(pk_cmd_print): Use print services from pk-term.
	* src/pk-def.c: Include pk-term.h.
	(print_var_decl): Use print services from pk-term.
	(print_fun_decl): Likewise.
	* src/pk-cmd.c: Include pk-term.h.
	(pk_cmd_exec_1): Use print services from pk-term.
	(pk_cmd_exec): Likewise.
	* src/Makefile.am (poke_CPPFLAGS): Add $(top_builddir)/lib to the
	include path.
	* bootstrap.conf (gnulib_modules): Add textstyle-optional.
	* configure.ac: Use gl_LIBTEXTSTYLE_OPTIONAL.
	* src/Makefile.am (poke_LDADD): Link with libtextstyle.
	* testsuite/lib/poke-dg.exp (poke-dg-test): Pass --color=no to
	poke when running tests.
	* testsuite/lib/poke.exp (poke_start): Likewise.
	* HACKING (Appendix):List src/pk-term.c in sources.

2019-10-07  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl.c (pkl_error): Fix truncation of source code sample in
	detailed error output.

2019-10-06  Jose E. Marchesi  <jemarch@gnu.org>

	* .x-sc_trailing_blank: Add TODO.
	* HACKING: Regenerate table of contents.

2019-10-05  Jose E. Marchesi  <jemarch@gnu.org>

	* HACKING (Deciding on What to Work on): New section referring to
	TODO.
	* TODO: Reformat and complete.

2019-10-05  Jose E. Marchesi  <jemarch@gnu.org>

	* doc/poke.texi (Flattening): Add a note about compile-time
	flattening of pinned structs.

2019-10-05  Jose E. Marchesi  <jemarch@gnu.org>

	* doc/poke.texi (String Indexing): New section.
	(String Concatenation): Likewise

2019-10-05  Jose E. Marchesi  <jemarch@gnu.org>

	* src/Makefile.am (poke_CPPFLAGS): Add $(top_builddir)/lib to the
	headers search path.

2019-10-04  Jose E. Marchesi  <jemarch@gnu.org>

	* HACKING (Submitting a Patch): Add a note about running `make
	syntax-check'.

2019-10-04  Jose E. Marchesi  <jemarch@gnu.org>

	* cfg.mk (local-checks-to-skip): Remove sc_trailing_blank.
	* .x-sc_trailing_blanks: New file.
	* pickles/elf.pk: Remove trailing blanks.
	* etc/poke-gdb.scm: Likewise.
	* doc/poke.texi: Likewise.
	* testsuite/poke.std/std.exp: Likewise.
	* testsuite/poke.pkl/try-catch-2.pk: Likewise.
	* testsuite/poke.pkl/structs.pk: Likewise.
	* testsuite/poke.pkl/promo-array-arg-diag-7.pk: Likewise.
	* testsuite/poke.pkl/promo-array-arg-8.pk: Likewise.
	* testsuite/poke.pkl/pkl.exp: Likewise.
	* testsuite/poke.pkl/loop-4.pk: Likewise.
	* testsuite/poke.pkl/loop-3.pk: Likewise.
	* testsuite/poke.pkl/funcall-def-diag-7.pk: Likewise.
	* testsuite/poke.pkl/funcall-def-diag-5.pk: Likewise.
	* testsuite/poke.pkl/funcall-def-2.pk: Likewise.
	* testsuite/poke.pkl/fun-types-4.pk: Likewise.
	* testsuite/poke.pkl/fun-types-3.pk: Likewise.
	* testsuite/poke.pkl/for-in-2.pk: Likewise.
	* testsuite/poke.pkl/defun-12.pk: Likewise.
	* testsuite/poke.pkl/defun-10.pk: Likewise.
	* testsuite/poke.pkl/break-while-2.pk: Likewise.
	* testsuite/poke.pkl/break-while-1.pk: Likewise.
	* testsuite/poke.pkl/break-for-1.pk: Likewise.
	* testsuite/poke.pkl/array-siz-1.pk: Likewise.
	* testsuite/poke.map/maps-structs-constraints-1.pk: Likewise.
	* testsuite/poke.map/maps-arrays-4.pk: Likewise.
	* testsuite/poke.map/map.exp: Likewise.
	* testsuite/poke.cmd/cmd.exp: Likewise.
	* testsuite/lib/poke.exp: Likewise.
	* testsuite/lib/poke-dg.exp: Likewise.
	* src/std.pk: Likewise.
	* src/ras: Likewise.
	* src/pvm.jitter: Likewise.
	* src/pkl-insn.def: Likewise.
	* src/pkl-gen.pks: Likewise.
	* src/pkl-asm.pks: Likewise.
	* src/pk-dump.pk: Likewise.

2019-10-04  Henner Zeller  <h.zeller@acm.org>

	* src/ios-dev.h: Remove trailing spaces.
	* src/ios.c: Likewise.
	* src/ios.h: Likewise.
	* src/pk-cmd.c: Likewise.
	* src/pk-def.c: Likewise.
	* src/pk-file.c: Likewise.
	* src/pk-misc.c: Likewise.
	* src/pk-print.c: Likewise.
	* src/pk-set.c: Likewise.
	* src/pk-vm.c: Likewise.
	* src/pkl-anal.c: Likewise.
	* src/pkl-asm.c: Likewise.
	* src/pkl-asm.h: Likewise.
	* src/pkl-ast.c: Likewise.
	* src/pkl-ast.h: Likewise.
	* src/pkl-env.c: Likewise.
	* src/pkl-fold.c: Likewise.
	* src/pkl-gen.c: Likewise.
	* src/pkl-lex.l: Likewise.
	* src/pkl-parser.c: Likewise.
	* src/pkl-pass.c: Likewise.
	* src/pkl-pass.h: Likewise.
	* src/pkl-promo.c: Likewise.
	* src/pkl-tab.y: Likewise.
	* src/pkl-trans.c: Likewise.
	* src/pkl-trans.h: Likewise.
	* src/pkl-typify.c: Likewise.
	* src/pkl.c: Likewise.
	* src/poke.c: Likewise.
	* src/pvm-alloc.h: Likewise.
	* src/pvm-env.c: Likewise.
	* src/pvm-val.c: Likewise.
	* src/pvm-val.h: Likewise.

2019-10-04  Jose E. Marchesi  <jemarch@gnu.org>

	* cfg.mk (local-checks-to-skip): Add sc_tight_scope.
	* .x-sc_makefile_TAB_only_indentation: New file.
	* .x-sc_prohibit_empty_lines_at_EOF: Likewise.
	* .x-sc_makefile_path_separator_check: Likewise.
	* .x-sc_prohibit_undesirable_word_seq: Likewise.
	* .x-sc_tight_scope: Likewise.
	* testsuite/poke.pkl/rand-1.pk: Remove empty lines at EOF.
	* ChangeLog: Likewise.

2019-10-03  Henner Zeller  <h.zeller@acm.org>

	* .gitignore: ignore src/*.o files.

2019-10-03  Henner Zeller  <h.zeller@acm.org>

	* src/pk-dump.pk (pk_dump_ascii): Default to 1.
	(dump): Provide ASCII output.

2019-10-03  Henner Zeller  <h.zeller@acm.org>

	* src/pkl-trans.c: Include gettext.h and define _ for i18n.
	(pkl_trans1_ps_print_stmt): Handle %c format tags.
	Add more specific (i18n'd) error messages in format-string
	parsing.
	* src/pvm.jitter (PVM_PRINTI): Handle %c.

2019-10-03  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl.c (rest_of_compilation): Do not traverse node types in
	the lex pass.
	* src/pkl-trans.c (pkl_transl_pr_type_struct): New handler.
	* testsuite/poke.map/maps-arrays-15.pk: New test.

2019-10-03  Jose E. Marchesi  <jemarch@gnu.org>

	* HACKING (Building): Mention --skip-po to invoke bootstrap, and
	other updates.

2019-10-03  Jose E. Marchesi  <jemarch@gnu.org>

	* HACKING (Writing Poke): Add a note about using CamelCase for
	type names.

2019-10-02  Jose E. Marchesi  <jemarch@gnu.org>

	* src/std.pk (NULL): New variable.

2019-10-02  Jose E. Marchesi  <jemarch@gnu.org>

	* pickles/ctf.pk (ctf_section): Removed, as this replicates logic
	in elf_section_by_name.

2019-10-02  Jose E. Marchesi  <jemarch@gnu.org>

	* src/poke.c (print_help): Fix TRANSLATORS: commands to refer to
	poke.

2019-10-02  gettextize  <bug-gnu-gettext@gnu.org>

	* m4/lib-ld.m4: Upgrade to gettext-0.19.8.1.
	* m4/lib-link.m4: Upgrade to gettext-0.19.8.1.
	* m4/lib-prefix.m4: Upgrade to gettext-0.19.8.1.
	* configure.ac (AM_GNU_GETTEXT_VERSION): Bump to 0.19.8.

2019-10-02  Jose E. Marchesi  <jemarch@gnu.org>

	* Makefile.am (SUBDIRS): Add po/.

2019-10-02  Jose E. Marchesi  <jemarch@gnu.org>

	* pickles/elf.pk (Elf64_Addr): turn type into an offset.
	(Elf64_Rela): Adjust accordingly.

2019-10-02  Jose E. Marchesi  <jemarch@gnu.org>

	* pickles/elf.pk (elf_section_by_name): New function.
	(elf_section_by_type): Likewise.
	(SHT_DYNSYM): Define.
	(elf_string): Add comment with documentation.

2019-10-01  Jose E. Marchesi  <jemarch@gnu.org>

	* pickles/Makefile.am (dist_pkgdata_DATA): Distribute elf.pk and
	ctf.pk only.
	* pickles/future/bmp.pk: Moved from pickles/
	* pickles/future/tar.pk: Likewise.
	* pickles/future/swf.pk: Likewise.
	* pickles/future/pdp10.pk: Likewise.
	* pickles/future/mp3.pk: Likewise.
	* pickles/future/leb128.pk: Likewise.
	* pickles/future/jpeg.pk: Likewise.
	* pickles/future/id3v2.pk: Likewise.
	* pickles/future/id3v1.pk: Likewise.
	* pickles/future/gzip.pk: Likewise.
	* pickles/future/flv.pk: Likewise.
	* pickles/future/elf-future.pk: Likewise.
	* pickles/future/dwarf.pk: Likewise.
	* pickles/future/deflate.pk: Likewise.
	* pickles/future/bson.pk: Likewise.

2019-10-01  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pk-file.c (pk_cmd_load_file): Try to load the specified file
	relative to the current working directory, then look in datadir.

2019-09-30  Jose E. Marchesi  <jemarch@gnu.org>

	* HACKING: (Nomenclature): New section.

2019-09-30  Jose E. Marchesi  <jemarch@gnu.org>

	* HACKING (Writing C): New section, referring to the GNU Coding
	Standards.
	(Submitting a Patch): New section.

2019-09-11  Jose E. Marchesi  <jemarch@gnu.org>

	* HACKING (readline): New section in Development Environment,
	about the dependency libreadline.

2019-09-07  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pk-cmd.c (pk_cmd_exec_1): Avoid a buffer overrun when
	doing tilde expansion in file names.

2019-09-07  Jose E. Marchesi  <jemarch@gnu.org>

	* HACKING (Jitter): Documment a set of recommended switches to use
	when configuring jitter.

2019-09-07  Jose E. Marchesi  <jemarch@gnu.org>

	* HACKING (Adding Compiler Built-Ins): New section.

2019-09-07  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pk-cmd.c (skip_blanks): handle p == NULL.

2019-09-07  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-promo.c (pkl_promo_ps_op_unary): Initialize `restart'.
	* src/pkl-lex.l: Avoid a dead initialization.
	* src/pkl.c (pkl_error): Likewise.
	* src/pkl-typify.c (pkl_typify1_ps_funcall): Likewise.
	* src/pkl-gen.c (pkl_gen_pr_ass_stmt): Likewise.
	* src/pkl-asm.c (pkl_asm_insn): Avoid the possibility of a NULL
	deference.

2019-09-06  Jose E. Marchesi  <jemarch@gnu.org>

	* src/pkl-insn.def: New instruction RAND.
	* src/pvm.jitter (rand): New instruction.
	(wrapped-functions): Add wrapper for `random'.
	* bootstrap.conf (gnulib_modules): Add `random' gnulib module.
	* src/pkl-ast.h (PKL_AST_BUILTIN_RAND): Define.
	* src/pkl-gen.c (pkl_gen_ps_comp_stmt): Emit code for the RAND
	built-int.
	* src/pkl-lex.l: Recognize BUILTIN_RAND token.
	* src/pkl-tab.y: Define token BUILTIN_RANDR.
	(comp_stmt): New rule for builtin randr.
	* testsuite/poke.pkl/rand-1.pk: New file.

2019-09-06  Jose E. Marchesi  <jemarch@gnu.org>

	* HACKING (Jitter): Replace git:// URL with an http://, for
	jitter.
	(Development Environment): Add a note about setting POKEDATADIR to
	run an uninstalled poke.

2019-09-06  Jose E. Marchesi  <jemarch@gnu.org>

	* HACKING (Jitter): Add information on the dependency on jitter.
